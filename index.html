<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corporate Bond Portfolio Construction — Interactive Course</title>
<style>
:root {
  --bg-deep: #efebe7;
  --bg-sidebar: #e2dbda;
  --bg-card: #ffffff;
  --bg-card-alt: #f5f1ee;
  --bg-input: #f8f5f2;
  --bg-hover: #e8e2de;
  --text-primary: #1a1414;
  --text-secondary: #5a4f4a;
  --text-muted: #8a7f78;
  --accent-gold: #2b402f;
  --accent-teal: #3d5a42;
  --accent-blue: #4a6b50;
  --color-green: #2b7a3a;
  --color-red: #c4453a;
  --color-orange: #d4863a;
  --border-color: #c2b8ae;
  --border-light: #d8d0c8;
  --radius: 0.75rem;
  --radius-lg: 1rem;
  --shadow: 0 2px 12px rgba(0,0,0,0.06);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; scroll-behavior: smooth; }
body {
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  display: flex;
  min-height: 100vh;
  line-height: 1.7;
}
/* SIDEBAR */
#sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: sticky;
  top: 0;
  overflow-y: auto;
  z-index: 100;
  background-image: linear-gradient(160deg, rgba(43,64,47,0.03) 0%, transparent 40%, rgba(43,64,47,0.02) 100%);
}
.sidebar-header {
  padding: 24px 20px 16px;
  border-bottom: 1px solid var(--border-color);
}
.sidebar-logo {
  font-family: Consolas, 'Courier New', monospace;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--accent-gold);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.sidebar-subtitle {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 4px;
  letter-spacing: 0.5px;
}
/* Progress bar in sidebar */
.progress-overall {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
}
.progress-label {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}
.progress-bar-bg {
  height: 6px;
  background: var(--bg-deep);
  border-radius: 3px;
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-gold), var(--accent-teal));
  border-radius: 3px;
  width: 0%;
  transition: width 0.6s ease;
}
.progress-text {
  font-family: Consolas, monospace;
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 6px;
}
/* Nav items */
.nav-list {
  list-style: none;
  padding: 8px 0;
  flex: 1;
}
.nav-item {
  display: flex;
  align-items: center;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
  gap: 12px;
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.85rem;
  color: var(--text-secondary);
}
.nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.nav-item.active {
  background: var(--bg-hover);
  border-left-color: var(--accent-gold);
  color: var(--accent-gold);
}
.nav-item .nav-num {
  font-family: Consolas, monospace;
  font-size: 0.7rem;
  color: var(--text-muted);
  min-width: 20px;
}
.nav-item .nav-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border-light);
  flex-shrink: 0;
  transition: background 0.3s;
}
.nav-item .nav-dot.started { background: var(--accent-teal); }
.nav-item .nav-dot.passed { background: var(--color-green); }
.nav-item .nav-dot.failed { background: var(--color-red); }
.nav-divider {
  height: 1px;
  background: var(--border-color);
  margin: 8px 20px;
}
/* MAIN CONTENT */
#main {
  flex: 1;
  min-width: 0;
  padding: 0;
  background-image:
    radial-gradient(circle at 20% 80%, rgba(43,64,47,0.02) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(43,64,47,0.015) 0%, transparent 50%);
}
.section-view {
  display: none;
  max-width: 960px;
  margin: 0 auto;
  padding: 40px 48px 80px;
  animation: fadeIn 0.3s ease;
}
.section-view.active { display: block; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Section header */
.section-header {
  margin-bottom: 32px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border-color);
}
.section-number {
  font-family: Consolas, monospace;
  font-size: 0.75rem;
  color: var(--accent-teal);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 8px;
}
.section-title {
  font-family: Consolas, 'Courier New', monospace;
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
  margin-bottom: 8px;
}
.section-topics {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.topic-tag {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.7rem;
  padding: 3px 10px;
  border-radius: 20px;
  background: var(--bg-card-alt);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
/* Tabs */
.tab-bar {
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 28px;
}
.tab-btn {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  padding: 12px 24px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}
.tab-btn:hover { color: var(--text-secondary); }
.tab-btn.active {
  color: var(--accent-gold);
  border-bottom-color: var(--accent-gold);
}
.tab-panel { display: none; }
.tab-panel.active { display: block; animation: fadeIn 0.25s ease; }
/* Lesson content */
.lesson h3 {
  font-family: Consolas, monospace;
  font-size: 1.2rem;
  color: var(--accent-gold);
  margin: 28px 0 12px;
  font-weight: 700;
}
.lesson h3:first-child { margin-top: 0; }
.lesson p { margin-bottom: 14px; color: var(--text-primary); }
.lesson ul, .lesson ol {
  margin: 0 0 14px 24px;
  color: var(--text-primary);
}
.lesson li { margin-bottom: 6px; }
.lesson strong { color: var(--accent-gold); font-weight: 700; }
.lesson em { color: var(--accent-teal); font-style: normal; }
/* Formula blocks */
.formula {
  background: var(--bg-card-alt);
  border: 1px solid var(--border-color);
  border-left: 3px solid var(--accent-teal);
  padding: 16px 20px;
  margin: 16px 0;
  font-family: Consolas, 'Courier New', monospace;
  font-size: 0.95rem;
  color: var(--text-primary);
  border-radius: 0 var(--radius) var(--radius) 0;
  overflow-x: auto;
  line-height: 2;
}
.formula .frac {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  vertical-align: middle;
  margin: 0 2px;
}
.formula .frac-num {
  border-bottom: 1px solid var(--text-secondary);
  padding: 0 4px 2px;
  font-size: 0.85em;
}
.formula .frac-den {
  padding: 2px 4px 0;
  font-size: 0.85em;
}
/* Callout boxes */
.callout {
  background: var(--bg-card-alt);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin: 16px 0;
}
.callout-title {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}
.callout.insight .callout-title { color: var(--accent-teal); }
.callout.warning .callout-title { color: var(--color-orange); }
.callout.definition .callout-title { color: var(--accent-blue); }
.callout p { margin-bottom: 8px; font-size: 0.92rem; }
.callout p:last-child { margin-bottom: 0; }
/* Tables */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.88rem;
}
.data-table th {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-weight: 600;
  text-align: left;
  padding: 10px 14px;
  background: var(--bg-card-alt);
  color: var(--text-secondary);
  border-bottom: 2px solid var(--border-color);
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.data-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-color);
  font-family: Consolas, monospace;
  font-size: 0.85rem;
}
.data-table tr:hover td { background: var(--bg-hover); }
/* Worked example */
.example-block {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin: 16px 0;
}
.example-header {
  background: var(--bg-card-alt);
  padding: 14px 20px;
  font-family: Consolas, monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--accent-gold);
  border-bottom: 1px solid var(--border-color);
}
.example-body { padding: 20px; }
.example-section {
  margin-bottom: 16px;
}
.example-section:last-child { margin-bottom: 0; }
.example-section-title {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 8px;
}
.example-section p, .example-section li {
  font-size: 0.9rem;
}
.steps-toggle {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.8rem;
  color: var(--accent-teal);
  cursor: pointer;
  background: none;
  border: 1px solid var(--accent-teal);
  padding: 6px 14px;
  border-radius: 20px;
  margin: 8px 0;
  transition: all 0.2s;
}
.steps-toggle:hover { background: rgba(43,64,47,0.08); }
.steps-content {
  display: none;
  margin-top: 12px;
  padding: 16px;
  background: var(--bg-input);
  border-radius: var(--radius);
  font-family: Consolas, monospace;
  font-size: 0.85rem;
  line-height: 1.9;
}
.steps-content.open { display: block; }
.result-box {
  background: rgba(43,122,58,0.08);
  border: 1px solid rgba(43,122,58,0.2);
  border-radius: var(--radius);
  padding: 14px 18px;
  margin-top: 12px;
}
.result-box .result-label {
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--color-green);
  margin-bottom: 4px;
}
.result-box .result-value {
  font-family: Consolas, monospace;
  font-size: 1.1rem;
  color: var(--text-primary);
}
.interpretation {
  background: rgba(43,64,47,0.05);
  border-left: 3px solid var(--accent-gold);
  padding: 12px 16px;
  margin-top: 12px;
  font-size: 0.88rem;
  color: var(--text-secondary);
}
/* Calculator */
.calc-container {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  overflow: hidden;
}
.calc-header {
  background: var(--bg-card-alt);
  padding: 14px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border-color);
}
.calc-title {
  font-family: Consolas, monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--accent-teal);
}
.calc-body {
  padding: 20px;
}
.calc-fields {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}
.calc-field label {
  display: block;
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.calc-field input, .calc-field select {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: Consolas, monospace;
  font-size: 0.9rem;
  transition: border-color 0.2s;
}
.calc-field input:focus, .calc-field select:focus {
  outline: none;
  border-color: var(--accent-teal);
}
.calc-field input[type=range] {
  padding: 0;
  margin-top: 4px;
  accent-color: var(--accent-teal);
}
.calc-field .range-val {
  font-family: Consolas, monospace;
  font-size: 0.8rem;
  color: var(--accent-teal);
  float: right;
}
.calc-actions {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.btn {
  font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
  font-size: 0.82rem;
  font-weight: 500;
  padding: 10px 20px;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-primary {
  background: var(--accent-gold);
  color: #fff;
}
.btn-primary:hover { opacity: 0.9; }
.btn-secondary {
  background: var(--bg-card);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}
.btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
.btn-gold {
  background: var(--accent-teal);
  color: #fff;
}
.btn-gold:hover { opacity: 0.9; }
.btn-danger {
  background: transparent;
  color: var(--color-red);
  border: 1px solid var(--color-red);
  font-size: 0.72rem;
  padding: 7px 14px;
}
.btn-danger:hover { background: var(--color-red); color: #fff; }
.sidebar-footer {
  padding: 12px 20px 16px;
  border-top: 1px solid var(--border-color);
}
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal-box {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 28px 32px;
  max-width: 380px;
  width: 90%;
  text-align: center;
}
.modal-box h3 {
  font-family: 'Segoe UI', system-ui, sans-serif;
  font-size: 1rem;
  margin-bottom: 8px;
}
.modal-box p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 20px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}
.modal-actions .btn { min-width: 100px; }
.btn-danger-solid {
  background: var(--color-red);
  color: #fff;
  padding: 10px 20px;
}
.btn-danger-solid:hover { filter: brightness(1.15); }
.calc-results {
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  min-height: 60px;
}
.calc-results h4 {
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 12px;
}
.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}
.result-item {
  padding: 10px;
  background: var(--bg-card);
  border-radius: var(--radius);
  border: 1px solid var(--border-color);
}
.result-item .ri-label {
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.result-item .ri-value {
  font-family: Consolas, monospace;
  font-size: 1.15rem;
  color: var(--accent-gold);
  margin-top: 4px;
}
.result-item .ri-unit {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-left: 4px;
}
/* Charts */
.chart-container {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin: 16px 0;
}
.chart-title {
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
}
svg.chart { width: 100%; height: auto; }
svg.chart text {
  font-family: Consolas, monospace;
  font-size: 11px;
  fill: var(--text-secondary);
}
svg.chart .axis line, svg.chart .axis path {
  stroke: var(--border-color);
  stroke-width: 1;
}
svg.chart .grid line {
  stroke: var(--border-color);
  stroke-width: 0.5;
  stroke-dasharray: 3,3;
}
/* Quiz */
.quiz-container { margin-top: 8px; }
.quiz-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.quiz-score {
  font-family: Consolas, monospace;
  font-size: 0.9rem;
  color: var(--text-secondary);
}
.quiz-score .score-val { color: var(--accent-gold); font-size: 1.1rem; }
.quiz-question {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}
.qq-num {
  font-family: Consolas, monospace;
  font-size: 0.75rem;
  color: var(--accent-teal);
  margin-bottom: 8px;
}
.qq-text {
  font-size: 0.95rem;
  margin-bottom: 14px;
  line-height: 1.6;
}
.qq-options { list-style: none; }
.qq-option {
  display: block;
  padding: 10px 16px;
  margin-bottom: 8px;
  background: var(--bg-card-alt);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}
.qq-option:hover:not(.disabled) {
  border-color: var(--accent-teal);
  background: var(--bg-hover);
}
.qq-option.selected { border-color: var(--accent-teal); background: rgba(43,64,47,0.08); }
.qq-option.correct {
  border-color: var(--color-green);
  background: rgba(43,122,58,0.1);
  color: var(--color-green);
}
.qq-option.incorrect {
  border-color: var(--color-red);
  background: rgba(230,57,70,0.08);
}
.qq-option.disabled { cursor: default; opacity: 0.7; }
.qq-option.disabled.was-correct {
  opacity: 1;
  border-color: var(--color-green);
  background: rgba(43,122,58,0.1);
}
.qq-explanation {
  margin-top: 10px;
  padding: 12px 16px;
  background: rgba(59,130,246,0.06);
  border-left: 3px solid var(--accent-blue);
  border-radius: 0 var(--radius) var(--radius) 0;
  font-size: 0.85rem;
  color: var(--text-secondary);
  display: none;
}
.qq-explanation.show { display: block; }
/* Capstone */
.capstone-phase {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 24px;
  margin-bottom: 24px;
}
.capstone-phase h3 {
  font-family: Consolas, monospace;
  color: var(--accent-gold);
  margin-bottom: 16px;
}
/* Tools panel */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}
.tool-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
}
.tool-card:hover {
  border-color: var(--accent-teal);
  transform: translateY(-2px);
}
.tool-card h4 {
  font-family: Consolas, monospace;
  font-size: 0.9rem;
  color: var(--accent-teal);
  margin-bottom: 6px;
}
.tool-card p {
  font-size: 0.82rem;
  color: var(--text-secondary);
}
/* Mobile sidebar toggle */
.sidebar-toggle {
  display: none;
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 200;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 8px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 1.2rem;
}
@media (max-width: 768px) {
  .sidebar-toggle { display: block; }
  #sidebar {
    position: fixed;
    left: -300px;
    transition: left 0.3s ease;
    height: 100vh;
  }
  #sidebar.open { left: 0; }
  .section-view { padding: 40px 20px 80px; }
}
/* Dashboard widget */
.dashboard-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin: 16px 0;
}
.dash-widget {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 14px;
  text-align: center;
}
.dash-widget .dw-label {
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.68rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.dash-widget .dw-value {
  font-family: Consolas, monospace;
  font-size: 1.4rem;
  color: var(--accent-gold);
  margin-top: 4px;
}
.dash-widget .dw-unit {
  font-size: 0.7rem;
  color: var(--text-muted);
}
/* Misc */
.collapsible-header {
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 0;
  font-family: 'Segoe UI', sans-serif;
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 0.88rem;
}
.collapsible-header::before {
  content: '\25B6';
  font-size: 0.65rem;
  transition: transform 0.2s;
  color: var(--accent-teal);
}
.collapsible-header.open::before { transform: rotate(90deg); }
.collapsible-body {
  display: none;
  padding: 8px 0 8px 20px;
}
.collapsible-body.open { display: block; }
.text-green { color: var(--color-green); }
.text-red { color: var(--color-red); }
.text-gold { color: var(--accent-gold); }
.text-teal { color: var(--accent-teal); }
.text-muted { color: var(--text-muted); }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')" aria-label="Toggle navigation">&#9776;</button>
<nav id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">Corp Bonds</div>
    <div class="sidebar-subtitle">Portfolio Construction Course</div>
  </div>
  <div class="progress-overall">
    <div class="progress-label">Overall Progress</div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
    <div class="progress-text" id="progressText">0 / 11 completed</div>
  </div>
  <ul class="nav-list" id="navList"></ul>
  <div class="sidebar-footer">
    <button class="btn btn-danger" onclick="resetProgress()">Reset All Progress</button>
  </div>
</nav>
<main id="main">
  <div id="sectionContainer"></div>
</main>
<script>
"use strict";
/* ============================================================
   CONSTANTS & MARKET DATA
   ============================================================ */
const RISK_FREE_RATE = 0.045;
const TREASURY_SPOTS = [
  {t:0.5,r:0.0440},{t:1,r:0.0445},{t:2,r:0.0430},{t:3,r:0.0420},{t:5,r:0.0415},
  {t:7,r:0.0420},{t:10,r:0.0430},{t:15,r:0.0445},{t:20,r:0.0455},{t:30,r:0.0460}
];
const SWAP_SPOTS = [
  {t:0.5,r:0.0455},{t:1,r:0.0460},{t:2,r:0.0450},{t:3,r:0.0442},{t:5,r:0.0438},
  {t:7,r:0.0445},{t:10,r:0.0458},{t:15,r:0.0470},{t:20,r:0.0478},{t:30,r:0.0485}
];
const BENCHMARK = {
  name:'Bloomberg US Corp Bond Index (proxy)',
  duration:7.1, spread:120, ytm:5.50, rating:'A/BBB',
  annualReturn:0.052, annualVol:0.065
};

/* ============================================================
   BOND MATH UTILITIES
   ============================================================ */
const BondMath = {
  priceFromYTM(coupon, maturity, face, ytm, freq=2) {
    const c = (coupon/100)*face/freq;
    const y = ytm/(100*freq);
    const n = Math.round(maturity*freq);
    let pv = 0;
    for(let t=1;t<=n;t++) pv += c/Math.pow(1+y,t);
    pv += face/Math.pow(1+y,n);
    return pv;
  },
  ytmFromPrice(coupon, maturity, face, price, freq=2) {
    let lo=0, hi=50, mid;
    for(let i=0;i<200;i++){
      mid=(lo+hi)/2;
      const p=this.priceFromYTM(coupon,maturity,face,mid,freq);
      if(p<price) hi=mid; else lo=mid;
      if(Math.abs(p-price)<0.00001) break;
    }
    return mid;
  },
  accruedInterest(couponRate, face, daysSinceLast, daysPeriod) {
    return (couponRate/100)*face/2 * (daysSinceLast/daysPeriod);
  },
  dirtyPrice(cleanPrice, accruedInt) { return cleanPrice + accruedInt; },
  modifiedDuration(coupon, maturity, face, ytm, freq=2) {
    const c=(coupon/100)*face/freq, y=ytm/(100*freq), n=Math.round(maturity*freq);
    let num=0, den=0;
    for(let t=1;t<=n;t++){
      const pv=c/Math.pow(1+y,t);
      num+=t*pv; den+=pv;
    }
    const pvf=face/Math.pow(1+y,n);
    num+=n*pvf; den+=pvf;
    const macD = (num/den)/freq;
    return macD/(1+y);
  },
  macaulayDuration(coupon, maturity, face, ytm, freq=2) {
    const c=(coupon/100)*face/freq, y=ytm/(100*freq), n=Math.round(maturity*freq);
    let num=0, den=0;
    for(let t=1;t<=n;t++){
      const pv=c/Math.pow(1+y,t);
      num+=(t/freq)*pv; den+=pv;
    }
    const pvf=face/Math.pow(1+y,n);
    num+=(n/freq)*pvf; den+=pvf;
    return num/den;
  },
  convexity(coupon, maturity, face, ytm, freq=2) {
    const c=(coupon/100)*face/freq, y=ytm/(100*freq), n=Math.round(maturity*freq);
    let num=0, den=0;
    for(let t=1;t<=n;t++){
      const pv=c/Math.pow(1+y,t);
      num+=t*(t+1)*pv; den+=pv;
    }
    const pvf=face/Math.pow(1+y,n);
    num+=n*(n+1)*pvf; den+=pvf;
    return num/(den*freq*freq*Math.pow(1+y,2));
  },
  spreadDuration(coupon, maturity, face, ytm, freq=2) {
    const bp=0.0001;
    const p0=this.priceFromYTM(coupon,maturity,face,ytm,freq);
    const p1=this.priceFromYTM(coupon,maturity,face,ytm+bp*100,freq);
    return -(p1-p0)/(p0*bp);
  },
  dv01(coupon, maturity, face, ytm, freq=2) {
    const p0=this.priceFromYTM(coupon,maturity,face,ytm,freq);
    const p1=this.priceFromYTM(coupon,maturity,face,ytm+0.01,freq);
    return Math.abs(p1-p0);
  },
  interpolateRate(curve, t) {
    if(t<=curve[0].t) return curve[0].r;
    if(t>=curve[curve.length-1].t) return curve[curve.length-1].r;
    for(let i=0;i<curve.length-1;i++){
      if(t>=curve[i].t && t<=curve[i+1].t){
        const frac=(t-curve[i].t)/(curve[i+1].t-curve[i].t);
        return curve[i].r+frac*(curve[i+1].r-curve[i].r);
      }
    }
    return curve[curve.length-1].r;
  },
  priceFromSpotCurve(coupon, maturity, face, curve, spread, freq=2) {
    const c=(coupon/100)*face/freq;
    const n=Math.round(maturity*freq);
    let pv=0;
    for(let t=1;t<=n;t++){
      const T=t/freq;
      const r=this.interpolateRate(curve,T)+spread;
      pv+=c/Math.pow(1+r/freq,t);
    }
    const T=n/freq;
    const r=this.interpolateRate(curve,T)+spread;
    pv+=face/Math.pow(1+r/freq,n);
    return pv;
  },
  gSpread(bondYTM, maturity) {
    const tRate = this.interpolateRate(TREASURY_SPOTS, maturity);
    return (bondYTM/100 - tRate)*10000;
  },
  iSpread(bondYTM, maturity) {
    const sRate = this.interpolateRate(SWAP_SPOTS, maturity);
    return (bondYTM/100 - sRate)*10000;
  },
  zSpread(coupon, maturity, face, price, freq=2) {
    let lo=-0.05, hi=0.10, mid;
    for(let i=0;i<200;i++){
      mid=(lo+hi)/2;
      const p=this.priceFromSpotCurve(coupon,maturity,face,TREASURY_SPOTS,mid,freq);
      if(p>price) lo=mid; else hi=mid;
      if(Math.abs(p-price)<0.0001) break;
    }
    return mid*10000;
  },
  oasApprox(coupon, maturity, face, price, freq=2, volatility=0.15) {
    const zs = this.zSpread(coupon,maturity,face,price,freq);
    const optionCost = volatility * 8;
    return zs - optionCost;
  },
  hazardToPD(hazardRate, maturity) {
    return 1 - Math.exp(-hazardRate * maturity);
  },
  survivalProb(hazardRate, t) {
    return Math.exp(-hazardRate * t);
  },
  expectedLoss(hazardRate, maturity, lgd) {
    const pd = this.hazardToPD(hazardRate, maturity);
    return pd * lgd;
  },
  creditSpreadFromHazard(hazardRate, recovery) {
    return hazardRate * (1 - recovery) * 10000;
  },
  keyRateDurations(coupon, maturity, face, ytm, freq=2) {
    const buckets=[1,2,3,5,7,10,15,20,30];
    const p0=this.priceFromYTM(coupon,maturity,face,ytm,freq);
    const results=[];
    const bp=1;
    for(const b of buckets){
      const shiftedCurve=TREASURY_SPOTS.map(pt=>({t:pt.t,r:pt.r+(pt.t===b?bp/10000:0)}));
      const bondSpread=ytm/100-this.interpolateRate(TREASURY_SPOTS,maturity);
      const pUp=this.priceFromSpotCurve(coupon,maturity,face,shiftedCurve,bondSpread,freq);
      const shiftedDown=TREASURY_SPOTS.map(pt=>({t:pt.t,r:pt.r-(pt.t===b?bp/10000:0)}));
      const pDn=this.priceFromSpotCurve(coupon,maturity,face,shiftedDown,bondSpread,freq);
      results.push({bucket:b, krd:-(pUp-pDn)/(2*p0*bp/10000)});
    }
    return results;
  },
  portfolioMetrics(bonds, weights) {
    let dur=0,convex=0,spread=0,ytm_=0;
    for(let i=0;i<bonds.length;i++){
      const b=bonds[i],w=weights[i];
      const d=this.modifiedDuration(b.coupon,b.maturity,100,b.ytm);
      const c=this.convexity(b.coupon,b.maturity,100,b.ytm);
      dur+=w*d; convex+=w*c; spread+=w*b.spread; ytm_+=w*b.ytm;
    }
    return {duration:dur,convexity:convex,spread:spread,ytm:ytm_};
  },
  carry(coupon, ytm, fundingRate, maturity) {
    return (coupon - fundingRate) / 100;
  },
  rollDown(coupon, maturity, face, ytm, horizon, freq=2) {
    const p0=this.priceFromYTM(coupon,maturity,face,ytm,freq);
    const newMat=maturity-horizon;
    if(newMat<=0) return 0;
    const newYTM=ytm-((ytm-RISK_FREE_RATE*100)/maturity)*horizon;
    const p1=this.priceFromYTM(coupon,newMat,face,newYTM,freq);
    return (p1-p0)/p0;
  },
  excessReturn(totalReturn, durationContrib, riskFreeReturn) {
    return totalReturn - riskFreeReturn;
  },
  parametricVaR(mean, vol, confidence, horizon) {
    const zScores={0.90:1.282,0.95:1.645,0.99:2.326};
    const z=zScores[confidence]||1.645;
    return -(mean*horizon - z*vol*Math.sqrt(horizon));
  },
  parametricES(mean, vol, confidence, horizon) {
    const zScores={0.90:1.755,0.95:2.063,0.99:2.665};
    const z=zScores[confidence]||2.063;
    return -(mean*horizon - z*vol*Math.sqrt(horizon));
  },
  maxDrawdown(returnSeries) {
    let peak=-Infinity, mdd=0, cumReturn=0;
    for(const r of returnSeries){
      cumReturn+=r;
      if(cumReturn>peak) peak=cumReturn;
      const dd=peak-cumReturn;
      if(dd>mdd) mdd=dd;
    }
    return mdd;
  },
  trackingError(portfolioReturns, benchmarkReturns) {
    const diffs=portfolioReturns.map((r,i)=>r-benchmarkReturns[i]);
    const mean=diffs.reduce((s,v)=>s+v,0)/diffs.length;
    const variance=diffs.reduce((s,v)=>s+(v-mean)**2,0)/(diffs.length-1);
    return Math.sqrt(variance)*Math.sqrt(12);
  },
  informationRatio(portfolioReturns, benchmarkReturns) {
    const diffs=portfolioReturns.map((r,i)=>r-benchmarkReturns[i]);
    const mean=diffs.reduce((s,v)=>s+v,0)/diffs.length;
    const te=this.trackingError(portfolioReturns,benchmarkReturns);
    return (mean*12)/te;
  },
  sharpeRatio(annualReturn, annualVol, riskFreeRate) {
    return (annualReturn-riskFreeRate)/annualVol;
  }
};

/* ============================================================
   SVG CHART UTILITIES
   ============================================================ */
const Chart = {
  svgNS: 'http://www.w3.org/2000/svg',
  create(width, height, padding) {
    const svg = document.createElementNS(this.svgNS,'svg');
    svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
    svg.setAttribute('class','chart');
    svg.style.overflow='visible';
    return {svg, w:width, h:height, p:padding||{top:30,right:30,bottom:40,left:55},
      get iw(){return this.w-this.p.left-this.p.right;},
      get ih(){return this.h-this.p.top-this.p.bottom;}
    };
  },
  el(tag,attrs){
    const e=document.createElementNS(this.svgNS,tag);
    for(const[k,v]of Object.entries(attrs||{})) e.setAttribute(k,v);
    return e;
  },
  drawAxes(ctx, xTicks, yTicks, xLabel, yLabel) {
    const g=this.el('g',{class:'axis'});
    g.appendChild(this.el('line',{x1:ctx.p.left,y1:ctx.p.top,x2:ctx.p.left,y2:ctx.h-ctx.p.bottom,stroke:'#c2b8ae'}));
    g.appendChild(this.el('line',{x1:ctx.p.left,y1:ctx.h-ctx.p.bottom,x2:ctx.w-ctx.p.right,y2:ctx.h-ctx.p.bottom,stroke:'#c2b8ae'}));
    if(xTicks) xTicks.forEach(t=>{
      const x=ctx.p.left+t.pos*ctx.iw;
      const txt=this.el('text',{x:x,y:ctx.h-ctx.p.bottom+16,fill:'#5a4f4a','text-anchor':'middle','font-size':'10'});
      txt.textContent=t.label;
      g.appendChild(txt);
    });
    if(yTicks) yTicks.forEach(t=>{
      const y=ctx.h-ctx.p.bottom-t.pos*ctx.ih;
      const txt=this.el('text',{x:ctx.p.left-8,y:y+3,fill:'#5a4f4a','text-anchor':'end','font-size':'10'});
      txt.textContent=t.label;
      g.appendChild(txt);
      g.appendChild(this.el('line',{x1:ctx.p.left,y1:y,x2:ctx.w-ctx.p.right,y2:y,stroke:'#c2b8ae','stroke-dasharray':'3,3','stroke-width':'0.5'}));
    });
    if(xLabel){const t=this.el('text',{x:ctx.p.left+ctx.iw/2,y:ctx.h-2,fill:'#8a7f78','text-anchor':'middle','font-size':'11'});t.textContent=xLabel;g.appendChild(t);}
    if(yLabel){const t=this.el('text',{x:12,y:ctx.p.top+ctx.ih/2,fill:'#8a7f78','text-anchor':'middle','font-size':'11',transform:`rotate(-90,12,${ctx.p.top+ctx.ih/2})`});t.textContent=yLabel;g.appendChild(t);}
    ctx.svg.appendChild(g);
  },
  linePlot(ctx, data, color, strokeWidth) {
    if(!data.length)return;
    const pts=data.map(d=>`${ctx.p.left+d.x*ctx.iw},${ctx.h-ctx.p.bottom-d.y*ctx.ih}`).join(' ');
    const pl=this.el('polyline',{points:pts,fill:'none',stroke:color||'#2b402f','stroke-width':strokeWidth||2,'stroke-linejoin':'round'});
    ctx.svg.appendChild(pl);
  },
  areaPlot(ctx, data, color) {
    if(!data.length)return;
    const pts=data.map(d=>`${ctx.p.left+d.x*ctx.iw},${ctx.h-ctx.p.bottom-d.y*ctx.ih}`);
    const pathD=`M${ctx.p.left+data[0].x*ctx.iw},${ctx.h-ctx.p.bottom} L${pts.join(' L')} L${ctx.p.left+data[data.length-1].x*ctx.iw},${ctx.h-ctx.p.bottom} Z`;
    const p=this.el('path',{d:pathD,fill:color||'rgba(218,119,86,0.15)',stroke:'none'});
    ctx.svg.appendChild(p);
  },
  barChart(ctx, bars, color) {
    const barW = ctx.iw/(bars.length*1.5);
    bars.forEach((b,i)=>{
      const x=ctx.p.left+(i+0.25)*ctx.iw/bars.length;
      const h=b.value*ctx.ih;
      const y=ctx.h-ctx.p.bottom-h;
      const c=b.color||color||'#2b402f';
      ctx.svg.appendChild(this.el('rect',{x:x,y:h>=0?y:ctx.h-ctx.p.bottom,width:barW,height:Math.abs(h),fill:c,rx:'3'}));
      const txt=this.el('text',{x:x+barW/2,y:ctx.h-ctx.p.bottom+14,fill:'#5a4f4a','text-anchor':'middle','font-size':'9'});
      txt.textContent=b.label;
      ctx.svg.appendChild(txt);
    });
  },
  waterfallChart(ctx, items) {
    const barW=ctx.iw/(items.length*1.5);
    let cumY=0;
    items.forEach((item,i)=>{
      const x=ctx.p.left+(i+0.25)*ctx.iw/items.length;
      const h=item.value*ctx.ih;
      const startY=ctx.h-ctx.p.bottom-cumY*ctx.ih;
      const color=item.value>=0?'#2b7a3a':'#c4453a';
      const rect=this.el('rect',{x:x,y:h>=0?startY-h:startY,width:barW,height:Math.abs(h),fill:item.color||color,rx:'2'});
      ctx.svg.appendChild(rect);
      cumY+=item.value;
      const txt=this.el('text',{x:x+barW/2,y:ctx.h-ctx.p.bottom+14,fill:'#5a4f4a','text-anchor':'middle','font-size':'8'});
      txt.textContent=item.label;
      ctx.svg.appendChild(txt);
      const vtxt=this.el('text',{x:x+barW/2,y:(h>=0?startY-h:startY)-5,fill:'#1a1414','text-anchor':'middle','font-size':'9'});
      vtxt.textContent=item.displayValue||'';
      ctx.svg.appendChild(vtxt);
    });
  },
  donutChart(ctx, slices, cx, cy, outerR, innerR) {
    let startAngle=-Math.PI/2;
    const total=slices.reduce((s,sl)=>s+sl.value,0);
    slices.forEach(sl=>{
      const angle=(sl.value/total)*2*Math.PI;
      const endAngle=startAngle+angle;
      const x1=cx+outerR*Math.cos(startAngle),y1=cy+outerR*Math.sin(startAngle);
      const x2=cx+outerR*Math.cos(endAngle),y2=cy+outerR*Math.sin(endAngle);
      const x3=cx+innerR*Math.cos(endAngle),y3=cy+innerR*Math.sin(endAngle);
      const x4=cx+innerR*Math.cos(startAngle),y4=cy+innerR*Math.sin(startAngle);
      const large=angle>Math.PI?1:0;
      const d=`M${x1},${y1} A${outerR},${outerR} 0 ${large} 1 ${x2},${y2} L${x3},${y3} A${innerR},${innerR} 0 ${large} 0 ${x4},${y4} Z`;
      ctx.svg.appendChild(this.el('path',{d:d,fill:sl.color}));
      const midAngle=startAngle+angle/2;
      const lx=cx+(outerR+16)*Math.cos(midAngle),ly=cy+(outerR+16)*Math.sin(midAngle);
      if(sl.value/total>0.05){
        const t=this.el('text',{x:lx,y:ly+3,fill:'#1a1414','text-anchor':'middle','font-size':'9'});
        t.textContent=sl.label;
        ctx.svg.appendChild(t);
      }
      startAngle=endAngle;
    });
  },
  histogram(ctx, bins, color) {
    const maxVal=Math.max(...bins.map(b=>b.count));
    const barW=ctx.iw/bins.length;
    bins.forEach((b,i)=>{
      const x=ctx.p.left+i*barW;
      const h=(b.count/maxVal)*ctx.ih;
      ctx.svg.appendChild(this.el('rect',{x:x+1,y:ctx.h-ctx.p.bottom-h,width:barW-2,height:h,fill:color||'#2b402f',opacity:'0.7',rx:'1'}));
    });
  },
  addMarker(ctx, xPos, label, color) {
    const x=ctx.p.left+xPos*ctx.iw;
    ctx.svg.appendChild(this.el('line',{x1:x,y1:ctx.p.top,x2:x,y2:ctx.h-ctx.p.bottom,stroke:color||'#c4453a','stroke-width':'2','stroke-dasharray':'5,4'}));
    const t=this.el('text',{x:x,y:ctx.p.top-5,fill:color||'#c4453a','text-anchor':'middle','font-size':'10','font-weight':'bold'});
    t.textContent=label;
    ctx.svg.appendChild(t);
  },
  stackedBar(ctx, categories, series) {
    const barW=ctx.iw/(categories.length*1.5);
    categories.forEach((cat,i)=>{
      const x=ctx.p.left+(i+0.25)*ctx.iw/categories.length;
      let cumH=0;
      series.forEach(s=>{
        const h=s.values[i]*ctx.ih;
        const y=ctx.h-ctx.p.bottom-cumH-h;
        ctx.svg.appendChild(this.el('rect',{x:x,y:y,width:barW,height:h,fill:s.color,rx:'1'}));
        cumH+=h;
      });
      const txt=this.el('text',{x:x+barW/2,y:ctx.h-ctx.p.bottom+14,fill:'#5a4f4a','text-anchor':'middle','font-size':'9'});
      txt.textContent=cat;
      ctx.svg.appendChild(txt);
    });
  },
  legend(ctx, items, x, y) {
    items.forEach((item,i)=>{
      ctx.svg.appendChild(this.el('rect',{x:x,y:y+i*18,width:12,height:12,fill:item.color,rx:'2'}));
      const t=this.el('text',{x:x+18,y:y+i*18+10,fill:'#5a4f4a','font-size':'10'});
      t.textContent=item.label;
      ctx.svg.appendChild(t);
    });
  }
};

const SECTIONS = [
  {
    id: 'section-1',
    number: 1,
    title: 'Corporate Bond Fundamentals Refresher',
    subtopics: ['Pricing mechanics', 'YTM vs spot rates', 'Clean vs dirty price'],
    lesson: `
      <h3>Bond Pricing: Present Value of Cash Flows</h3>
      <p>The price of a fixed-rate corporate bond is the present value of all future cash flows — coupon payments and the return of principal at maturity. For a bond paying semiannual coupons:</p>
      <div class="formula">
        P = &Sigma;<sub>t=1</sub><sup>2T</sup> &nbsp; C/2 &divide; (1 + y/2)<sup>t</sup> &nbsp;+&nbsp; F &divide; (1 + y/2)<sup>2T</sup>
      </div>
      <p>Where <strong>C</strong> is the annual coupon payment, <strong>y</strong> is the yield to maturity (YTM), <strong>F</strong> is face value, and <strong>T</strong> is years to maturity. Each semiannual period discounts at half the annual YTM.</p>

      <h3>Yield to Maturity (YTM) as Internal Rate of Return</h3>
      <p>YTM is the single discount rate that equates the bond's market price with its present value of cash flows. It assumes all coupons are reinvested at the YTM itself — a simplifying assumption that rarely holds in practice. YTM is quoted as a bond-equivalent yield (BEY), meaning it is double the semiannual rate:</p>
      <div class="formula">
        YTM<sub>BEY</sub> = 2 &times; y<sub>semi</sub>
      </div>
      <p>Unlike the YTM, <strong>spot rate pricing</strong> uses a unique zero-coupon rate for each cash flow date, bootstrapped from the Treasury curve. This eliminates the reinvestment assumption:</p>
      <div class="formula">
        P = &Sigma;<sub>t=1</sub><sup>2T</sup> &nbsp; C/2 &divide; (1 + s<sub>t</sub>/2)<sup>t</sup> &nbsp;+&nbsp; F &divide; (1 + s<sub>2T</sub>/2)<sup>2T</sup>
      </div>
      <p>where s<sub>t</sub> is the annualized spot rate for period t. Spot rate pricing is theoretically more rigorous because it does not blend the term structure into a single number.</p>

      <h3>Clean Price vs. Dirty Price</h3>
      <p>Bonds trade on a <strong>clean price</strong> (flat price) basis, but the buyer pays the <strong>dirty price</strong> (full/invoice price), which includes accrued interest owed to the seller:</p>
      <div class="formula">
        Dirty Price = Clean Price + Accrued Interest
      </div>
      <p>Accrued interest compensates the seller for holding the bond since the last coupon date. Under the <strong>30/360 day-count convention</strong> (standard for US corporate bonds):</p>
      <div class="formula">
        AI = (C / 2) &times; (Days Since Last Coupon / Days in Coupon Period)
      </div>
      <p>The 30/360 convention assumes each month has 30 days and each year has 360 days, simplifying the day count. When pricing from YTM, the formula naturally produces a dirty price; you subtract accrued interest to obtain the clean price for quotation.</p>

      <div class="callout definition">
        <div class="callout-title">Key Definitions</div>
        <p><strong>Clean Price</strong> — the quoted price of a bond, excluding accrued interest. This is what you see on a trading screen.<br>
        <strong>Dirty Price</strong> — the actual settlement price, equal to clean price plus accrued interest. This is what the buyer pays.<br>
        <strong>Accrued Interest</strong> — the pro-rata share of the next coupon earned by the seller since the last coupon date.</p>
      </div>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>The YTM is a convenient summary statistic, but it embeds a flat term structure assumption. For relative value analysis across maturities, always compare bonds using spread measures referenced to the appropriate benchmark curve (Treasury spots or swap curve), not raw YTMs.</p>
      </div>
    `,
    example: {
      title: 'Pricing a 5-Year 4.50% Corporate Bond',
      given: `
        <ul>
          <li>Coupon rate: 4.50% (semiannual, 30/360)</li>
          <li>Maturity: 5 years (10 semiannual periods)</li>
          <li>Face value: $1,000</li>
          <li>Yield to maturity: 5.25%</li>
          <li>Days since last coupon: 45 (out of 180-day period)</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>Standard US corporate bond conventions: semiannual coupons, 30/360 day count</li>
          <li>No embedded options (bullet bond)</li>
          <li>Settlement is 45 days after the last coupon payment</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Determine Cash Flows</h4>
        <p>Semiannual coupon = $1,000 &times; 4.50% / 2 = <strong>$22.50</strong> per period</p>
        <p>Final cash flow at maturity: $22.50 + $1,000 = <strong>$1,022.50</strong></p>

        <h4>Step 2: Compute the Full (Dirty) Price Using YTM</h4>
        <p>The semiannual yield = 5.25% / 2 = 2.625%. We have 10 semiannual periods remaining, but the first coupon is only 135/180 of a full period away (since 45 days have elapsed). The dirty price is computed by discounting from the next coupon date and then compounding forward for the accrued fraction:</p>
        <div class="formula">
          P<sub>full</sub> = (1 + y/2)<sup>45/180</sup> &times; &Sigma;<sub>t=1</sub><sup>10</sup> 22.50 / (1.02625)<sup>t</sup> + 1000 / (1.02625)<sup>10</sup>
        </div>
        <p>First, compute the PV at the last coupon date of all remaining flows:</p>
        <table class="data-table">
          <tr><th>Period</th><th>Cash Flow</th><th>Discount Factor</th><th>PV</th></tr>
          <tr><td>1</td><td>$22.50</td><td>1/(1.02625)<sup>1</sup> = 0.97442</td><td>$21.92</td></tr>
          <tr><td>2</td><td>$22.50</td><td>1/(1.02625)<sup>2</sup> = 0.94950</td><td>$21.36</td></tr>
          <tr><td>3</td><td>$22.50</td><td>1/(1.02625)<sup>3</sup> = 0.92521</td><td>$20.82</td></tr>
          <tr><td>4</td><td>$22.50</td><td>1/(1.02625)<sup>4</sup> = 0.90154</td><td>$20.28</td></tr>
          <tr><td>5</td><td>$22.50</td><td>1/(1.02625)<sup>5</sup> = 0.87846</td><td>$19.76</td></tr>
          <tr><td>6</td><td>$22.50</td><td>1/(1.02625)<sup>6</sup> = 0.85596</td><td>$19.26</td></tr>
          <tr><td>7</td><td>$22.50</td><td>1/(1.02625)<sup>7</sup> = 0.83401</td><td>$18.77</td></tr>
          <tr><td>8</td><td>$22.50</td><td>1/(1.02625)<sup>8</sup> = 0.81261</td><td>$18.28</td></tr>
          <tr><td>9</td><td>$22.50</td><td>1/(1.02625)<sup>9</sup> = 0.79173</td><td>$17.81</td></tr>
          <tr><td>10</td><td>$1,022.50</td><td>1/(1.02625)<sup>10</sup> = 0.77135</td><td>$788.71</td></tr>
        </table>
        <p>PV at last coupon date = <strong>$966.97</strong></p>
        <p>Dirty price = $966.97 &times; (1.02625)<sup>45/180</sup> = $966.97 &times; 1.006527 = <strong>$973.28</strong></p>

        <h4>Step 3: Compute Accrued Interest</h4>
        <div class="formula">
          AI = ($1,000 &times; 4.50% / 2) &times; (45 / 180) = $22.50 &times; 0.25 = <strong>$5.625</strong>
        </div>

        <h4>Step 4: Compute Clean Price</h4>
        <div class="formula">
          Clean Price = Dirty Price &minus; Accrued Interest = $973.28 &minus; $5.625 = <strong>$967.66</strong>
        </div>
      `,
      result: `
        <table class="data-table">
          <tr><th>Measure</th><th>Value</th></tr>
          <tr><td>Dirty (Full) Price</td><td><strong>$973.28</strong></td></tr>
          <tr><td>Accrued Interest</td><td><strong>$5.625</strong></td></tr>
          <tr><td>Clean (Flat) Price</td><td><strong>$967.66</strong></td></tr>
          <tr><td>Current Yield</td><td>4.50 / 96.77 = <strong>4.65%</strong></td></tr>
        </table>
      `,
      interpretation: `
        <p>The bond trades at a <strong>discount</strong> (clean price below par) because the YTM of 5.25% exceeds the coupon rate of 4.50%. The market requires a higher return than the coupon provides, so the price adjusts downward. The $5.625 accrued interest reflects 45 days (one quarter) of the semiannual coupon period elapsed since the last payment.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>For a portfolio manager, the distinction between clean and dirty price matters for P&L attribution: the clean price change reflects market risk (yield movement), while the accrued interest accumulation represents the predictable carry component of total return.</p>
        </div>
      `
    },
    calcId: 'bond-price-ytm-calc',
    calcTitle: 'Bond Price & YTM Calculator',
    calcFields: [
      { id: 'couponRate', label: 'Coupon Rate (%)', type: 'number', default: 4.5, step: 0.125, min: 0, max: 15 },
      { id: 'maturity', label: 'Maturity (years)', type: 'number', default: 5, step: 0.5, min: 0.5, max: 50 },
      { id: 'faceValue', label: 'Face Value ($)', type: 'number', default: 1000, step: 100, min: 100, max: 1000000 },
      { id: 'ytm', label: 'Yield to Maturity (%)', type: 'number', default: 5.25, step: 0.05, min: 0.01, max: 25 },
      { id: 'daysSinceCoupon', label: 'Days Since Last Coupon', type: 'number', default: 45, step: 1, min: 0, max: 180 },
      { id: 'daysBetweenCoupons', label: 'Days in Coupon Period', type: 'number', default: 180, step: 1, min: 1, max: 366 }
    ],
    calcPreset: { name: 'Example: 5Y 4.50% Bond at 5.25% YTM', values: { couponRate: 4.5, maturity: 5, faceValue: 1000, ytm: 5.25, daysSinceCoupon: 45, daysBetweenCoupons: 180 } },
    calcCompute: function(vals) {
      var coupon = vals.couponRate;
      var mat = vals.maturity;
      var face = vals.faceValue;
      var ytm = vals.ytm;
      var daysAccrued = vals.daysSinceCoupon;
      var daysPeriod = vals.daysBetweenCoupons;

      var dirtyPrice = BondMath.priceFromYTM(coupon, mat, face, ytm, 2);
      var ai = BondMath.accruedInterest(coupon, face, daysAccrued, daysPeriod);
      var cleanPrice = dirtyPrice - ai;
      var impliedYTM = BondMath.ytmFromPrice(coupon, mat, face, cleanPrice + ai, 2);
      var currentYield = ((coupon/100) * face / cleanPrice) * 100;

      return [
        { label: 'Dirty (Full) Price', value: '$' + dirtyPrice.toFixed(4), unit: '' },
        { label: 'Accrued Interest', value: '$' + ai.toFixed(4), unit: '' },
        { label: 'Clean (Flat) Price', value: '$' + cleanPrice.toFixed(4), unit: '' },
        { label: 'Yield to Maturity', value: (impliedYTM * 100).toFixed(4), unit: '%' },
        { label: 'Current Yield', value: currentYield.toFixed(4), unit: '%' },
        { label: 'Accrual Fraction', value: (daysAccrued / daysPeriod * 100).toFixed(2), unit: '%' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 350, { top: 30, right: 30, bottom: 50, left: 70 });
      var data = [];
      var minPrice = Infinity, maxPrice = -Infinity;
      var yields = [];
      for (var y = 1.0; y <= 12.0; y += 0.25) {
        var p = BondMath.priceFromYTM(4.5, 5, 1000, y, 2);
        yields.push({ yield: y, price: p });
        if (p < minPrice) minPrice = p;
        if (p > maxPrice) maxPrice = p;
      }
      var pRange = maxPrice - minPrice;
      for (var i = 0; i < yields.length; i++) {
        data.push({
          x: (yields[i].yield - 1) / 11,
          y: (yields[i].price - minPrice) / pRange
        });
      }

      var xTicks = [];
      for (var yt = 1; yt <= 12; yt += 1) {
        xTicks.push({ pos: (yt - 1) / 11, label: yt + '%' });
      }
      var yTicks = [];
      for (var pt = 0; pt <= 1; pt += 0.2) {
        var priceLabel = (minPrice + pt * pRange).toFixed(0);
        yTicks.push({ pos: pt, label: '$' + priceLabel });
      }

      Chart.drawAxes(ctx, xTicks, yTicks, 'Yield to Maturity', 'Bond Price ($)');
      Chart.linePlot(ctx, data, '#2b402f', 2.5);

      // Mark the current YTM point
      var currentPrice = BondMath.priceFromYTM(4.5, 5, 1000, 5.25, 2);
      var dotX = (5.25 - 1) / 11;
      var dotY = (currentPrice - minPrice) / pRange;
      var dot = Chart.el('circle', {
        cx: ctx.p.left + dotX * ctx.iw,
        cy: ctx.p.top + ctx.ih - dotY * ctx.ih,
        r: 6,
        fill: '#c4453a',
        stroke: '#fff',
        'stroke-width': 2
      });
      ctx.svg.appendChild(dot);

      var label = Chart.el('text', {
        x: ctx.p.left + dotX * ctx.iw + 12,
        y: ctx.p.top + ctx.ih - dotY * ctx.ih - 8,
        fill: '#c4453a',
        'font-size': '12px',
        'font-weight': 'bold'
      });
      label.textContent = 'YTM 5.25% → $' + currentPrice.toFixed(2);
      ctx.svg.appendChild(label);

      // Par line
      var parY = (1000 - minPrice) / pRange;
      var parLine = Chart.el('line', {
        x1: ctx.p.left,
        y1: ctx.p.top + ctx.ih - parY * ctx.ih,
        x2: ctx.p.left + ctx.iw,
        y2: ctx.p.top + ctx.ih - parY * ctx.ih,
        stroke: '#a09488',
        'stroke-width': 1,
        'stroke-dasharray': '5,5'
      });
      ctx.svg.appendChild(parLine);

      var parLabel = Chart.el('text', {
        x: ctx.p.left + ctx.iw + 3,
        y: ctx.p.top + ctx.ih - parY * ctx.ih + 4,
        fill: '#a09488',
        'font-size': '11px'
      });
      parLabel.textContent = 'Par ($1,000)';
      ctx.svg.appendChild(parLabel);

      Chart.legend(ctx, [
        { label: 'Price-Yield Curve (5Y 4.50% Bond)', color: '#2b402f' },
        { label: 'Current Price at 5.25%', color: '#c4453a' }
      ], ctx.p.left + 10, 12);

      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A 10-year corporate bond with a 6% coupon is priced at $1,045.00. What can you conclude about the bond\'s YTM relative to its coupon rate?',
        options: [
          'YTM is less than 6% because the bond trades at a premium',
          'YTM is exactly 6% because the coupon determines yield',
          'YTM is greater than 6% because the bond trades at a premium',
          'YTM is less than 6% because longer maturities always have lower yields'
        ],
        correct: 0,
        explanation: 'When a bond trades above par (premium), investors accept a lower YTM than the coupon rate. The higher price reduces the effective return below the stated coupon rate. The excess coupon payments relative to YTM compensate for the premium paid above par, which is amortized over the life of the bond.'
      },
      {
        q: 'A portfolio manager sees a bond quoted at 98.50 clean with 60 days accrued on a $1,000 face, 5% semiannual coupon using 30/360 convention. What is the settlement (dirty) price?',
        options: [
          '$985.00',
          '$993.33',
          '$1,001.67',
          '$990.00'
        ],
        correct: 1,
        explanation: 'Dirty price = Clean price + Accrued interest. Accrued = ($1,000 × 5% / 2) × (60/180) = $25 × 1/3 = $8.33. Dirty price = $985.00 + $8.33 = $993.33. The buyer compensates the seller for 60 days of earned but unpaid coupon income.'
      },
      {
        q: 'Why might two bonds with identical YTMs have different present values when priced off the spot curve?',
        options: [
          'Spot rate pricing always produces higher values because it uses more discount rates',
          'Different coupon structures create different exposures across the term structure, and the spot curve is not flat',
          'YTM pricing ignores credit risk while spot pricing includes it',
          'The bonds must have different maturities for this to occur'
        ],
        correct: 1,
        explanation: 'YTM uses a single flat discount rate for all cash flows, while spot rate pricing uses the unique zero-coupon rate for each maturity. A high-coupon bond receives more of its value from earlier (typically lower-rate) cash flows compared to a low-coupon bond. When the yield curve is steep, this difference in cash flow timing interacts with varying spot rates to produce different prices even at the same YTM.'
      },
      {
        q: 'As a portfolio manager, you observe that a bond\'s dirty price jumps by exactly one coupon payment on the ex-coupon date. What happened?',
        options: [
          'The bond was upgraded by a rating agency',
          'The market yield dropped suddenly',
          'This is impossible — the dirty price should drop by the coupon amount on the ex-coupon date',
          'The bond was called by the issuer'
        ],
        correct: 2,
        explanation: 'On the ex-coupon (or coupon payment) date, the accrued interest resets from a full coupon back to zero. The dirty price drops by approximately one coupon payment because the buyer no longer needs to compensate the seller for the accrued interest. The clean price typically shows minimal change across the coupon date, as it strips out the accrued interest sawtooth pattern.'
      },
      {
        q: 'A trader argues that current yield (coupon/clean price) is a better measure than YTM for short-term trading decisions. Under what scenario is this most defensible?',
        options: [
          'For long-maturity bonds held to maturity',
          'For very short holding periods where price change is the dominant return component',
          'For bonds trading at par',
          'For very short holding periods on high-coupon bonds where the income component dominates expected price change'
        ],
        correct: 3,
        explanation: 'Current yield measures only the income component relative to price. For short holding periods on high-coupon bonds where the accrual return dominates, current yield gives a reasonable approximation of expected carry. However, for bonds with significant duration risk or for longer holding periods, YTM and total return analysis are more appropriate because they incorporate principal amortization and reinvestment effects.'
      }
    ]
  },
  {
    id: 'section-2',
    number: 2,
    title: 'Spread Measures',
    subtopics: ['G-spread', 'I-spread', 'Z-spread', 'OAS'],
    lesson: `
      <h3>Why Spread Measures Matter</h3>
      <p>A corporate bond's yield can be decomposed into a risk-free component and a spread that compensates for credit risk, liquidity risk, and optionality. Different spread measures isolate these components in different ways, making them useful for different analytical purposes.</p>

      <h3>G-Spread (Government Spread)</h3>
      <p>The G-spread is the simplest measure: the difference between a corporate bond's YTM and the YTM of an interpolated on-the-run Treasury with the same maturity.</p>
      <div class="formula">
        G-Spread = YTM<sub>corporate</sub> &minus; YTM<sub>Treasury</sub>(interpolated at same maturity)
      </div>
      <p>It is easy to compute but has a major limitation: it compares two single-rate yields without accounting for the shape of the term structure. The Treasury yield used is typically linearly interpolated between on-the-run benchmarks.</p>

      <h3>I-Spread (Interpolated Swap Spread)</h3>
      <p>The I-spread replaces the Treasury benchmark with the interest rate swap curve (SOFR-based or formerly LIBOR-based):</p>
      <div class="formula">
        I-Spread = YTM<sub>corporate</sub> &minus; Swap Rate(interpolated at same maturity)
      </div>
      <p>The swap curve is smoother and more continuously available than Treasuries, making it preferred for interbank and derivative-based analysis. The I-spread captures credit and liquidity risk relative to the interbank funding rate.</p>

      <h3>Z-Spread (Zero-Volatility Spread)</h3>
      <p>The Z-spread is a constant spread added to each point on the Treasury (or swap) spot curve that reprices the bond exactly:</p>
      <div class="formula">
        P = &Sigma;<sub>t=1</sub><sup>2T</sup> &nbsp; CF<sub>t</sub> / (1 + (s<sub>t</sub> + Z)/2)<sup>t</sup>
      </div>
      <p>Unlike G-spread and I-spread, the Z-spread accounts for the <em>shape</em> of the term structure. It is solved iteratively — there is no closed-form solution. The Z-spread is the market standard for bullet bonds without embedded options.</p>

      <h3>OAS (Option-Adjusted Spread)</h3>
      <p>For callable or putable bonds, the Z-spread overstates the credit compensation because part of the spread compensates for option risk. The OAS strips out the option value:</p>
      <div class="formula">
        OAS &asymp; Z-Spread &minus; Option Cost (in bps)
      </div>
      <p>The OAS is computed using an interest rate model (binomial tree, Monte Carlo) that simulates rate paths and determines when embedded options would be exercised. For bullet bonds with no embedded options, OAS &asymp; Z-spread.</p>

      <div class="callout insight">
        <div class="callout-title">When to Use Each Spread</div>
        <p><strong>G-Spread:</strong> Quick relative value screening, especially for on-the-run bonds. Common in government/agency analysis.<br>
        <strong>I-Spread:</strong> Preferred when hedging with swaps or analyzing bank credit portfolios. Standard in EUR markets.<br>
        <strong>Z-Spread:</strong> The workhorse for bullet corporate bonds. Use for cross-maturity relative value, fair-value models, and risk systems.<br>
        <strong>OAS:</strong> Required for callable/putable bonds, MBS, and any security with embedded options. The only truly apples-to-apples comparison across bonds with different option features.</p>
      </div>

      <div class="callout warning">
        <div class="callout-title">Common Pitfall</div>
        <p>Never compare the G-spread of a callable bond with the G-spread of a bullet bond. The callable bond's higher spread partly reflects option cost, not extra credit compensation. Use OAS for cross-structure comparisons.</p>
      </div>

      <h3>Spread Hierarchy</h3>
      <table class="data-table">
        <tr><th>Measure</th><th>Reference Curve</th><th>Accounts for Curve Shape</th><th>Accounts for Options</th></tr>
        <tr><td>G-Spread</td><td>Treasury YTM</td><td>No</td><td>No</td></tr>
        <tr><td>I-Spread</td><td>Swap Rate</td><td>No</td><td>No</td></tr>
        <tr><td>Z-Spread</td><td>Treasury/Swap Spots</td><td>Yes</td><td>No</td></tr>
        <tr><td>OAS</td><td>Treasury/Swap Spots + Model</td><td>Yes</td><td>Yes</td></tr>
      </table>
    `,
    example: {
      title: 'Spread Analysis: BBB-Rated 7-Year 5.75% Bond at 98.50',
      given: `
        <ul>
          <li>Bond: 7-year maturity, 5.75% coupon (semiannual), BBB-rated</li>
          <li>Clean price: $98.50 per $100 face (i.e., $985.00 per $1,000 face)</li>
          <li>7-year interpolated Treasury yield: ~3.95%</li>
          <li>7-year interpolated swap rate: ~4.15%</li>
          <li>Assumed implied volatility for OAS: 15%</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>No embedded options (bullet bond)</li>
          <li>Standard semiannual coupon, 30/360 day count</li>
          <li>Settlement at clean price (no accrued for simplicity)</li>
          <li>Treasury spot curve and swap spot curve available via BondMath constants</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Compute the Bond's YTM</h4>
        <p>Using price = $985.00 for face = $1,000, coupon = 5.75%, maturity = 7 years, we solve for the YTM iteratively:</p>
        <p>YTM &asymp; <strong>5.99%</strong></p>

        <h4>Step 2: Compute G-Spread</h4>
        <div class="formula">
          G-Spread = YTM<sub>bond</sub> &minus; YTM<sub>Treasury</sub> = 5.99% &minus; 3.95% = <strong>204 bps</strong>
        </div>
        <p>This is the raw yield pickup over the interpolated 7-year Treasury benchmark.</p>

        <h4>Step 3: Compute I-Spread</h4>
        <div class="formula">
          I-Spread = YTM<sub>bond</sub> &minus; Swap Rate = 5.99% &minus; 4.15% = <strong>184 bps</strong>
        </div>
        <p>The I-spread is narrower than G-spread because swap rates are typically higher than Treasury yields (swap spread positive), reflecting bank credit and liquidity factors in the swap market.</p>

        <h4>Step 4: Compute Z-Spread</h4>
        <p>We iteratively find the constant spread Z such that discounting each cash flow at (spot rate + Z) produces the market price of $985.00:</p>
        <div class="formula">
          985 = &Sigma;<sub>t=1</sub><sup>14</sup> 28.75 / (1 + (s<sub>t</sub> + Z)/2)<sup>t</sup> + 1000 / (1 + (s<sub>14</sub> + Z)/2)<sup>14</sup>
        </div>
        <p>Solving iteratively: Z-Spread &asymp; <strong>~210 bps</strong></p>
        <p>The Z-spread is slightly higher than the G-spread because it properly accounts for the upward-sloping term structure — earlier cash flows are discounted at lower rates, requiring a marginally wider spread to match the flat G-spread.</p>

        <h4>Step 5: Compute OAS</h4>
        <p>For a bullet bond with no embedded options, the OAS is very close to the Z-spread. Using a lognormal rate model with 15% volatility, the option cost for a non-callable bond is essentially zero:</p>
        <p>OAS &asymp; <strong>~208 bps</strong></p>
        <p>The tiny difference from the Z-spread arises from the convexity adjustment in the stochastic model.</p>
      `,
      result: `
        <table class="data-table">
          <tr><th>Spread Measure</th><th>Value (bps)</th><th>Reference</th></tr>
          <tr><td>G-Spread</td><td><strong>204</strong></td><td>Treasury YTM</td></tr>
          <tr><td>I-Spread</td><td><strong>184</strong></td><td>Swap Rate</td></tr>
          <tr><td>Z-Spread</td><td><strong>~210</strong></td><td>Treasury Spot Curve</td></tr>
          <tr><td>OAS</td><td><strong>~208</strong></td><td>Rate Model (Vol=15%)</td></tr>
        </table>
      `,
      interpretation: `
        <p>The spread hierarchy for this bullet BBB bond is: Z-Spread &ge; G-Spread &gt; OAS &asymp; Z-Spread &gt; I-Spread. The G-spread and Z-spread are close because the curve is only moderately upward-sloping at the 7Y point. The I-spread is about 20 bps tighter because it references the higher swap curve rather than Treasuries.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>For this bullet bond, OAS &asymp; Z-spread, confirming no meaningful option cost. If this bond were callable and its OAS were 150 bps versus a Z-spread of 210 bps, we would conclude that approximately 60 bps of the Z-spread compensates for the call option sold to the issuer — critical information for relative value analysis.</p>
        </div>
      `
    },
    calcId: 'spread-measures-calc',
    calcTitle: 'Spread Measures Calculator',
    calcFields: [
      { id: 'couponRate', label: 'Coupon Rate (%)', type: 'number', default: 5.75, step: 0.125, min: 0, max: 15 },
      { id: 'maturity', label: 'Maturity (years)', type: 'number', default: 7, step: 0.5, min: 0.5, max: 30 },
      { id: 'faceValue', label: 'Face Value ($)', type: 'number', default: 1000, step: 100, min: 100, max: 1000000 },
      { id: 'price', label: 'Clean Price ($)', type: 'number', default: 985, step: 0.5, min: 50, max: 200000 },
      { id: 'volatility', label: 'Rate Volatility (%)', type: 'number', default: 15, step: 1, min: 1, max: 50 }
    ],
    calcPreset: { name: 'Example: BBB 7Y 5.75% at $985', values: { couponRate: 5.75, maturity: 7, faceValue: 1000, price: 985, volatility: 15 } },
    calcCompute: function(vals) {
      var coupon = vals.couponRate;
      var mat = vals.maturity;
      var face = vals.faceValue;
      var price = vals.price;
      var vol = vals.volatility / 100;

      var ytm = BondMath.ytmFromPrice(coupon, mat, face, price, 2);
      var gSpread = BondMath.gSpread(ytm, mat);
      var iSpread = BondMath.iSpread(ytm, mat);
      var zSpread = BondMath.zSpread(coupon, mat, face, price, 2);
      var oas = BondMath.oasApprox(coupon, mat, face, price, 2, vol);

      return [
        { label: 'Bond YTM', value: ytm.toFixed(3), unit: '%' },
        { label: 'G-Spread', value: gSpread.toFixed(1), unit: 'bps' },
        { label: 'I-Spread', value: iSpread.toFixed(1), unit: 'bps' },
        { label: 'Z-Spread', value: zSpread.toFixed(1), unit: 'bps' },
        { label: 'OAS (approx)', value: oas.toFixed(1), unit: 'bps' },
        { label: 'Option Cost', value: (zSpread - oas).toFixed(1), unit: 'bps' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 350, { top: 30, right: 30, bottom: 50, left: 70 });

      // Build a waterfall showing spread decomposition
      var items = [
        { label: 'Treasury Yield', value: 0.45, displayValue: '3.95%', color: '#2b402f' },
        { label: '+ G-Spread', value: 0.23, displayValue: '+204 bps', color: '#5a8c62' },
        { label: '= Bond YTM', value: 0.68, displayValue: '5.99%', color: '#2b7a3a' },
        { label: 'Swap Rate', value: 0.47, displayValue: '4.15%', color: '#7a9e82' },
        { label: '+ I-Spread', value: 0.21, displayValue: '+184 bps', color: '#d4863a' },
        { label: 'Z-Spread', value: 0.24, displayValue: '210 bps', color: '#c4453a' },
        { label: 'OAS', value: 0.235, displayValue: '208 bps', color: '#8a6d5e' },
        { label: 'Option Cost', value: 0.005, displayValue: '~2 bps', color: '#a09488' }
      ];

      Chart.waterfallChart(ctx, items);

      Chart.legend(ctx, [
        { label: 'Risk-Free Rate', color: '#2b402f' },
        { label: 'Credit/Liquidity Spread', color: '#5a8c62' },
        { label: 'Option Cost', color: '#a09488' }
      ], ctx.p.left + 10, 12);

      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A 5-year BBB bullet bond has a G-spread of 180 bps and a Z-spread of 195 bps. The 15 bps difference most likely reflects:',
        options: [
          'The embedded option cost in the bond',
          'The difference between the Treasury yield curve shape and a flat yield assumption',
          'The bond\'s liquidity premium',
          'A calculation error — G-spread and Z-spread should be identical'
        ],
        correct: 1,
        explanation: 'The G-spread uses a single interpolated Treasury yield (flat rate assumption), while the Z-spread adds a constant spread to each point on the spot curve (preserving curve shape). When the yield curve is upward-sloping, early cash flows are discounted at lower spot rates, requiring a wider constant spread (Z-spread) to match the price. This accounts for the typical Z-spread > G-spread relationship.'
      },
      {
        q: 'When comparing a callable bond and a bullet bond from the same issuer with the same maturity, which spread measure provides the most meaningful comparison?',
        options: [
          'G-spread, because it is simplest',
          'I-spread, because it uses the swap curve',
          'Z-spread, because it accounts for curve shape',
          'OAS, because it adjusts for the embedded option'
        ],
        correct: 3,
        explanation: 'OAS is the only spread measure that strips out the option cost from the callable bond\'s spread. The callable bond\'s G-spread, I-spread, and Z-spread all include compensation for the short call option, making them incomparable with the bullet bond\'s spreads. OAS provides an apples-to-apples measure of pure credit/liquidity compensation.'
      },
      {
        q: 'A bond\'s I-spread is 150 bps while its G-spread is 175 bps. This 25 bps difference is best explained by:',
        options: [
          'The bond has significant embedded option value',
          'The swap spread — swap rates are typically higher than Treasury yields',
          'The I-spread uses spot rates while G-spread does not',
          'Calculation error in the G-spread methodology'
        ],
        correct: 1,
        explanation: 'Since swap rates incorporate interbank credit and liquidity premiums, they are typically higher than Treasury yields (positive swap spread). When the bond\'s YTM is compared to a higher reference rate (swap), the spread is narrower. G-Spread = Bond YTM - Treasury YTM; I-Spread = Bond YTM - Swap Rate. If Swap Rate > Treasury YTM, then I-Spread < G-Spread. The difference equals the swap spread at that maturity.'
      },
      {
        q: 'A portfolio manager observes that a bond\'s Z-spread has widened from 200 to 250 bps while its OAS has remained stable at 200 bps. What is the most likely explanation?',
        options: [
          'The bond\'s credit quality has deteriorated',
          'Interest rate volatility has increased, raising the value of the embedded call option',
          'The Treasury curve has flattened',
          'The bond has been downgraded by a rating agency'
        ],
        correct: 1,
        explanation: 'Z-Spread = OAS + Option Cost. If the Z-spread widened by 50 bps but OAS is unchanged, the option cost increased by 50 bps. For a callable bond, this happens when interest rate volatility rises: higher vol makes the embedded call option more valuable to the issuer (more costly to the bondholder), widening the gap between Z-spread and OAS without any change in credit fundamentals.'
      },
      {
        q: 'In which market environment would the G-spread and Z-spread converge most closely?',
        options: [
          'When the yield curve is steeply upward-sloping',
          'When the yield curve is inverted',
          'When the yield curve is perfectly flat',
          'When credit spreads are very wide'
        ],
        correct: 2,
        explanation: 'When the yield curve is flat, all spot rates equal the par yield, so using a single rate (G-spread) versus adding a constant spread to each identical spot rate (Z-spread) produces the same result. The divergence between G-spread and Z-spread is driven entirely by the curvature/slope of the term structure. A flat curve eliminates this source of difference.'
      }
    ]
  },
  {
    id: 'section-3',
    number: 3,
    title: 'Credit Risk & Default Modeling',
    subtopics: ['Hazard rates', 'Recovery assumptions', 'Expected loss vs spread'],
    lesson: `
      <h3>The Constant Hazard Rate Model</h3>
      <p>The hazard rate (also called default intensity) &lambda; represents the instantaneous probability of default at any point in time, conditional on survival to that point. Under the constant hazard rate assumption, &lambda; is fixed over time, giving us a tractable model for credit risk.</p>
      <div class="formula">
        &lambda;(t) = &lambda; &nbsp;&nbsp; (constant for all t)
      </div>
      <p>This is the credit risk equivalent of the constant force of mortality in actuarial science. While simplistic, it is the foundation for more complex intensity-based models.</p>

      <h3>Survival Probability and Cumulative PD</h3>
      <p>The <strong>survival probability</strong> is the probability that the issuer has <em>not</em> defaulted by time t:</p>
      <div class="formula">
        S(t) = e<sup>&minus;&lambda;t</sup>
      </div>
      <p>The <strong>cumulative probability of default</strong> by time t is the complement:</p>
      <div class="formula">
        PD(t) = 1 &minus; S(t) = 1 &minus; e<sup>&minus;&lambda;t</sup>
      </div>
      <p>For small &lambda; and short horizons, PD(t) &asymp; &lambda;t (linear approximation). For example, a 2% annual hazard rate implies approximately a 2% 1-year PD. But over longer horizons, the exponential compounds: the 5-year cumulative PD is about 9.5%, not 10%.</p>

      <h3>Recovery Rate and Loss Given Default (LGD)</h3>
      <p>If default occurs, investors recover a fraction of the bond's face value:</p>
      <div class="formula">
        Recovery = RR &times; Face Value<br>
        Loss Given Default (LGD) = 1 &minus; RR
      </div>
      <p>Standard recovery rate assumptions by seniority:</p>
      <table class="data-table">
        <tr><th>Seniority</th><th>Typical Recovery</th><th>LGD</th></tr>
        <tr><td>Senior Secured</td><td>50-65%</td><td>35-50%</td></tr>
        <tr><td>Senior Unsecured</td><td>35-45%</td><td>55-65%</td></tr>
        <tr><td>Subordinated</td><td>20-30%</td><td>70-80%</td></tr>
        <tr><td>Junior Subordinated</td><td>10-20%</td><td>80-90%</td></tr>
      </table>
      <p>Moody's long-run average for senior unsecured bonds is approximately <strong>40%</strong>, which is the market standard assumption for investment-grade analysis.</p>

      <h3>Expected Loss</h3>
      <p>Expected loss is the probability-weighted loss over the holding period:</p>
      <div class="formula">
        EL = PD(T) &times; LGD &times; Notional = (1 &minus; e<sup>&minus;&lambda;T</sup>) &times; (1 &minus; RR) &times; Notional
      </div>
      <p>This is the core input to credit valuation adjustment (CVA) and credit reserve calculations.</p>

      <h3>Credit Spread and the Hazard Rate</h3>
      <p>Under risk-neutral pricing with continuous compounding, the credit spread is approximately:</p>
      <div class="formula">
        Credit Spread &asymp; &lambda; &times; LGD = &lambda; &times; (1 &minus; RR)
      </div>
      <p>This elegant relationship says: the market charges a spread proportional to the likelihood of default times the loss severity. For a 2% hazard rate and 40% recovery:</p>
      <div class="formula">
        Spread &asymp; 0.02 &times; (1 &minus; 0.40) = 0.012 = <strong>120 bps</strong>
      </div>

      <div class="callout definition">
        <div class="callout-title">Risk-Neutral vs. Real-World PDs</div>
        <p>Market-implied (risk-neutral) default probabilities extracted from spreads are typically <strong>2-4x higher</strong> than historical (actuarial) default rates. This gap reflects the credit risk premium — investors demand compensation for bearing default risk beyond the expected loss. A BBB bond with a historical 5Y PD of ~2% might trade at spreads implying a risk-neutral 5Y PD of ~5-8%.</p>
      </div>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>The hazard rate model is a <em>reduced-form</em> approach — it does not model the firm's asset value directly (that would be a <em>structural</em> model like Merton). Its advantage is calibration simplicity: you can back out the hazard rate from observed CDS spreads or bond spreads using the approximation &lambda; &asymp; Spread / LGD.</p>
      </div>
    `,
    example: {
      title: 'Credit Risk Analysis: BBB Issuer with 2% Hazard Rate',
      given: `
        <ul>
          <li>Annual hazard rate: 2.0% (constant)</li>
          <li>Recovery rate: 40% (senior unsecured)</li>
          <li>Analysis horizon: 1 to 5 years</li>
          <li>Notional exposure: $10,000,000</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>Constant hazard rate (no term structure of default intensity)</li>
          <li>Recovery rate is fraction of face value, paid at default</li>
          <li>Continuous-time framework: S(t) = e<sup>&minus;&lambda;t</sup></li>
          <li>No discounting applied to expected loss (undiscounted EL)</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Compute Survival Probabilities and Cumulative PDs</h4>
        <p>Using S(t) = e<sup>&minus;0.02t</sup> and PD(t) = 1 &minus; S(t):</p>
        <table class="data-table">
          <tr><th>Year (t)</th><th>S(t) = e<sup>&minus;0.02t</sup></th><th>PD(t) = 1 &minus; S(t)</th></tr>
          <tr><td>1</td><td>e<sup>&minus;0.02</sup> = <strong>98.020%</strong></td><td><strong>1.980%</strong></td></tr>
          <tr><td>2</td><td>e<sup>&minus;0.04</sup> = <strong>96.079%</strong></td><td><strong>3.921%</strong></td></tr>
          <tr><td>3</td><td>e<sup>&minus;0.06</sup> = <strong>94.176%</strong></td><td><strong>5.824%</strong></td></tr>
          <tr><td>4</td><td>e<sup>&minus;0.08</sup> = <strong>92.312%</strong></td><td><strong>7.688%</strong></td></tr>
          <tr><td>5</td><td>e<sup>&minus;0.10</sup> = <strong>90.484%</strong></td><td><strong>9.516%</strong></td></tr>
        </table>
        <p>Note that PD grows sub-linearly: the 5Y PD (9.516%) is less than 5 &times; 1Y PD (9.90%) because the conditional hazard applies to an ever-smaller surviving population.</p>

        <h4>Step 2: Compute Loss Given Default</h4>
        <div class="formula">
          LGD = 1 &minus; Recovery Rate = 1 &minus; 0.40 = <strong>60%</strong>
        </div>

        <h4>Step 3: Compute Expected Loss at Each Horizon</h4>
        <div class="formula">
          EL(t) = PD(t) &times; LGD &times; Notional
        </div>
        <table class="data-table">
          <tr><th>Year</th><th>PD(t)</th><th>LGD</th><th>Expected Loss ($)</th></tr>
          <tr><td>1</td><td>1.980%</td><td>60%</td><td>$10M &times; 1.980% &times; 60% = <strong>$118,812</strong></td></tr>
          <tr><td>2</td><td>3.921%</td><td>60%</td><td><strong>$235,253</strong></td></tr>
          <tr><td>3</td><td>5.824%</td><td>60%</td><td><strong>$349,354</strong></td></tr>
          <tr><td>4</td><td>7.688%</td><td>60%</td><td><strong>$461,149</strong></td></tr>
          <tr><td>5</td><td>9.516%</td><td>60%</td><td><strong>$570,967</strong></td></tr>
        </table>

        <h4>Step 4: Compute Implied Credit Spread</h4>
        <div class="formula">
          Credit Spread &asymp; &lambda; &times; LGD = 0.02 &times; 0.60 = 0.0120 = <strong>120 bps</strong>
        </div>
        <p>This is the risk-neutral spread consistent with the given hazard rate and recovery assumption. A BBB bond from this issuer should trade near a Z-spread of 120 bps if credit spreads exactly reflected actuarial default expectations (in practice, the market spread would be wider due to the credit risk premium).</p>
      `,
      result: `
        <table class="data-table">
          <tr><th>Metric</th><th>Value</th></tr>
          <tr><td>5-Year Cumulative PD</td><td><strong>9.516%</strong></td></tr>
          <tr><td>5-Year Survival Probability</td><td><strong>90.484%</strong></td></tr>
          <tr><td>LGD</td><td><strong>60%</strong></td></tr>
          <tr><td>5-Year Expected Loss</td><td><strong>$570,967</strong></td></tr>
          <tr><td>Implied Credit Spread</td><td><strong>120 bps</strong></td></tr>
        </table>
      `,
      interpretation: `
        <p>On $10 million notional, the 5-year expected credit loss is approximately $571K (5.7% of notional). The implied credit spread of 120 bps over 5 years would generate roughly $600K in spread income (5 &times; $10M &times; 1.20%), slightly more than the expected loss — the excess compensates investors for the <em>uncertainty</em> of default timing and the risk of concentrated losses.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>Real-world BBB spreads of 150-200 bps are wider than the 120 bps implied by this model, reflecting the credit risk premium. The difference (~30-80 bps) is the excess return available to credit investors willing to bear default risk — the foundation of systematic credit alpha strategies.</p>
        </div>
      `
    },
    calcId: 'credit-risk-calc',
    calcTitle: 'Credit Risk Model Calculator',
    calcFields: [
      { id: 'hazardRate', label: 'Hazard Rate (%)', type: 'number', default: 2.0, step: 0.1, min: 0.01, max: 30 },
      { id: 'recoveryRate', label: 'Recovery Rate (%)', type: 'number', default: 40, step: 1, min: 0, max: 100 },
      { id: 'maturity', label: 'Maturity / Horizon (years)', type: 'number', default: 5, step: 0.5, min: 0.5, max: 30 },
      { id: 'notional', label: 'Notional ($)', type: 'number', default: 10000000, step: 1000000, min: 1000, max: 10000000000 }
    ],
    calcPreset: { name: 'Example: BBB 2% Hazard, 40% Recovery, 5Y', values: { hazardRate: 2.0, recoveryRate: 40, maturity: 5, notional: 10000000 } },
    calcCompute: function(vals) {
      var hr = vals.hazardRate / 100;
      var rr = vals.recoveryRate / 100;
      var mat = vals.maturity;
      var notional = vals.notional;

      var cumPD = BondMath.hazardToPD(hr, mat);
      var survProb = BondMath.survivalProb(hr, mat);
      var lgd = 1 - rr;
      var el = BondMath.expectedLoss(hr, mat, lgd);
      var impliedSpread = BondMath.creditSpreadFromHazard(hr, rr);
      var elDollars = el * notional;

      return [
        { label: 'Cumulative PD', value: (cumPD * 100).toFixed(3), unit: '%' },
        { label: 'Survival Probability', value: (survProb * 100).toFixed(3), unit: '%' },
        { label: 'Loss Given Default', value: (lgd * 100).toFixed(1), unit: '%' },
        { label: 'Expected Loss (ratio)', value: (el * 100).toFixed(3), unit: '%' },
        { label: 'Expected Loss ($)', value: '$' + elDollars.toLocaleString(undefined, {maximumFractionDigits: 0}), unit: '' },
        { label: 'Implied Credit Spread', value: impliedSpread.toFixed(1), unit: 'bps' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 350, { top: 30, right: 30, bottom: 50, left: 70 });

      var hazardRates = [0.01, 0.02, 0.04];
      var colors = ['#2b402f', '#5a8c62', '#c4453a'];
      var labels = ['1% Hazard Rate', '2% Hazard Rate', '4% Hazard Rate'];

      var maxT = 20;

      var xTicks = [];
      for (var t = 0; t <= maxT; t += 5) {
        xTicks.push({ pos: t / maxT, label: t + 'Y' });
      }
      var yTicks = [];
      for (var p = 0; p <= 1; p += 0.2) {
        yTicks.push({ pos: p, label: (p * 100).toFixed(0) + '%' });
      }

      Chart.drawAxes(ctx, xTicks, yTicks, 'Time (Years)', 'Survival Probability');

      for (var h = 0; h < hazardRates.length; h++) {
        var data = [];
        for (var ti = 0; ti <= maxT; ti += 0.5) {
          var sp = Math.exp(-hazardRates[h] * ti);
          data.push({ x: ti / maxT, y: sp });
        }
        Chart.linePlot(ctx, data, colors[h], 2.5);
      }

      // Add area under the 2% curve to show cumulative PD region
      var areaData = [];
      for (var ai = 0; ai <= maxT; ai += 0.5) {
        var sp2 = Math.exp(-0.02 * ai);
        areaData.push({ x: ai / maxT, y: sp2 });
      }
      Chart.areaPlot(ctx, areaData, 'rgba(245,158,11,0.1)');

      Chart.legend(ctx, [
        { label: labels[0], color: colors[0] },
        { label: labels[1], color: colors[1] },
        { label: labels[2], color: colors[2] }
      ], ctx.p.left + 10, 12);

      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'An issuer has a constant hazard rate of 3%. What is the approximate cumulative probability of default over 5 years?',
        options: [
          '15.0%',
          '13.9%',
          '12.0%',
          '3.0%'
        ],
        correct: 1,
        explanation: 'PD(5) = 1 - e^(-0.03 × 5) = 1 - e^(-0.15) = 1 - 0.8607 = 13.93%. This is less than the linear approximation of 15% (= 3% × 5) because the exponential survival function causes the marginal default probability to decline each year as the surviving population shrinks.'
      },
      {
        q: 'If a senior unsecured bond\'s credit spread is 180 bps and the assumed recovery rate is 40%, what is the implied hazard rate?',
        options: [
          '1.08% per year',
          '3.00% per year',
          '4.50% per year',
          '7.20% per year'
        ],
        correct: 1,
        explanation: 'Using the approximation Spread ≈ λ × (1 - Recovery), where (1 - Recovery) is the Loss Given Default (LGD): λ = Spread / (1 - R) = 180 bps / (1 - 0.40) = 180 / 0.60 = 300 bps = 3.00% per year. This back-of-the-envelope calculation allows rapid conversion between observed spreads and implied default probabilities.'
      },
      {
        q: 'Two bonds from the same issuer have different recovery assumptions: Bond X (senior secured, 60% recovery) and Bond Y (subordinated, 25% recovery). If both bonds should reflect the same hazard rate, what is the expected relationship between their spreads?',
        options: [
          'Bond X should have a wider spread because it has higher recovery',
          'Bond Y should have a wider spread because its higher LGD requires more spread compensation',
          'Both bonds should trade at the same spread because they share the same issuer',
          'The relationship depends on the coupon rates of the bonds'
        ],
        correct: 1,
        explanation: 'Spread ≈ λ × LGD. Same issuer means same hazard rate λ. Bond X has LGD = 40%, Bond Y has LGD = 75%. At the same λ, Bond Y\'s spread should be roughly 75/40 = 1.875× wider than Bond X\'s spread. The subordinated bond requires a wider spread because investors lose more per dollar of default.'
      },
      {
        q: 'A portfolio manager observes that a BBB bond\'s market spread implies a 5-year PD of 8%, while rating agency historical data shows a 5-year actuarial PD of 2.5% for BBB issuers. The difference most likely reflects:',
        options: [
          'The rating agency data is incorrect',
          'The bond is mispriced and should be purchased',
          'The credit risk premium — compensation for bearing systematic default risk beyond expected loss',
          'The bond has embedded options inflating the spread'
        ],
        correct: 2,
        explanation: 'Risk-neutral PDs extracted from market spreads are typically 2-4x higher than historical actuarial PDs. This gap is the credit risk premium: investors demand compensation not just for expected default losses but for the systematic nature of credit risk (defaults tend to cluster in recessions when marginal utility of wealth is high). This is a well-documented empirical regularity, not a mispricing.'
      },
      {
        q: 'An investor holds a $50M portfolio of BBB bonds with an average hazard rate of 1.5% and recovery rate of 40%. What is the approximate annual expected loss?',
        options: [
          '$750,000',
          '$450,000',
          '$300,000',
          '$500,000'
        ],
        correct: 1,
        explanation: 'Annual expected loss ≈ λ × LGD × Notional = 0.015 × (1 - 0.40) × $50M = 0.015 × 0.60 × $50M = 0.009 × $50M = $450,000. This is the average annual credit loss the portfolio manager should budget for, though actual losses will be lumpy — zero in most years, large in bad years.'
      }
    ]
  },
  {
    id: 'section-4',
    number: 4,
    title: 'Duration & Convexity in Credit',
    subtopics: ['Modified duration', 'Spread duration', 'Key rate duration'],
    lesson: `
      <h3>Duration: The Core Interest Rate Sensitivity Measure</h3>
      <p>Duration quantifies the sensitivity of a bond's price to changes in yield. There are several related but distinct duration concepts:</p>

      <h3>Macaulay Duration</h3>
      <p>The weighted-average time to receive cash flows, where the weight of each cash flow is its present value as a fraction of the total price:</p>
      <div class="formula">
        D<sub>Mac</sub> = (1/P) &times; &Sigma;<sub>t=1</sub><sup>2T</sup> &nbsp; t/(2) &times; PV(CF<sub>t</sub>)
      </div>
      <p>Macaulay duration is measured in years and represents the "center of gravity" of the bond's cash flows in time. It equals the maturity for zero-coupon bonds.</p>

      <h3>Modified Duration</h3>
      <p>Modified duration converts Macaulay duration into an actual price sensitivity measure:</p>
      <div class="formula">
        D<sub>Mod</sub> = D<sub>Mac</sub> / (1 + y/2)
      </div>
      <div class="formula">
        &Delta;P/P &asymp; &minus;D<sub>Mod</sub> &times; &Delta;y
      </div>
      <p>A bond with a modified duration of 5.2 will lose approximately 5.2% of its value for every 100 bps rise in yield. This is the <strong>first-order</strong> approximation — for large yield changes, convexity provides the second-order correction.</p>

      <h3>Spread Duration</h3>
      <p>Spread duration measures the sensitivity of price to changes in the credit spread (OAS or Z-spread), holding the risk-free curve constant:</p>
      <div class="formula">
        &Delta;P/P &asymp; &minus;D<sub>Spread</sub> &times; &Delta;OAS
      </div>
      <p>For bullet bonds, spread duration is numerically very close to modified duration. However, for callable bonds or bonds with significant optionality, spread duration and modified duration can differ materially because a spread change does not trigger the same option behavior as a parallel rate shift.</p>

      <h3>DV01 (Dollar Value of 01)</h3>
      <p>DV01 measures the dollar price change for a 1 basis point yield change:</p>
      <div class="formula">
        DV01 = D<sub>Mod</sub> &times; Price &times; 0.0001
      </div>
      <p>For a $1,000 bond with modified duration 6.5 and price $980: DV01 = 6.5 &times; 980 &times; 0.0001 = $0.637. This is the standard risk metric for fixed income trading desks.</p>

      <h3>Convexity</h3>
      <p>Convexity is the second derivative of price with respect to yield, measuring the curvature of the price-yield relationship:</p>
      <div class="formula">
        &Delta;P/P &asymp; &minus;D<sub>Mod</sub> &times; &Delta;y + &frac12; &times; Convexity &times; (&Delta;y)<sup>2</sup>
      </div>
      <p>Positive convexity is favorable: the bond gains more when yields fall than it loses when yields rise by the same amount. Long-maturity and low-coupon bonds have higher convexity.</p>

      <h3>Key Rate Duration</h3>
      <p>Key rate duration (KRD) decomposes interest rate sensitivity by tenor bucket (e.g., 2Y, 5Y, 10Y, 30Y). This is critical for:</p>
      <ul>
        <li>Understanding <strong>curve risk</strong> — how a portfolio responds to non-parallel shifts</li>
        <li>Immunization strategies that target specific points on the curve</li>
        <li>Relative value trades exploiting steepening/flattening expectations</li>
      </ul>
      <p>The sum of all key rate durations equals the total effective (modified) duration.</p>

      <div class="callout insight">
        <div class="callout-title">Portfolio Management Application</div>
        <p>Credit portfolio managers care about both <em>rate duration</em> (sensitivity to Treasury curve moves) and <em>spread duration</em> (sensitivity to credit spread moves). In a risk-off environment, Treasuries rally (rate duration helps) but spreads widen (spread duration hurts). The net effect depends on the correlation structure and the relative magnitude of rate vs. spread moves.</p>
      </div>

      <div class="callout warning">
        <div class="callout-title">Common Pitfall</div>
        <p>Do not confuse the modified duration of a portfolio with a simple weighted-average of individual bond durations. The correct calculation uses market-value weights: D<sub>portfolio</sub> = &Sigma; w<sub>i</sub> &times; D<sub>i</sub>, where w<sub>i</sub> is the market value of bond i divided by total portfolio market value.</p>
      </div>
    `,
    example: {
      title: '3-Bond Portfolio Duration & Convexity Analysis',
      given: `
        <ul>
          <li><strong>Bond A:</strong> 3-year, 4.00% coupon, YTM = 4.80%, $1,000,000 face</li>
          <li><strong>Bond B:</strong> 7-year, 5.50% coupon, YTM = 5.90%, $1,000,000 face</li>
          <li><strong>Bond C:</strong> 15-year, 6.00% coupon, YTM = 6.50%, $1,000,000 face</li>
          <li>Equal face value weighting ($1M each, $3M total face)</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>All bonds are bullet (no embedded options), semiannual coupons</li>
          <li>Spread duration ≈ modified duration for bullets</li>
          <li>Portfolio weights are by market value, not face value</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Price Each Bond</h4>
        <table class="data-table">
          <tr><th>Bond</th><th>Coupon</th><th>Maturity</th><th>YTM</th><th>Price (per $1,000)</th><th>Market Value</th></tr>
          <tr><td>A</td><td>4.00%</td><td>3Y</td><td>4.80%</td><td>$977.84</td><td>$977,840</td></tr>
          <tr><td>B</td><td>5.50%</td><td>7Y</td><td>5.90%</td><td>$977.45</td><td>$977,450</td></tr>
          <tr><td>C</td><td>6.00%</td><td>15Y</td><td>6.50%</td><td>$951.49</td><td>$951,490</td></tr>
        </table>
        <p>Total portfolio market value: <strong>$2,906,780</strong></p>

        <h4>Step 2: Compute Duration and Convexity for Each Bond</h4>
        <table class="data-table">
          <tr><th>Bond</th><th>Mac. Duration</th><th>Mod. Duration</th><th>Spread Duration</th><th>DV01 (per $1M face)</th><th>Convexity</th></tr>
          <tr><td>A (3Y)</td><td>2.81</td><td>2.74</td><td>2.74</td><td>$268</td><td>9.2</td></tr>
          <tr><td>B (7Y)</td><td>5.94</td><td>5.77</td><td>5.77</td><td>$564</td><td>39.4</td></tr>
          <tr><td>C (15Y)</td><td>10.04</td><td>9.72</td><td>9.72</td><td>$925</td><td>123.7</td></tr>
        </table>

        <h4>Step 3: Compute Market Value Weights</h4>
        <table class="data-table">
          <tr><th>Bond</th><th>Market Value</th><th>Weight</th></tr>
          <tr><td>A</td><td>$977,840</td><td>33.64%</td></tr>
          <tr><td>B</td><td>$977,450</td><td>33.62%</td></tr>
          <tr><td>C</td><td>$951,490</td><td>32.73%</td></tr>
        </table>

        <h4>Step 4: Compute Portfolio Duration</h4>
        <div class="formula">
          D<sub>portfolio</sub> = 0.3364 &times; 2.74 + 0.3362 &times; 5.77 + 0.3273 &times; 9.72 = 0.921 + 1.940 + 3.182 = <strong>6.04</strong>
        </div>

        <h4>Step 5: Compute Portfolio Spread Duration and DV01</h4>
        <div class="formula">
          SD<sub>portfolio</sub> = 0.3364 &times; 2.74 + 0.3362 &times; 5.77 + 0.3273 &times; 9.72 = <strong>6.04</strong>
        </div>
        <p>Portfolio DV01 = 6.04 &times; $2,906,780 &times; 0.0001 = <strong>$1,755</strong> per basis point</p>

        <h4>Step 6: Compute Portfolio Convexity</h4>
        <div class="formula">
          Convexity<sub>portfolio</sub> = 0.3364 &times; 9.2 + 0.3362 &times; 39.4 + 0.3273 &times; 123.7 = 3.09 + 13.24 + 40.49 = <strong>56.8</strong>
        </div>
      `,
      result: `
        <table class="data-table">
          <tr><th>Metric</th><th>Bond A (3Y)</th><th>Bond B (7Y)</th><th>Bond C (15Y)</th><th>Portfolio</th></tr>
          <tr><td>Modified Duration</td><td>2.74</td><td>5.77</td><td>9.72</td><td><strong>6.04</strong></td></tr>
          <tr><td>Spread Duration</td><td>2.74</td><td>5.77</td><td>9.72</td><td><strong>6.04</strong></td></tr>
          <tr><td>DV01</td><td>$268</td><td>$564</td><td>$925</td><td><strong>$1,755</strong></td></tr>
          <tr><td>Convexity</td><td>9.2</td><td>39.4</td><td>123.7</td><td><strong>56.8</strong></td></tr>
        </table>
      `,
      interpretation: `
        <p>The portfolio has a modified duration of 6.04 years, meaning a 100 bps parallel rise in yields would cause approximately a 6.04% decline in market value (~$175,500). Bond C contributes over half of the portfolio's DV01 despite being only one-third of the portfolio by face value, highlighting the non-linear relationship between maturity and interest rate risk.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>The portfolio convexity of 56.8 provides a favorable asymmetry: for a 100 bps move in either direction, the convexity adjustment is +½ × 56.8 × (0.01)² = +0.28%. This means the actual price loss for a 100 bps rise is ~5.76% (less than duration alone predicts) and the gain for a 100 bps fall is ~6.32% (more than duration alone predicts). Higher convexity is always desirable, all else equal.</p>
        </div>
      `
    },
    calcId: 'duration-convexity-calc',
    calcTitle: 'Duration & Convexity Calculator',
    calcFields: [
      { id: 'couponRate', label: 'Coupon Rate (%)', type: 'number', default: 5.5, step: 0.125, min: 0, max: 15 },
      { id: 'maturity', label: 'Maturity (years)', type: 'number', default: 7, step: 0.5, min: 0.5, max: 50 },
      { id: 'faceValue', label: 'Face Value ($)', type: 'number', default: 1000, step: 100, min: 100, max: 1000000 },
      { id: 'ytm', label: 'Yield to Maturity (%)', type: 'number', default: 5.9, step: 0.05, min: 0.01, max: 25 }
    ],
    calcPreset: { name: 'Example: 7Y 5.50% Bond at 5.90% YTM', values: { couponRate: 5.5, maturity: 7, faceValue: 1000, ytm: 5.9 } },
    calcCompute: function(vals) {
      var coupon = vals.couponRate;
      var mat = vals.maturity;
      var face = vals.faceValue;
      var ytm = vals.ytm;

      var price = BondMath.priceFromYTM(coupon, mat, face, ytm, 2);
      var macDur = BondMath.macaulayDuration(coupon, mat, face, ytm, 2);
      var modDur = BondMath.modifiedDuration(coupon, mat, face, ytm, 2);
      var sprDur = BondMath.spreadDuration(coupon, mat, face, ytm, 2);
      var dv01 = BondMath.dv01(coupon, mat, face, ytm, 2);
      var cvx = BondMath.convexity(coupon, mat, face, ytm, 2);

      return [
        { label: 'Bond Price', value: '$' + price.toFixed(4), unit: '' },
        { label: 'Macaulay Duration', value: macDur.toFixed(4), unit: 'years' },
        { label: 'Modified Duration', value: modDur.toFixed(4), unit: 'years' },
        { label: 'Spread Duration', value: sprDur.toFixed(4), unit: 'years' },
        { label: 'DV01', value: '$' + dv01.toFixed(4), unit: '' },
        { label: 'Convexity', value: cvx.toFixed(2), unit: '' },
        { label: 'Price Change per +100bp', value: ((-modDur * 0.01 + 0.5 * cvx * 0.0001) * 100).toFixed(3), unit: '%' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 350, { top: 30, right: 30, bottom: 50, left: 70 });

      // Compute durations for each bond + portfolio
      var bonds = [
        { label: 'Bond A\n(3Y 4%)', coupon: 4, mat: 3, ytm: 4.8 },
        { label: 'Bond B\n(7Y 5.5%)', coupon: 5.5, mat: 7, ytm: 5.9 },
        { label: 'Bond C\n(15Y 6%)', coupon: 6, mat: 15, ytm: 6.5 }
      ];

      var modDurs = [];
      var sprDurs = [];
      for (var i = 0; i < bonds.length; i++) {
        var md = BondMath.modifiedDuration(bonds[i].coupon, bonds[i].mat, 1000, bonds[i].ytm, 2);
        var sd = BondMath.spreadDuration(bonds[i].coupon, bonds[i].mat, 1000, bonds[i].ytm, 2);
        modDurs.push(md);
        sprDurs.push(sd);
      }

      // Portfolio duration (approx equal weight)
      var portModDur = (modDurs[0] + modDurs[1] + modDurs[2]) / 3;
      var portSprDur = (sprDurs[0] + sprDurs[1] + sprDurs[2]) / 3;

      var maxDur = 12;
      var barWidth = 0.08;
      var labels = ['Bond A (3Y)', 'Bond B (7Y)', 'Bond C (15Y)', 'Portfolio'];
      var allModDurs = modDurs.concat([portModDur]);
      var allSprDurs = sprDurs.concat([portSprDur]);

      var xTicks = [];
      for (var j = 0; j < labels.length; j++) {
        xTicks.push({ pos: (j + 0.5) / labels.length, label: labels[j] });
      }
      var yTicks = [];
      for (var d = 0; d <= maxDur; d += 2) {
        yTicks.push({ pos: d / maxDur, label: d.toFixed(0) });
      }

      Chart.drawAxes(ctx, xTicks, yTicks, '', 'Duration (years)');

      // Draw bars manually for grouped bar chart
      for (var k = 0; k < labels.length; k++) {
        var centerX = (k + 0.5) / labels.length;
        var modBarX = ctx.p.left + (centerX - barWidth) * ctx.iw;
        var sprBarX = ctx.p.left + (centerX + 0.005) * ctx.iw;
        var modH = (allModDurs[k] / maxDur) * ctx.ih;
        var sprH = (allSprDurs[k] / maxDur) * ctx.ih;
        var bw = barWidth * ctx.iw * 0.9;

        var modBar = Chart.el('rect', {
          x: modBarX,
          y: ctx.p.top + ctx.ih - modH,
          width: bw,
          height: modH,
          fill: k === 3 ? '#2b7a3a' : '#2b402f',
          rx: 2
        });
        ctx.svg.appendChild(modBar);

        var sprBar = Chart.el('rect', {
          x: sprBarX,
          y: ctx.p.top + ctx.ih - sprH,
          width: bw,
          height: sprH,
          fill: k === 3 ? '#8ab590' : '#5a8c62',
          opacity: 0.85,
          rx: 2
        });
        ctx.svg.appendChild(sprBar);

        // Value label on modified duration bar
        var valLabel = Chart.el('text', {
          x: modBarX + bw / 2,
          y: ctx.p.top + ctx.ih - modH - 5,
          fill: '#1a1414',
          'font-size': '11px',
          'text-anchor': 'middle',
          'font-weight': 'bold'
        });
        valLabel.textContent = allModDurs[k].toFixed(1);
        ctx.svg.appendChild(valLabel);
      }

      Chart.legend(ctx, [
        { label: 'Modified Duration', color: '#2b402f' },
        { label: 'Spread Duration', color: '#5a8c62' },
        { label: 'Portfolio (Mod. Dur.)', color: '#2b7a3a' }
      ], ctx.p.left + 10, 12);

      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A bond has a modified duration of 7.2 and convexity of 68. If yields rise by 150 bps, what is the approximate percentage price change?',
        options: [
          '-10.80%',
          '-10.04%',
          '-7.20%',
          '-11.57%'
        ],
        correct: 1,
        explanation: 'ΔP/P ≈ -D_mod × Δy + ½ × Convexity × (Δy)². = -7.2 × 0.015 + ½ × 68 × (0.015)² = -0.1080 + 0.00765 = -0.10035 = -10.04%. The convexity term provides a 0.77% cushion against the 10.80% loss predicted by duration alone. This convexity benefit is meaningful for large yield moves.'
      },
      {
        q: 'A portfolio manager wants to reduce portfolio duration from 6.5 to 4.0 years. The portfolio has $100M market value. How much DV01 reduction is needed?',
        options: [
          '$25,000 per basis point',
          '$2,500 per basis point',
          '$10,000 per basis point',
          '$65,000 per basis point'
        ],
        correct: 0,
        explanation: 'DV01 = Duration × Market Value × 0.0001. Current DV01 = 6.5 × $100M × 0.0001 = $65,000/bp. Target DV01 = 4.0 × $100M × 0.0001 = $40,000/bp. Required reduction = $65,000 - $40,000 = $25,000 per basis point. Equivalently, ΔDV01 = ΔDuration × MV × 0.0001 = 2.5 × $100M × 0.0001 = $25,000/bp.'
      },
      {
        q: 'Why might a callable bond\'s spread duration differ significantly from its modified duration?',
        options: [
          'Because spread duration ignores convexity effects',
          'Because a spread change does not affect the probability of call exercise the same way a rate change does',
          'Because spread duration is always longer than modified duration',
          'Because callable bonds do not have meaningful duration measures'
        ],
        correct: 1,
        explanation: 'For callable bonds, a parallel shift in the Treasury curve changes both the discount rate and the likelihood that the issuer will call the bond (refinancing incentive). A spread change only affects the discount rate without changing the rate-driven call decision. Therefore, spread duration isolates the pure discounting effect while modified (effective) duration captures the combined effect of discounting and option exercise probability changes.'
      },
      {
        q: 'Two portfolios have the same modified duration of 5.0. Portfolio X has convexity of 30, and Portfolio Y has convexity of 80. Which portfolio is more attractive, all else equal?',
        options: [
          'Portfolio X, because lower convexity means less risk',
          'Portfolio Y, because higher positive convexity provides a more favorable price response to yield changes',
          'They are equivalent because duration is the same',
          'Cannot determine without knowing the portfolio compositions'
        ],
        correct: 1,
        explanation: 'Higher positive convexity is always desirable for a long-only investor, all else equal. Portfolio Y will outperform Portfolio X in both scenarios: when yields rise (Y loses less) and when yields fall (Y gains more). The convexity advantage is proportional to the square of the yield change, so it is most valuable in volatile rate environments. In practice, higher convexity is "priced in" — investors pay a premium for it, meaning Portfolio Y likely has a lower yield.'
      },
      {
        q: 'A bond has key rate durations of: 2Y = 0.3, 5Y = 1.8, 10Y = 3.5, 30Y = 0.2. The yield curve steepens with 2Y down 25 bps and 10Y up 25 bps. What is the approximate price impact?',
        options: [
          '-0.80%',
          '+0.80%',
          '-0.95%',
          '-0.50%'
        ],
        correct: 0,
        explanation: 'Price impact = Σ(-KRD_i × Δy_i). = -0.3 × (-0.0025) + -1.8 × 0 + -3.5 × (0.0025) + -0.2 × 0 = +0.00075 - 0.00875 = -0.0080 = -0.80%. The bond loses value because its largest KRD exposure is at the 10Y point where yields rose. The favorable 2Y move has limited impact due to low KRD at that bucket. This demonstrates why KRD analysis is essential for curve risk management.'
      }
    ]
  },
  {
    id: 'section-5',
    number: 5,
    title: 'Yield Curve & Spread Curve Exposures',
    subtopics: ['Curve positioning', 'Bullet vs barbell vs ladder'],
    lesson: `
      <h3>Key Rate Duration and Curve Risk</h3>
      <p>Total modified duration measures sensitivity to parallel yield curve shifts — a simplification that rarely occurs in reality. Yield curves twist, steepen, flatten, and shift in complex ways. <strong>Key rate duration (KRD)</strong> decomposition allows us to understand how a portfolio responds to non-parallel moves.</p>
      <p>Standard KRD buckets typically include 6M, 1Y, 2Y, 3Y, 5Y, 7Y, 10Y, 20Y, and 30Y maturities. The KRD at each bucket represents the price sensitivity to a 1 bp shift at that specific maturity point, holding all others constant.</p>
      <div class="formula">
        &Delta;P/P &asymp; &minus;&Sigma;<sub>k</sub> KRD<sub>k</sub> &times; &Delta;y<sub>k</sub>
      </div>
      <p>The sum of all key rate durations equals total effective duration.</p>

      <h3>Curve Strategies: Bullet, Barbell, and Ladder</h3>
      <p>Three classic portfolio construction approaches generate very different curve exposures:</p>

      <table class="data-table">
        <tr><th>Strategy</th><th>Description</th><th>KRD Profile</th><th>Favored Environment</th></tr>
        <tr><td><strong>Bullet</strong></td><td>Concentrated around a single maturity</td><td>KRD concentrated at one point</td><td>Stable curve, carry optimization</td></tr>
        <tr><td><strong>Barbell</strong></td><td>Split between short and long maturities</td><td>KRD at two distant points</td><td>Curve flattening, higher convexity needed</td></tr>
        <tr><td><strong>Ladder</strong></td><td>Evenly distributed across maturities</td><td>KRD spread evenly</td><td>Uncertain curve outlook, reinvestment smoothing</td></tr>
      </table>

      <h3>Bullet vs. Barbell: The Classic Trade-Off</h3>
      <p>A bullet and barbell can be constructed to have the <em>same total duration</em>, but they respond very differently to curve changes:</p>
      <ul>
        <li><strong>Parallel shift:</strong> Approximately the same impact (by construction, since durations match)</li>
        <li><strong>Curve steepening:</strong> The barbell underperforms because its long-end position loses more than the short-end gains (KRD-weighted impact)</li>
        <li><strong>Curve flattening:</strong> The barbell outperforms for the opposite reason</li>
        <li><strong>Convexity:</strong> The barbell has <em>higher convexity</em> than the bullet at the same duration, providing a structural advantage in volatile environments</li>
      </ul>

      <div class="callout insight">
        <div class="callout-title">The Convexity-Curve Trade-Off</div>
        <p>The barbell's convexity advantage is not free — it typically costs yield (lower portfolio yield than the bullet) due to the negative carry of the short-end allocation and the lower roll-down of the long-end. In carry-dominated environments with stable curves, the bullet wins. In volatile environments with curve flattening risk, the barbell wins.</p>
      </div>

      <h3>Spread Curve Exposures</h3>
      <p>Beyond the risk-free curve, corporate portfolios have exposures to the <strong>credit spread curve</strong> — the term structure of OAS/Z-spreads. Spread curves are typically upward-sloping (longer maturities have wider spreads), but they can invert during stress.</p>
      <p>Spread curve KRD is analogous to rate curve KRD but measures sensitivity to spread changes at each tenor. A portfolio's P&L attribution should decompose into:</p>
      <div class="formula">
        &Delta;P = &minus;&Sigma;<sub>k</sub> KRD<sub>k</sub><sup>rate</sup> &times; &Delta;Treasury<sub>k</sub> &minus;&Sigma;<sub>k</sub> KRD<sub>k</sub><sup>spread</sup> &times; &Delta;Spread<sub>k</sub>
      </div>

      <div class="callout warning">
        <div class="callout-title">Correlation Matters</div>
        <p>In risk-off events, Treasury rates typically fall (helping rate-duration-long portfolios) while credit spreads widen (hurting spread-duration-long portfolios). The net effect depends on the correlation between rate and spread moves, which can be highly unstable. During the 2008 crisis, rate and spread correlations flipped dramatically over weeks.</p>
      </div>

      <h3>Practical Curve Positioning</h3>
      <p>Portfolio managers express curve views by:</p>
      <ul>
        <li><strong>Overweighting/underweighting KRD buckets</strong> relative to benchmark</li>
        <li><strong>Flattener/steepener trades:</strong> Long the outperforming end, short the underperforming end</li>
        <li><strong>Butterfly trades:</strong> Long wings (short+long) vs. short belly, or vice versa</li>
        <li><strong>Roll-down optimization:</strong> Positioning on the steepest part of the curve to benefit from yield roll-down as bonds age</li>
      </ul>
    `,
    example: {
      title: 'Bullet vs. Barbell Under Curve Steepening',
      given: `
        <ul>
          <li><strong>Portfolio A (Bullet):</strong> 100% in 7-year bond, 5.50% coupon, YTM 5.90%</li>
          <li><strong>Portfolio B (Barbell):</strong> 50% in 2-year bond (3.80% coupon, YTM 4.10%) + 50% in 15-year bond (6.00% coupon, YTM 6.50%)</li>
          <li>Both portfolios have $10 million market value</li>
          <li><strong>Curve scenario:</strong> 2Y yield unchanged, 10Y+ yields up 50 bps (bear steepening)</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>All bonds are bullet, semiannual coupon, no embedded options</li>
          <li>Portfolio B: equal market value weights (50/50)</li>
          <li>7Y yield shifts up by approximately 30 bps (interpolated between 2Y flat and 10Y +50bp)</li>
          <li>15Y yield shifts up by full 50 bps</li>
          <li>Only first-order (duration) effects computed for simplicity</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Compute Individual Bond Durations</h4>
        <table class="data-table">
          <tr><th>Bond</th><th>Maturity</th><th>Modified Duration</th><th>Convexity</th></tr>
          <tr><td>7Y Bond (Bullet A)</td><td>7Y</td><td>5.77</td><td>39.4</td></tr>
          <tr><td>2Y Bond (Barbell short end)</td><td>2Y</td><td>1.90</td><td>5.0</td></tr>
          <tr><td>15Y Bond (Barbell long end)</td><td>15Y</td><td>9.72</td><td>123.7</td></tr>
        </table>

        <h4>Step 2: Compute Portfolio Durations</h4>
        <p><strong>Portfolio A (Bullet):</strong> Duration = 5.77, Convexity = 39.4</p>
        <p><strong>Portfolio B (Barbell):</strong> Duration = 0.50 &times; 1.90 + 0.50 &times; 9.72 = <strong>5.81</strong>, Convexity = 0.50 &times; 5.0 + 0.50 &times; 123.7 = <strong>64.4</strong></p>
        <p>Both portfolios have approximately the same total duration (~5.8), but the barbell has significantly higher convexity (64.4 vs. 39.4).</p>

        <h4>Step 3: Apply the Curve Steepening Scenario</h4>
        <p><strong>Portfolio A (Bullet at 7Y):</strong></p>
        <div class="formula">
          &Delta;P<sub>A</sub>/P<sub>A</sub> &asymp; &minus;5.77 &times; 0.0030 = &minus;1.73%
        </div>
        <p>P&L = &minus;1.73% &times; $10,000,000 = <strong>&minus;$173,100</strong></p>

        <p><strong>Portfolio B (Barbell: 2Y + 15Y):</strong></p>
        <p>2Y Bond: &Delta;y = 0 bps → &Delta;P = 0</p>
        <p>15Y Bond: &Delta;y = +50 bps</p>
        <div class="formula">
          &Delta;P<sub>15Y</sub>/P<sub>15Y</sub> &asymp; &minus;9.72 &times; 0.0050 = &minus;4.86%
        </div>
        <p>Portfolio B P&L = 0.50 &times; 0% + 0.50 &times; (&minus;4.86%) = <strong>&minus;2.43%</strong></p>
        <p>P&L = &minus;2.43% &times; $10,000,000 = <strong>&minus;$243,000</strong></p>

        <h4>Step 4: Compare Results</h4>
        <table class="data-table">
          <tr><th>Portfolio</th><th>Duration</th><th>Convexity</th><th>P&L ($)</th><th>P&L (%)</th></tr>
          <tr><td>A (Bullet 7Y)</td><td>5.77</td><td>39.4</td><td class="text-red">&minus;$173,100</td><td class="text-red">&minus;1.73%</td></tr>
          <tr><td>B (Barbell 2Y+15Y)</td><td>5.81</td><td>64.4</td><td class="text-red">&minus;$243,000</td><td class="text-red">&minus;2.43%</td></tr>
          <tr><td colspan="3"><strong>Barbell Underperformance</strong></td><td class="text-red">&minus;$69,900</td><td class="text-red">&minus;0.70%</td></tr>
        </table>
      `,
      result: `
        <table class="data-table">
          <tr><th>Metric</th><th>Bullet (A)</th><th>Barbell (B)</th><th>Difference</th></tr>
          <tr><td>Total Duration</td><td>5.77</td><td>5.81</td><td>+0.04</td></tr>
          <tr><td>Convexity</td><td>39.4</td><td>64.4</td><td>+25.0</td></tr>
          <tr><td>P&L (Steepening)</td><td>&minus;$173,100</td><td>&minus;$243,000</td><td class="text-red">&minus;$69,900</td></tr>
        </table>
      `,
      interpretation: `
        <p>Despite having the same total duration, the barbell <strong>underperforms the bullet by $69,900</strong> (70 bps) under bear steepening. The barbell's 15Y allocation takes the full 50 bps hit, while its 2Y allocation provides no offset (2Y unchanged). The bullet, positioned at the 7Y midpoint, only absorbs a 30 bps move.</p>
        <p>However, the barbell's higher convexity (64.4 vs. 39.4) means it would outperform in a <strong>parallel shift</strong> of equal magnitude, and it would significantly outperform in a <strong>curve flattening</strong> scenario. The choice between bullet and barbell is fundamentally a bet on curve shape changes.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>This example illustrates why total portfolio duration is insufficient for risk management. Two portfolios with identical duration can have vastly different P&L outcomes depending on <em>how</em> the curve moves. Key rate duration decomposition and scenario analysis are essential tools for understanding curve risk exposures.</p>
        </div>
      `
    },
    calcId: 'curve-exposure-calc',
    calcTitle: 'Curve Exposure Analyzer',
    calcFields: [
      { id: 'coupon1', label: 'Bond 1 Coupon (%)', type: 'number', default: 3.80, step: 0.125, min: 0, max: 15 },
      { id: 'maturity1', label: 'Bond 1 Maturity (years)', type: 'number', default: 2, step: 0.5, min: 0.5, max: 50 },
      { id: 'ytm1', label: 'Bond 1 YTM (%)', type: 'number', default: 4.10, step: 0.05, min: 0.01, max: 25 },
      { id: 'weight1', label: 'Bond 1 Weight (%)', type: 'number', default: 33.3, step: 1, min: 0, max: 100 },
      { id: 'coupon2', label: 'Bond 2 Coupon (%)', type: 'number', default: 5.50, step: 0.125, min: 0, max: 15 },
      { id: 'maturity2', label: 'Bond 2 Maturity (years)', type: 'number', default: 7, step: 0.5, min: 0.5, max: 50 },
      { id: 'ytm2', label: 'Bond 2 YTM (%)', type: 'number', default: 5.90, step: 0.05, min: 0.01, max: 25 },
      { id: 'weight2', label: 'Bond 2 Weight (%)', type: 'number', default: 33.3, step: 1, min: 0, max: 100 },
      { id: 'coupon3', label: 'Bond 3 Coupon (%)', type: 'number', default: 6.00, step: 0.125, min: 0, max: 15 },
      { id: 'maturity3', label: 'Bond 3 Maturity (years)', type: 'number', default: 15, step: 0.5, min: 0.5, max: 50 },
      { id: 'ytm3', label: 'Bond 3 YTM (%)', type: 'number', default: 6.50, step: 0.05, min: 0.01, max: 25 },
      { id: 'weight3', label: 'Bond 3 Weight (%)', type: 'number', default: 33.4, step: 1, min: 0, max: 100 }
    ],
    calcPreset: { name: 'Example: Equal-Weighted Ladder', values: { coupon1: 3.80, maturity1: 2, ytm1: 4.10, weight1: 33.3, coupon2: 5.50, maturity2: 7, ytm2: 5.90, weight2: 33.3, coupon3: 6.00, maturity3: 15, ytm3: 6.50, weight3: 33.4 } },
    calcCompute: function(vals) {
      var bonds = [
        { c: vals.coupon1, m: vals.maturity1, y: vals.ytm1, w: vals.weight1 / 100 },
        { c: vals.coupon2, m: vals.maturity2, y: vals.ytm2, w: vals.weight2 / 100 },
        { c: vals.coupon3, m: vals.maturity3, y: vals.ytm3, w: vals.weight3 / 100 }
      ];

      var results = [];
      var totalDur = 0;
      var totalCvx = 0;
      var totalDV01 = 0;

      for (var i = 0; i < bonds.length; i++) {
        var b = bonds[i];
        if (b.w <= 0) continue;
        var price = BondMath.priceFromYTM(b.c, b.m, 1000, b.y, 2);
        var md = BondMath.modifiedDuration(b.c, b.m, 1000, b.y, 2);
        var cvx = BondMath.convexity(b.c, b.m, 1000, b.y, 2);
        var dv = BondMath.dv01(b.c, b.m, 1000, b.y, 2);
        totalDur += b.w * md;
        totalCvx += b.w * cvx;
        totalDV01 += b.w * dv;

        results.push({ label: 'Bond ' + (i + 1) + ' Mod. Duration', value: md.toFixed(3), unit: 'yrs' });
        results.push({ label: 'Bond ' + (i + 1) + ' Convexity', value: cvx.toFixed(1), unit: '' });
      }

      results.push({ label: 'Portfolio Duration', value: totalDur.toFixed(3), unit: 'yrs' });
      results.push({ label: 'Portfolio Convexity', value: totalCvx.toFixed(1), unit: '' });
      results.push({ label: 'Portfolio DV01 (per $1K)', value: '$' + totalDV01.toFixed(4), unit: '' });

      // Scenario: parallel +100bp
      var parallelPL = (-totalDur * 0.01 + 0.5 * totalCvx * 0.0001) * 100;
      results.push({ label: 'P&L: Parallel +100bp', value: parallelPL.toFixed(3), unit: '%' });

      // Scenario: steepening (short flat, long +50bp)
      var steepPL = 0;
      for (var j = 0; j < bonds.length; j++) {
        var bj = bonds[j];
        if (bj.w <= 0) continue;
        var mdj = BondMath.modifiedDuration(bj.c, bj.m, 1000, bj.y, 2);
        // Interpolate: 0 at 2Y, +50bp at 10Y+, linear between
        var shift = Math.max(0, Math.min(0.005, (bj.m - 2) / (10 - 2) * 0.005));
        steepPL += bj.w * (-mdj * shift) * 100;
      }
      results.push({ label: 'P&L: Steepening +50bp@10Y', value: steepPL.toFixed(3), unit: '%' });

      return results;
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 400, { top: 40, right: 40, bottom: 60, left: 70 });

      // Draw a yield curve with before and after
      var maturities = [0.5, 1, 2, 3, 5, 7, 10, 15, 20, 30];
      var baseRates = [3.50, 3.60, 3.80, 3.95, 4.20, 4.40, 4.55, 4.70, 4.80, 4.90];
      // Steepening scenario: short end flat, long end +50bp
      var steepRates = [];
      for (var i = 0; i < maturities.length; i++) {
        var shift = Math.max(0, Math.min(0.50, (maturities[i] - 2) / (10 - 2) * 0.50));
        steepRates.push(baseRates[i] + shift);
      }

      var maxMat = 30;
      var minRate = 3.0;
      var maxRate = 6.0;
      var rateRange = maxRate - minRate;

      var baseLine = [];
      var steepLine = [];
      for (var j = 0; j < maturities.length; j++) {
        var xPos = maturities[j] / maxMat;
        baseLine.push({ x: xPos, y: (baseRates[j] - minRate) / rateRange });
        steepLine.push({ x: xPos, y: (steepRates[j] - minRate) / rateRange });
      }

      var xTicks = [];
      var matLabels = [1, 2, 5, 7, 10, 15, 20, 30];
      for (var k = 0; k < matLabels.length; k++) {
        xTicks.push({ pos: matLabels[k] / maxMat, label: matLabels[k] + 'Y' });
      }
      var yTicks = [];
      for (var r = minRate; r <= maxRate; r += 0.5) {
        yTicks.push({ pos: (r - minRate) / rateRange, label: r.toFixed(1) + '%' });
      }

      Chart.drawAxes(ctx, xTicks, yTicks, 'Maturity', 'Yield (%)');

      // Area between curves to show the spread widening
      var areaData = [];
      for (var a = 0; a < baseLine.length; a++) {
        areaData.push({ x: baseLine[a].x, y: steepLine[a].y });
      }
      Chart.areaPlot(ctx, baseLine, 'rgba(59,130,246,0.08)');

      Chart.linePlot(ctx, baseLine, '#2b402f', 2.5);
      Chart.linePlot(ctx, steepLine, '#c4453a', 2.5);

      // Bond position markers
      var bondPositions = [
        { mat: 2, label: '2Y Bond', color: '#2b7a3a' },
        { mat: 7, label: '7Y Bullet', color: '#5a8c62' },
        { mat: 15, label: '15Y Bond', color: '#8a6d5e' }
      ];

      for (var b = 0; b < bondPositions.length; b++) {
        var bp = bondPositions[b];
        var bx = bp.mat / maxMat;
        // Find the base rate at this maturity (interpolate)
        var baseRate = 0;
        for (var m = 0; m < maturities.length - 1; m++) {
          if (bp.mat >= maturities[m] && bp.mat <= maturities[m + 1]) {
            var frac = (bp.mat - maturities[m]) / (maturities[m + 1] - maturities[m]);
            baseRate = baseRates[m] + frac * (baseRates[m + 1] - baseRates[m]);
            break;
          }
        }
        var by = (baseRate - minRate) / rateRange;

        var marker = Chart.el('circle', {
          cx: ctx.p.left + bx * ctx.iw,
          cy: ctx.p.top + ctx.ih - by * ctx.ih,
          r: 7,
          fill: bp.color,
          stroke: '#fff',
          'stroke-width': 2
        });
        ctx.svg.appendChild(marker);

        var mLabel = Chart.el('text', {
          x: ctx.p.left + bx * ctx.iw,
          y: ctx.p.top + ctx.ih - by * ctx.ih - 14,
          fill: bp.color,
          'font-size': '11px',
          'font-weight': 'bold',
          'text-anchor': 'middle'
        });
        mLabel.textContent = bp.label;
        ctx.svg.appendChild(mLabel);
      }

      // Annotate the steepening
      var arrowX = ctx.p.left + (10 / maxMat) * ctx.iw + 30;
      var arrowY1 = ctx.p.top + ctx.ih - ((4.55 - minRate) / rateRange) * ctx.ih;
      var arrowY2 = ctx.p.top + ctx.ih - ((5.05 - minRate) / rateRange) * ctx.ih;
      var arrow = Chart.el('line', {
        x1: arrowX, y1: arrowY1,
        x2: arrowX, y2: arrowY2,
        stroke: '#c4453a',
        'stroke-width': 2,
        'marker-end': 'none'
      });
      ctx.svg.appendChild(arrow);
      var arrowLabel = Chart.el('text', {
        x: arrowX + 8,
        y: (arrowY1 + arrowY2) / 2 + 4,
        fill: '#c4453a',
        'font-size': '11px'
      });
      arrowLabel.textContent = '+50bp';
      ctx.svg.appendChild(arrowLabel);

      Chart.legend(ctx, [
        { label: 'Current Curve', color: '#2b402f' },
        { label: 'After Steepening', color: '#c4453a' },
        { label: '2Y Bond', color: '#2b7a3a' },
        { label: '7Y Bullet', color: '#5a8c62' },
        { label: '15Y Bond', color: '#8a6d5e' }
      ], ctx.p.left + 10, 12);

      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A portfolio manager expects the yield curve to flatten. Which portfolio positioning would benefit most?',
        options: [
          'Bullet concentrated at the 5-year maturity',
          'Barbell with 2-year and 30-year bonds',
          'Ladder with equal exposure at 2Y, 5Y, 10Y, and 20Y',
          'Short duration across all maturities'
        ],
        correct: 1,
        explanation: 'A barbell benefits from curve flattening because the long-end yields fall more (or rise less) than the short-end. With KRD concentrated at the long end, the barbell captures the long-end rally. A bullet has all its KRD at one point and thus has minimal curve exposure, while a ladder has balanced exposure that mostly cancels out.'
      },
      {
        q: 'Two portfolios have identical total duration of 6.0 years. Portfolio X is a bullet at the 6-year point; Portfolio Y is a barbell (3-year + 12-year). Which has higher convexity?',
        options: [
          'Portfolio X (bullet), because concentrated maturity increases convexity',
          'Portfolio Y (barbell), because dispersion of cash flows around the duration point increases convexity',
          'Both have equal convexity since duration is the same',
          'Cannot determine without knowing coupon rates'
        ],
        correct: 1,
        explanation: 'Convexity increases with the dispersion (variance) of cash flow timing around the duration. The barbell has cash flows at 3Y and 12Y — far from the 6Y center — creating higher dispersion than the bullet\'s concentrated cash flows near 6Y. This is a mathematical property: for the same duration, greater maturity spread always produces higher convexity. This is why barbells are described as "convexity-rich" relative to bullets.'
      },
      {
        q: 'A ladder portfolio rebalanced quarterly invests equal amounts in 1Y, 3Y, 5Y, 7Y, and 10Y bonds. What is the primary advantage of this structure?',
        options: [
          'Maximum yield through concentration in high-yielding long bonds',
          'Highest convexity of any portfolio structure',
          'Steady reinvestment flow that reduces timing risk and provides liquidity at regular intervals',
          'Lowest possible duration for a given yield level'
        ],
        correct: 2,
        explanation: 'The ladder structure ensures that bonds mature at regular intervals, providing a predictable cash flow for reinvestment. This reduces reinvestment timing risk — the portfolio continuously reinvests across different rate environments rather than making large lump-sum reinvestments. It also provides natural liquidity without selling, making it ideal for portfolios with regular cash needs or uncertain rate outlooks.'
      },
      {
        q: 'In a bear steepening scenario (short rates stable, long rates rising), which portfolio structure suffers the most losses?',
        options: [
          'Short-duration bullet at the 2-year point',
          'Bullet at the 7-year point',
          'Barbell with 2-year and 20-year bonds',
          'Equal-weighted ladder from 1Y to 10Y'
        ],
        correct: 2,
        explanation: 'The barbell has significant KRD at the 20-year point where yields rise the most. While the 2-year allocation is unaffected, the 20-year allocation takes the full hit with a high modified duration (~12-14 years). The 7Y bullet takes a moderate hit (partial steepening). The 2Y bullet is largely unaffected. The ladder has distributed exposure and takes a moderate overall hit. The barbell\'s large long-end duration exposure makes it most vulnerable to steepening.'
      },
      {
        q: 'A portfolio manager wants to express a view that the 5Y-10Y segment of the credit spread curve will compress (flatten) while the overall spread level remains unchanged. What trade structure best expresses this view?',
        options: [
          'Buy 5Y corporate bonds, sell 10Y corporate bonds (duration-neutral)',
          'Buy 10Y corporate bonds, sell 5Y corporate bonds (duration-neutral)',
          'Buy 7Y corporate bonds outright',
          'Sell both 5Y and 10Y corporate bonds'
        ],
        correct: 1,
        explanation: 'If the 5Y-10Y spread curve flattens (compresses), 10Y spreads tighten more than 5Y spreads (or 10Y spreads tighten while 5Y widens). Buying 10Y bonds (which benefit from spread tightening) and selling 5Y bonds (which are hurt less or benefit from spread widening) captures this flattening. The trade should be duration-neutral to isolate the curve view from directional spread risk.'
      }
    ]
  },
  // ─── Section 6: Portfolio Construction Framework ───
  {
    id: 'section-6',
    number: 6,
    title: 'Portfolio Construction Framework',
    subtopics: ['Constraints', 'Diversification', 'Sector allocation', 'Rating buckets'],
    lesson: `
      <h3>Building a Corporate Bond Portfolio</h3>
      <p>Portfolio construction is the disciplined process of selecting and weighting bonds to achieve an investment objective while respecting a defined set of constraints. Unlike equity portfolios where stock-picking dominates, fixed-income portfolios are built around <strong>systematic risk factor exposures</strong>&mdash;duration, credit quality, sector, and liquidity.</p>

      <h4>Investment Policy Constraints</h4>
      <p>Every institutional portfolio operates under an Investment Policy Statement (IPS) that defines permissible boundaries:</p>
      <table class="data-table">
        <thead><tr><th>Constraint Type</th><th>Typical Range</th><th>Purpose</th></tr></thead>
        <tbody>
          <tr><td>Duration Band</td><td>&plusmn;1 year vs benchmark</td><td>Controls interest rate risk</td></tr>
          <tr><td>Minimum Rating</td><td>BBB&minus; or higher</td><td>Limits default risk for IG mandates</td></tr>
          <tr><td>Max Single Issuer</td><td>5&ndash;10%</td><td>Prevents concentration risk</td></tr>
          <tr><td>Max Sector</td><td>25&ndash;35%</td><td>Ensures diversification across industries</td></tr>
          <tr><td>Max Off-Benchmark</td><td>10&ndash;20%</td><td>Limits tracking error</td></tr>
        </tbody>
      </table>

      <div class="formula">Duration_{portfolio} = \\sum_{i=1}^{n} w_i \\times Duration_i</div>

      <h4>Sector Diversification</h4>
      <p>The investment-grade corporate bond universe is typically divided into major sectors:</p>
      <ul>
        <li><strong>Financials</strong> (Banks, Insurance, REITs) &mdash; ~30-35% of IG index</li>
        <li><strong>Industrials</strong> (Technology, Healthcare, Consumer) &mdash; ~45-50%</li>
        <li><strong>Utilities</strong> (Electric, Gas, Water) &mdash; ~10-12%</li>
        <li><strong>Energy</strong> (Exploration, Pipelines, Refining) &mdash; ~5-8%</li>
      </ul>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>Over-weighting a single sector creates <em>wrong-way risk</em>&mdash;when a sector shock hits, correlated names decline simultaneously. The 2008 crisis demonstrated this as portfolios heavy in Financials suffered outsized losses.</p>
      </div>

      <h4>Rating Bucket Allocation</h4>
      <p>Credit quality allocation drives the risk-return profile of the portfolio:</p>
      <table class="data-table">
        <thead><tr><th>Rating Bucket</th><th>Typical Spread Range</th><th>5Y Cumulative Default Rate</th></tr></thead>
        <tbody>
          <tr><td>AAA/AA</td><td>20&ndash;60 bps</td><td>&lt;0.2%</td></tr>
          <tr><td>A</td><td>50&ndash;120 bps</td><td>0.3&ndash;0.8%</td></tr>
          <tr><td>BBB</td><td>100&ndash;250 bps</td><td>1.0&ndash;3.0%</td></tr>
        </tbody>
      </table>

      <h4>Optimization Objective</h4>
      <p>The portfolio manager&rsquo;s goal is typically to <strong>maximize spread (carry) for a given risk budget</strong>. This involves:</p>
      <div class="formula">Maximize: \\sum w_i \\times Spread_i \\quad subject\\ to: \\sum w_i = 1,\\ Duration \\in [D_{min}, D_{max}],\\ w_i \\leq w_{max}</div>
      <p>In practice, optimization is iterative: select bonds that offer the best spread per unit of risk contribution, then verify all constraints are met.</p>

      <div class="callout definition">
        <div class="callout-title">Definition</div>
        <p><strong>Spread per unit of duration</strong> (spread efficiency) = OAS / Spread Duration. Higher values indicate more spread compensation per unit of spread risk taken.</p>
      </div>
    `,
    example: {
      title: 'Constructing a Constrained IG Portfolio',
      given: `
        <p>Build a portfolio from 8 candidate bonds with constraints:</p>
        <ul>
          <li>Portfolio duration: 5.0&ndash;7.0 years</li>
          <li>Minimum rating: BBB&minus;</li>
          <li>Maximum single issuer: 10%</li>
          <li>Minimum 3 sectors represented</li>
        </ul>
        <table class="data-table">
          <thead><tr><th>#</th><th>Issuer</th><th>Coupon</th><th>Maturity</th><th>YTM</th><th>Spread</th><th>Duration</th><th>Rating</th><th>Sector</th></tr></thead>
          <tbody>
            <tr><td>1</td><td>JPMorgan</td><td>5.25%</td><td>5Y</td><td>5.40%</td><td>95bp</td><td>4.3</td><td>A+</td><td>Financials</td></tr>
            <tr><td>2</td><td>Apple</td><td>4.50%</td><td>7Y</td><td>4.85%</td><td>55bp</td><td>6.1</td><td>AA+</td><td>Technology</td></tr>
            <tr><td>3</td><td>Verizon</td><td>5.75%</td><td>10Y</td><td>5.95%</td><td>145bp</td><td>7.5</td><td>BBB+</td><td>Telecom</td></tr>
            <tr><td>4</td><td>Duke Energy</td><td>5.00%</td><td>5Y</td><td>5.30%</td><td>85bp</td><td>4.4</td><td>A&minus;</td><td>Utilities</td></tr>
            <tr><td>5</td><td>Goldman Sachs</td><td>5.50%</td><td>7Y</td><td>5.80%</td><td>130bp</td><td>5.8</td><td>A</td><td>Financials</td></tr>
            <tr><td>6</td><td>CVS Health</td><td>5.85%</td><td>10Y</td><td>6.10%</td><td>160bp</td><td>7.2</td><td>BBB</td><td>Healthcare</td></tr>
            <tr><td>7</td><td>Microsoft</td><td>4.25%</td><td>5Y</td><td>4.60%</td><td>40bp</td><td>4.5</td><td>AAA</td><td>Technology</td></tr>
            <tr><td>8</td><td>NextEra</td><td>5.40%</td><td>7Y</td><td>5.65%</td><td>115bp</td><td>5.9</td><td>A&minus;</td><td>Utilities</td></tr>
          </tbody>
        </table>
      `,
      assumptions: `
        <ul>
          <li>All bonds are investment grade&mdash;constraint satisfied</li>
          <li>Target: maximize portfolio spread while maintaining duration 5&ndash;7Y</li>
          <li>Equal-weight starting point, then adjust for constraints</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Rank by Spread Efficiency</h4>
        <p>Spread efficiency = Spread / Duration:</p>
        <table class="data-table">
          <thead><tr><th>Issuer</th><th>Spread</th><th>Duration</th><th>Efficiency</th></tr></thead>
          <tbody>
            <tr><td>JPMorgan</td><td>95</td><td>4.3</td><td>22.1 bp/yr</td></tr>
            <tr><td>Goldman Sachs</td><td>130</td><td>5.8</td><td>22.4 bp/yr</td></tr>
            <tr><td>CVS Health</td><td>160</td><td>7.2</td><td>22.2 bp/yr</td></tr>
            <tr><td>Verizon</td><td>145</td><td>7.5</td><td>19.3 bp/yr</td></tr>
            <tr><td>NextEra</td><td>115</td><td>5.9</td><td>19.5 bp/yr</td></tr>
            <tr><td>Duke Energy</td><td>85</td><td>4.4</td><td>19.3 bp/yr</td></tr>
            <tr><td>Apple</td><td>55</td><td>6.1</td><td>9.0 bp/yr</td></tr>
            <tr><td>Microsoft</td><td>40</td><td>4.5</td><td>8.9 bp/yr</td></tr>
          </tbody>
        </table>

        <h4>Step 2: Initial Allocation (Spread-Maximizing)</h4>
        <p>Allocate more to higher spread-efficiency bonds, then check constraints:</p>
        <table class="data-table">
          <thead><tr><th>Issuer</th><th>Weight</th><th>Sector</th></tr></thead>
          <tbody>
            <tr><td>JPMorgan</td><td>10%</td><td>Financials</td></tr>
            <tr><td>Apple</td><td>10%</td><td>Technology</td></tr>
            <tr><td>Verizon</td><td>10%</td><td>Telecom</td></tr>
            <tr><td>Duke Energy</td><td>10%</td><td>Utilities</td></tr>
            <tr><td>Goldman Sachs</td><td>10%</td><td>Financials</td></tr>
            <tr><td>CVS Health</td><td>10%</td><td>Healthcare</td></tr>
            <tr><td>Microsoft</td><td>10%</td><td>Technology</td></tr>
            <tr><td>NextEra</td><td>10%</td><td>Utilities</td></tr>
          </tbody>
        </table>
        <p>Remaining 20% to distribute among best spread-efficiency bonds while respecting 10% issuer max.</p>

        <h4>Step 3: Final Allocation</h4>
        <p>Final weights (summing to 100%, respecting 10% single-issuer cap):</p>
        <p>JPMorgan 10%, Goldman Sachs 10%, CVS Health 10%, Verizon 10%, NextEra 10%, Duke Energy 10%, Apple 10%, Microsoft 10% &mdash; remaining 20% split: +5% each to Verizon, CVS, NextEra, Goldman Sachs (each now at 15%? No&mdash;violates 10% cap). Instead we add the extra via smaller increments below cap.</p>
        <p>Revised: JPM 10%, GS 10%, CVS 10%, Verizon 10%, NextEra 10%, Duke 10%, Apple 10%, MSFT 10%, plus redistribute 20%: give 10% to a new name or spread among existing at 10% cap. Since all at 10% cap, use equal weight = 12.5% each.</p>

        <h4>Step 4: Compute Portfolio Metrics</h4>
        <div class="formula">Duration = 0.125 &times; (4.3 + 6.1 + 7.5 + 4.4 + 5.8 + 7.2 + 4.5 + 5.9) = 0.125 &times; 45.7 = 5.71 years</div>
        <div class="formula">Spread = 0.125 &times; (95 + 55 + 145 + 85 + 130 + 160 + 40 + 115) = 0.125 &times; 825 = 103.1 bps</div>
        <div class="formula">YTM = 0.125 &times; (5.40 + 4.85 + 5.95 + 5.30 + 5.80 + 6.10 + 4.60 + 5.65) = 0.125 &times; 43.65 = 5.46%</div>
      `,
      result: `
        <div class="result-box">
          <div><span class="result-label">Portfolio Duration:</span> <span class="result-value">5.71 years</span> (within 5&ndash;7Y target)</div>
          <div><span class="result-label">Portfolio Spread:</span> <span class="result-value">103.1 bps</span></div>
          <div><span class="result-label">Portfolio YTM:</span> <span class="result-value">5.46%</span></div>
          <div><span class="result-label">Sectors Represented:</span> <span class="result-value">5</span> (Financials, Technology, Telecom, Utilities, Healthcare)</div>
          <div><span class="result-label">Max Single Issuer:</span> <span class="result-value">12.5%</span></div>
        </div>
      `,
      interpretation: `
        <p>The equal-weighted portfolio achieves a duration of 5.71 years (within target), spread of 103 bps, and diversification across 5 sectors. The 12.5% single-issuer weight slightly exceeds a strict 10% cap&mdash;a real manager would reduce to 10% maximum per name and invest the remainder in additional issuers. This demonstrates the trade-off between spread maximization and constraint compliance.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>In practice, the optimal portfolio is found iteratively: maximize spread subject to all constraints simultaneously. The result is rarely equal-weighted&mdash;bonds with superior spread efficiency receive higher allocations up to concentration limits.</p>
        </div>
      `
    },
    calcId: 'portfolio-constructor',
    calcTitle: 'Portfolio Construction Optimizer',
    calcFields: [
      { id: 'w1', label: 'JPMorgan 5.25% 5Y A+ (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w2', label: 'Apple 4.50% 7Y AA+ (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w3', label: 'Verizon 5.75% 10Y BBB+ (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w4', label: 'Duke Energy 5.00% 5Y A- (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w5', label: 'Goldman Sachs 5.50% 7Y A (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w6', label: 'CVS Health 5.85% 10Y BBB (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w7', label: 'Microsoft 4.25% 5Y AAA (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'w8', label: 'NextEra 5.40% 7Y A- (%)', type: 'number', default: 12.5, step: 0.5, min: 0, max: 100 },
      { id: 'targetDurMin', label: 'Min Target Duration (yrs)', type: 'number', default: 5, step: 0.5, min: 0, max: 30 },
      { id: 'targetDurMax', label: 'Max Target Duration (yrs)', type: 'number', default: 7, step: 0.5, min: 0, max: 30 },
      { id: 'maxSingleName', label: 'Max Single Name (%)', type: 'number', default: 10, step: 1, min: 0, max: 100 }
    ],
    calcPreset: { name: 'Example: Equal-Weight Portfolio', values: { w1: 12.5, w2: 12.5, w3: 12.5, w4: 12.5, w5: 12.5, w6: 12.5, w7: 12.5, w8: 12.5, targetDurMin: 5, targetDurMax: 7, maxSingleName: 10 } },
    calcCompute: function(vals) {
      var bonds = [
        { name: 'JPMorgan', coupon: 5.25, maturity: 5, ytm: 5.40, spread: 95, duration: 4.3, rating: 'A+', ratingBucket: 'A', sector: 'Financials' },
        { name: 'Apple', coupon: 4.50, maturity: 7, ytm: 4.85, spread: 55, duration: 6.1, rating: 'AA+', ratingBucket: 'AAA/AA', sector: 'Technology' },
        { name: 'Verizon', coupon: 5.75, maturity: 10, ytm: 5.95, spread: 145, duration: 7.5, rating: 'BBB+', ratingBucket: 'BBB', sector: 'Telecom' },
        { name: 'Duke Energy', coupon: 5.00, maturity: 5, ytm: 5.30, spread: 85, duration: 4.4, rating: 'A-', ratingBucket: 'A', sector: 'Utilities' },
        { name: 'Goldman Sachs', coupon: 5.50, maturity: 7, ytm: 5.80, spread: 130, duration: 5.8, rating: 'A', ratingBucket: 'A', sector: 'Financials' },
        { name: 'CVS Health', coupon: 5.85, maturity: 10, ytm: 6.10, spread: 160, duration: 7.2, rating: 'BBB', ratingBucket: 'BBB', sector: 'Healthcare' },
        { name: 'Microsoft', coupon: 4.25, maturity: 5, ytm: 4.60, spread: 40, duration: 4.5, rating: 'AAA', ratingBucket: 'AAA/AA', sector: 'Technology' },
        { name: 'NextEra', coupon: 5.40, maturity: 7, ytm: 5.65, spread: 115, duration: 5.9, rating: 'A-', ratingBucket: 'A', sector: 'Utilities' }
      ];
      var weights = [vals.w1, vals.w2, vals.w3, vals.w4, vals.w5, vals.w6, vals.w7, vals.w8];
      var totalW = weights.reduce(function(a, b) { return a + b; }, 0);
      var wNorm = weights.map(function(w) { return totalW > 0 ? w / totalW : 0; });
      var portDur = 0, portSpread = 0, portYTM = 0;
      for (var i = 0; i < 8; i++) {
        portDur += wNorm[i] * bonds[i].duration;
        portSpread += wNorm[i] * bonds[i].spread;
        portYTM += wNorm[i] * bonds[i].ytm;
      }
      var sectors = {};
      var ratings = {};
      var violations = [];
      for (var i = 0; i < 8; i++) {
        if (weights[i] > 0) {
          sectors[bonds[i].sector] = (sectors[bonds[i].sector] || 0) + wNorm[i] * 100;
          ratings[bonds[i].ratingBucket] = (ratings[bonds[i].ratingBucket] || 0) + wNorm[i] * 100;
          if (wNorm[i] * 100 > vals.maxSingleName) {
            violations.push(bonds[i].name + ' at ' + (wNorm[i] * 100).toFixed(1) + '% exceeds ' + vals.maxSingleName + '% limit');
          }
        }
      }
      if (portDur < vals.targetDurMin) violations.push('Duration ' + portDur.toFixed(2) + ' below minimum ' + vals.targetDurMin);
      if (portDur > vals.targetDurMax) violations.push('Duration ' + portDur.toFixed(2) + ' above maximum ' + vals.targetDurMax);
      var sectorStr = Object.keys(sectors).map(function(s) { return s + ': ' + sectors[s].toFixed(1) + '%'; }).join(', ');
      var ratingStr = Object.keys(ratings).map(function(r) { return r + ': ' + ratings[r].toFixed(1) + '%'; }).join(', ');
      var numSectors = Object.keys(sectors).filter(function(s) { return sectors[s] > 0; }).length;
      var results = [
        { label: 'Total Weight', value: totalW.toFixed(1), unit: '%' },
        { label: 'Portfolio Duration', value: portDur.toFixed(2), unit: 'years' },
        { label: 'Portfolio Spread', value: portSpread.toFixed(1), unit: 'bps' },
        { label: 'Portfolio YTM', value: portYTM.toFixed(2), unit: '%' },
        { label: 'Number of Sectors', value: numSectors.toString(), unit: '' },
        { label: 'Sector Allocation', value: sectorStr, unit: '' },
        { label: 'Rating Distribution', value: ratingStr, unit: '' },
        { label: 'Constraint Violations', value: violations.length === 0 ? 'None — all constraints met' : violations.join('; '), unit: '' }
      ];
      return results;
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 400, { top: 30, right: 30, bottom: 60, left: 50 });
      var sectorSlices = [
        { label: 'Financials', value: 25, color: '#2b402f' },
        { label: 'Technology', value: 25, color: '#2b7a3a' },
        { label: 'Telecom', value: 12.5, color: '#5a8c62' },
        { label: 'Utilities', value: 25, color: '#b8956a' },
        { label: 'Healthcare', value: 12.5, color: '#c4453a' }
      ];
      Chart.donutChart(ctx, sectorSlices, 175, 200, 130, 70);
      Chart.legend(ctx, sectorSlices, 340, 80);
      var titleEl = Chart.el('text', { x: 175, y: 25, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl.textContent = 'Sector Allocation';
      ctx.svg.appendChild(titleEl);
      container.appendChild(ctx.svg);

      var ctx2 = Chart.create(700, 350, { top: 30, right: 30, bottom: 60, left: 50 });
      var ratingBars = [
        { label: 'AAA/AA', value: 0.25, color: '#2b7a3a' },
        { label: 'A', value: 0.50, color: '#2b402f' },
        { label: 'BBB', value: 0.25, color: '#5a8c62' }
      ];
      Chart.barChart(ctx2, ratingBars, '#2b402f');
      var titleEl2 = Chart.el('text', { x: 350, y: 20, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl2.textContent = 'Rating Distribution';
      ctx2.svg.appendChild(titleEl2);
      container.appendChild(ctx2.svg);
    },
    quiz: [
      {
        q: 'A portfolio manager must construct an investment-grade portfolio with duration between 5-7 years. Which bond would MOST help reduce duration if the current portfolio duration is 7.8 years?',
        options: ['10-year BBB at 6.1% YTM, which has the highest yield and therefore the most duration risk offset', '3-year AA at 4.2% YTM, which has the shortest maturity and lowest duration', '7-year A at 5.5% YTM, which is closest to the target duration midpoint', '5-year BBB at 5.8% YTM with a high coupon that reduces effective duration'],
        correct: 1,
        explanation: 'The 3-year AA bond has the shortest duration among the choices (~2.8 years), which would pull the weighted-average portfolio duration downward most effectively. While higher yields and coupons do reduce duration marginally, maturity is the dominant driver. The 7Y bond would barely help, and the 10Y bond would increase duration.'
      },
      {
        q: 'What is the primary purpose of a maximum single-issuer concentration limit in portfolio construction?',
        options: ['To ensure adequate portfolio liquidity by diversifying across dealers', 'To reduce systematic spread risk by spreading across sectors', 'To limit idiosyncratic default risk from any single credit event', 'To lower portfolio duration by preventing large allocations to long-dated issuers'],
        correct: 2,
        explanation: 'Maximum single-issuer limits protect against concentration risk \u2014 the risk that a single default or credit event causes disproportionate portfolio losses. This is a form of managing idiosyncratic (issuer-specific) risk, distinct from systematic risk which affects all credits.'
      },
      {
        q: 'An equal-weighted portfolio of 8 bonds has each bond at 12.5% weight. If the IPS limits single-name exposure to 10%, what is the minimum number of bonds needed to invest 100% of capital?',
        options: ['8 bonds', '10 bonds', '12 bonds', '15 bonds'],
        correct: 1,
        explanation: 'With a 10% maximum per name, you need at least 100% / 10% = 10 bonds to fully invest the portfolio. With fewer bonds, you cannot allocate 100% of capital without exceeding the single-name limit.'
      },
      {
        q: 'Which metric best measures how efficiently a bond compensates for its spread risk?',
        options: ['Yield-to-maturity', 'Modified duration', 'Spread per unit of spread duration', 'Credit rating'],
        correct: 2,
        explanation: 'Spread per unit of spread duration (OAS / spread duration) measures how much spread compensation you receive for each unit of spread risk. A higher ratio indicates a more efficient risk-return trade-off.'
      },
      {
        q: 'A portfolio is 40% Financials, 20% Industrials, 15% Utilities, 15% Energy, 10% Technology. In a financial crisis scenario, the primary concern is:',
        options: ['The Utilities allocation, since regulated sectors face margin compression in rate-rise environments', 'Concentration risk from the 40% Financials overweight, exposing the portfolio to correlated sector losses', 'The Energy allocation, since commodity prices typically collapse alongside financial stress', 'Broad credit spread risk across all sectors, since financial crises affect IG spreads uniformly'],
        correct: 1,
        explanation: 'A 40% allocation to Financials creates significant sector concentration risk during a financial crisis. Financial sector spreads can widen 200-400 bps in a crisis, causing outsized losses when the sector represents such a large portfolio share. While all sectors are affected, the disproportionate Financials weight makes it the dominant risk factor. The 2008 crisis demonstrated this exact scenario.'
      }
    ]
  },

  // ─── Section 7: Risk Decomposition ───
  {
    id: 'section-7',
    number: 7,
    title: 'Risk Decomposition',
    subtopics: ['Interest rate risk', 'Credit spread risk', 'Liquidity risk', 'Concentration risk'],
    lesson: `
      <h3>Breaking Down Portfolio Risk</h3>
      <p>A corporate bond portfolio&rsquo;s total risk can be decomposed into distinct, measurable components. Understanding which risks dominate allows portfolio managers to hedge selectively, allocate risk budgets efficiently, and communicate risk exposures to stakeholders.</p>

      <h4>1. Interest Rate Risk</h4>
      <p>Sensitivity to changes in the risk-free (Treasury) yield curve. Measured by:</p>
      <div class="formula">IR\\ P\\&amp;L \\approx -Duration_{IR} \\times \\Delta y_{treasury} \\times Portfolio\\ Value</div>
      <p>The <strong>DV01</strong> (dollar value of one basis point) quantifies the dollar loss from a 1bp parallel shift in Treasuries:</p>
      <div class="formula">DV01 = Duration \\times Portfolio\\ Value \\times 0.0001</div>

      <h4>2. Credit Spread Risk</h4>
      <p>Sensitivity to changes in credit spreads above the risk-free curve. For investment-grade portfolios, spread risk often accounts for 40&ndash;60% of total volatility:</p>
      <div class="formula">Spread\\ P\\&amp;L \\approx -Spread\\ Duration \\times \\Delta spread \\times Portfolio\\ Value</div>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>In normal markets, interest rate risk and spread risk are partially offsetting&mdash;a &ldquo;flight to quality&rdquo; sees Treasuries rally (rates down, price up) while spreads widen (price down). This negative correlation reduces total portfolio volatility below the sum of individual risk components.</p>
      </div>

      <h4>3. Default/Loss Risk</h4>
      <p>The risk of actual credit losses. Measured through expected loss (EL):</p>
      <div class="formula">Expected\\ Loss = Probability\\ of\\ Default \\times Loss\\ Given\\ Default \\times Exposure</div>
      <p>For IG portfolios, annual expected loss is typically 5&ndash;20 bps. Unexpected loss (the tail risk) is much larger and drives capital requirements.</p>

      <h4>4. Liquidity Risk</h4>
      <p>The cost of unwinding positions, proxied by bid-ask spreads:</p>
      <table class="data-table">
        <thead><tr><th>Rating/Maturity</th><th>Typical Bid-Ask</th><th>Liquidity Score</th></tr></thead>
        <tbody>
          <tr><td>AAA/AA, &lt;5Y</td><td>2&ndash;5 bps</td><td>High</td></tr>
          <tr><td>A, 5&ndash;10Y</td><td>5&ndash;15 bps</td><td>Medium</td></tr>
          <tr><td>BBB, &gt;10Y</td><td>15&ndash;40 bps</td><td>Low</td></tr>
        </tbody>
      </table>

      <h4>5. Concentration Risk</h4>
      <p>Risk from overexposure to individual issuers, sectors, or factors. Measured by the Herfindahl-Hirschman Index (HHI):</p>
      <div class="formula">HHI = \\sum_{i=1}^{n} w_i^2 \\quad (lower = more diversified, minimum = 1/n)</div>

      <div class="callout warning">
        <div class="callout-title">Warning</div>
        <p>Risk components are NOT additive due to correlations. Total portfolio risk is less than the sum of individual risk components. A proper decomposition must account for correlation effects between rates and spreads.</p>
      </div>
    `,
    example: {
      title: 'Risk Decomposition of a 5-Bond Portfolio',
      given: `
        <p>Portfolio value: $100 million. Decompose risk into components:</p>
        <table class="data-table">
          <thead><tr><th>Bond</th><th>Weight</th><th>Duration</th><th>Spread Dur</th><th>Spread (bps)</th><th>Rating</th><th>Bid-Ask (bps)</th></tr></thead>
          <tbody>
            <tr><td>Treasury-like AAA</td><td>20%</td><td>5.0</td><td>0.5</td><td>25</td><td>AAA</td><td>3</td></tr>
            <tr><td>Bank A-rated</td><td>25%</td><td>4.5</td><td>4.3</td><td>90</td><td>A</td><td>8</td></tr>
            <tr><td>Industrial BBB</td><td>25%</td><td>6.8</td><td>6.5</td><td>155</td><td>BBB</td><td>18</td></tr>
            <tr><td>Utility A-rated</td><td>15%</td><td>7.2</td><td>7.0</td><td>80</td><td>A</td><td>10</td></tr>
            <tr><td>Telecom BBB</td><td>15%</td><td>8.5</td><td>8.2</td><td>170</td><td>BBB</td><td>22</td></tr>
          </tbody>
        </table>
      `,
      assumptions: `
        <ul>
          <li>Rate shock scenario: +50 bps parallel shift in Treasuries</li>
          <li>Spread shock scenario: +25 bps uniform spread widening</li>
          <li>Default risk: use 5-year cumulative PD of 0.1% for AAA/AA, 0.5% for A, 2.0% for BBB; LGD = 60%</li>
          <li>Liquidity cost = bid-ask spread &times; weight &times; portfolio value</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Portfolio Duration Metrics</h4>
        <div class="formula">Portfolio Duration = 0.20(5.0) + 0.25(4.5) + 0.25(6.8) + 0.15(7.2) + 0.15(8.5) = 1.0 + 1.125 + 1.7 + 1.08 + 1.275 = 6.18 years</div>
        <div class="formula">Portfolio Spread Duration = 0.20(0.5) + 0.25(4.3) + 0.25(6.5) + 0.15(7.0) + 0.15(8.2) = 0.1 + 1.075 + 1.625 + 1.05 + 1.23 = 5.08 years</div>

        <h4>Step 2: Interest Rate Risk (DV01 &amp; P&amp;L)</h4>
        <div class="formula">IR DV01 = 6.18 &times; $100M &times; 0.0001 = $61,800 per bp</div>
        <div class="formula">IR P&amp;L (for +50bp shock) = -6.18 &times; 0.0050 &times; $100M = -$3,090,000</div>

        <h4>Step 3: Credit Spread Risk</h4>
        <div class="formula">Spread DV01 = 5.08 &times; $100M &times; 0.0001 = $50,800 per bp</div>
        <div class="formula">Spread P&amp;L (for +25bp widening) = -5.08 &times; 0.0025 &times; $100M = -$1,270,000</div>

        <h4>Step 4: Expected Default Loss (Annual)</h4>
        <div class="formula">EL = [0.20 &times; 0.001 + 0.25 &times; 0.005 + 0.25 &times; 0.020 + 0.15 &times; 0.005 + 0.15 &times; 0.020] &times; 0.60 &times; $100M</div>
        <div class="formula">EL = [0.0002 + 0.00125 + 0.005 + 0.00075 + 0.003] &times; 0.60 &times; $100M</div>
        <div class="formula">EL = 0.01020 &times; 0.60 &times; $100M = $612,000 over 5 years = $122,400 annualized</div>

        <h4>Step 5: Liquidity Cost Estimate</h4>
        <div class="formula">Liquidity Cost = 0.20(3) + 0.25(8) + 0.25(18) + 0.15(10) + 0.15(22) = 0.6 + 2.0 + 4.5 + 1.5 + 3.3 = 11.9 bps</div>
        <div class="formula">Dollar Liquidity Cost = 11.9 &times; $100M &times; 0.0001 = $119,000</div>

        <h4>Step 6: Concentration (HHI)</h4>
        <div class="formula">HHI = 0.20^2 + 0.25^2 + 0.25^2 + 0.15^2 + 0.15^2 = 0.04 + 0.0625 + 0.0625 + 0.0225 + 0.0225 = 0.21</div>
        <p>Minimum possible HHI for 5 bonds = 1/5 = 0.20. Our HHI of 0.21 indicates reasonably good diversification.</p>
      `,
      result: `
        <div class="result-box">
          <div><span class="result-label">Interest Rate DV01:</span> <span class="result-value">$61,800 / bp</span></div>
          <div><span class="result-label">IR P&amp;L (+50bp):</span> <span class="result-value text-red">-$3,090,000</span> (-3.09%)</div>
          <div><span class="result-label">Spread DV01:</span> <span class="result-value">$50,800 / bp</span></div>
          <div><span class="result-label">Spread P&amp;L (+25bp):</span> <span class="result-value text-red">-$1,270,000</span> (-1.27%)</div>
          <div><span class="result-label">Annual Expected Loss:</span> <span class="result-value text-red">$122,400</span> (1.2 bps)</div>
          <div><span class="result-label">Liquidity Cost (full unwind):</span> <span class="result-value">$119,000</span> (11.9 bps)</div>
          <div><span class="result-label">HHI Concentration:</span> <span class="result-value">0.21</span> (well-diversified)</div>
        </div>
      `,
      interpretation: `
        <p>Interest rate risk dominates this portfolio&rsquo;s risk profile at $3.09M for a 50bp shock, followed by credit spread risk at $1.27M for a 25bp widening. Default risk is relatively small for this IG portfolio (~$122K/year), and liquidity costs are modest at ~12 bps for a full portfolio unwind.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>The ratio of spread DV01 to IR DV01 is 0.82x, indicating the portfolio has nearly as much spread risk as rate risk. This is typical for IG portfolios with significant BBB exposure. Managers can hedge rate risk with Treasury futures while retaining spread exposure for carry.</p>
        </div>
      `
    },
    calcId: 'risk-decomposition',
    calcTitle: 'Risk Decomposition Dashboard',
    calcFields: [
      { id: 'portfolioValue', label: 'Portfolio Value ($M)', type: 'number', default: 100, step: 10, min: 1, max: 10000 },
      { id: 'portDuration', label: 'Portfolio Duration (yrs)', type: 'number', default: 6.18, step: 0.1, min: 0, max: 30 },
      { id: 'portSpreadDur', label: 'Portfolio Spread Duration (yrs)', type: 'number', default: 5.08, step: 0.1, min: 0, max: 30 },
      { id: 'avgSpread', label: 'Average Spread (bps)', type: 'number', default: 110, step: 5, min: 0, max: 1000 },
      { id: 'rateShock', label: 'Rate Shock (bps)', type: 'number', default: 50, step: 5, min: -500, max: 500 },
      { id: 'spreadShock', label: 'Spread Shock (bps)', type: 'number', default: 25, step: 5, min: -500, max: 500 },
      { id: 'avgPD', label: 'Avg Annual PD (%)', type: 'number', default: 0.5, step: 0.1, min: 0, max: 20 },
      { id: 'lgd', label: 'Loss Given Default (%)', type: 'number', default: 60, step: 5, min: 0, max: 100 },
      { id: 'avgBidAsk', label: 'Avg Bid-Ask (bps)', type: 'number', default: 12, step: 1, min: 0, max: 100 },
      { id: 'numPositions', label: 'Number of Positions', type: 'number', default: 5, step: 1, min: 1, max: 200 }
    ],
    calcPreset: { name: 'Example: 5-Bond IG Portfolio', values: { portfolioValue: 100, portDuration: 6.18, portSpreadDur: 5.08, avgSpread: 110, rateShock: 50, spreadShock: 25, avgPD: 0.5, lgd: 60, avgBidAsk: 12, numPositions: 5 } },
    calcCompute: function(vals) {
      var pv = vals.portfolioValue * 1e6;
      var irDV01 = vals.portDuration * pv * 0.0001;
      var irPnL = -vals.portDuration * (vals.rateShock / 10000) * pv;
      var spreadDV01 = vals.portSpreadDur * pv * 0.0001;
      var spreadPnL = -vals.portSpreadDur * (vals.spreadShock / 10000) * pv;
      var annualEL = (vals.avgPD / 100) * (vals.lgd / 100) * pv;
      var liquidityCost = (vals.avgBidAsk / 10000) * pv;
      var hhi = 1 / vals.numPositions;
      var combinedPnL = irPnL + spreadPnL;
      var irPct = Math.abs(irPnL) / (Math.abs(irPnL) + Math.abs(spreadPnL) + annualEL + liquidityCost) * 100;
      var spreadPct = Math.abs(spreadPnL) / (Math.abs(irPnL) + Math.abs(spreadPnL) + annualEL + liquidityCost) * 100;
      var defaultPct = annualEL / (Math.abs(irPnL) + Math.abs(spreadPnL) + annualEL + liquidityCost) * 100;
      var liqPct = liquidityCost / (Math.abs(irPnL) + Math.abs(spreadPnL) + annualEL + liquidityCost) * 100;
      return [
        { label: 'IR DV01', value: '$' + irDV01.toLocaleString(undefined, {maximumFractionDigits: 0}), unit: 'per bp' },
        { label: 'IR P&L (' + (vals.rateShock >= 0 ? '+' : '') + vals.rateShock + 'bp)', value: '$' + (irPnL / 1e6).toFixed(3) + 'M', unit: '(' + (irPnL / pv * 100).toFixed(2) + '%)' },
        { label: 'Spread DV01', value: '$' + spreadDV01.toLocaleString(undefined, {maximumFractionDigits: 0}), unit: 'per bp' },
        { label: 'Spread P&L (' + (vals.spreadShock >= 0 ? '+' : '') + vals.spreadShock + 'bp)', value: '$' + (spreadPnL / 1e6).toFixed(3) + 'M', unit: '(' + (spreadPnL / pv * 100).toFixed(2) + '%)' },
        { label: 'Annual Expected Loss', value: '$' + (annualEL / 1e3).toFixed(1) + 'K', unit: '(' + (annualEL / pv * 10000).toFixed(1) + ' bps)' },
        { label: 'Liquidity Cost (full unwind)', value: '$' + (liquidityCost / 1e3).toFixed(1) + 'K', unit: '(' + vals.avgBidAsk + ' bps)' },
        { label: 'HHI (equal-weight proxy)', value: hhi.toFixed(4), unit: '(min for ' + vals.numPositions + ' names)' },
        { label: 'Combined Rate+Spread P&L', value: '$' + (combinedPnL / 1e6).toFixed(3) + 'M', unit: '(' + (combinedPnL / pv * 100).toFixed(2) + '%)' },
        { label: 'Risk Contribution: IR', value: irPct.toFixed(1), unit: '%' },
        { label: 'Risk Contribution: Spread', value: spreadPct.toFixed(1), unit: '%' },
        { label: 'Risk Contribution: Default', value: defaultPct.toFixed(1), unit: '%' },
        { label: 'Risk Contribution: Liquidity', value: liqPct.toFixed(1), unit: '%' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 400, { top: 40, right: 30, bottom: 60, left: 60 });
      var categories = ['Bond 1\n(AAA)', 'Bond 2\n(A)', 'Bond 3\n(BBB)', 'Bond 4\n(A)', 'Bond 5\n(BBB)'];
      var series = [
        { color: '#2b402f', label: 'IR Risk', values: [0.25, 0.20, 0.30, 0.28, 0.35] },
        { color: '#5a8c62', label: 'Spread Risk', values: [0.03, 0.22, 0.35, 0.25, 0.38] },
        { color: '#c4453a', label: 'Default Risk', values: [0.01, 0.03, 0.08, 0.03, 0.08] },
        { color: '#b8956a', label: 'Liquidity Risk', values: [0.01, 0.04, 0.09, 0.05, 0.11] }
      ];
      Chart.stackedBar(ctx, categories, series);
      Chart.legend(ctx, [
        { label: 'IR Risk', color: '#2b402f' },
        { label: 'Spread Risk', color: '#5a8c62' },
        { label: 'Default Risk', color: '#c4453a' },
        { label: 'Liquidity Risk', color: '#b8956a' }
      ], 420, 50);
      var titleEl = Chart.el('text', { x: 350, y: 25, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl.textContent = 'Risk Decomposition by Bond';
      ctx.svg.appendChild(titleEl);
      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'For a typical investment-grade corporate bond portfolio, which risk component usually contributes the MOST to total portfolio volatility?',
        options: ['Default risk', 'Liquidity risk', 'Interest rate risk combined with credit spread risk', 'Currency risk'],
        correct: 2,
        explanation: 'Interest rate risk and credit spread risk together typically account for 80-90% of IG portfolio volatility. Default risk is small for IG (annual expected loss <20bps), and liquidity risk manifests primarily during forced selling.'
      },
      {
        q: 'A portfolio has DV01 of $62,000 and Spread DV01 of $51,000. If rates fall 30bp while spreads widen 20bp, the approximate total P&L is:',
        options: ['+$840,000', '+$840,000 rate gain and -$1,020,000 spread loss = -$180,000', '+$1,860,000 rate gain and -$1,020,000 spread loss = +$840,000', '+$1,860,000'],
        correct: 2,
        explanation: 'Rate P&L = +$62,000 x 30 = +$1,860,000 (rates down = price up). Spread P&L = -$51,000 x 20 = -$1,020,000 (spreads widen = price down). Net = +$840,000. This illustrates the partial offset between rate and spread moves.'
      },
      {
        q: 'The Herfindahl-Hirschman Index (HHI) for a portfolio of 20 equal-weighted bonds is:',
        options: ['0.20', '0.10', '0.05', '0.01'],
        correct: 2,
        explanation: 'HHI = sum of squared weights = 20 x (1/20)^2 = 20 x 0.0025 = 0.05. The minimum HHI for n equal-weighted positions is always 1/n. Lower HHI indicates better diversification.'
      },
      {
        q: 'During a credit crisis, which risk component typically increases the MOST in relative terms?',
        options: ['Interest rate risk', 'Liquidity risk', 'Currency risk', 'Inflation risk'],
        correct: 1,
        explanation: 'Liquidity risk can increase 5-10x during a credit crisis as bid-ask spreads blow out from 5-10bps to 50-100+ bps. While spread risk also increases, the relative magnitude of liquidity deterioration is typically the largest among all risk factors.'
      },
      {
        q: 'A BBB-rated bond has spread duration of 6.5 years and current spread of 160bps. If spreads widen to 210bps, the approximate price impact is:',
        options: ['-3.25%', '-2.50%', '-1.60%', '-0.50%'],
        correct: 0,
        explanation: 'Price change ≈ -Spread Duration x Change in spread = -6.5 x 0.0050 = -0.0325 = -3.25%. The 50bp spread widening causes a significant 3.25% price decline, demonstrating why spread risk is critical for lower-rated IG bonds.'
      }
    ]
  },

  // ─── Section 8: Performance Attribution ───
  {
    id: 'section-8',
    number: 8,
    title: 'Performance Attribution',
    subtopics: ['Carry', 'Roll-down', 'Spread tightening', 'Excess return decomposition'],
    lesson: `
      <h3>Decomposing Fixed-Income Returns</h3>
      <p>Performance attribution answers the critical question: <em>where did the returns come from?</em> For corporate bond portfolios, total return can be decomposed into five primary components, each driven by different market factors.</p>

      <h4>1. Income / Carry</h4>
      <p>The most predictable component&mdash;the net coupon income after financing costs:</p>
      <div class="formula">Carry = (Coupon\\ Rate - Funding\\ Rate) \\times Horizon</div>
      <p>For a bond yielding 5.25% financed at 4.50%, quarterly carry = (5.25% - 4.50%) &times; 0.25 = 0.1875%. Carry is always positive when the yield curve is upward-sloping (positive carry trade).</p>

      <h4>2. Roll-Down Return</h4>
      <p>As a bond ages, it &ldquo;rolls down&rdquo; the yield curve toward shorter maturities, which typically have lower yields. If the curve is upward-sloping, this creates price appreciation:</p>
      <div class="formula">Roll\\text{-}Down \\approx -(Curve\\ Slope) \\times Duration \\times Horizon / Maturity</div>
      <p>For a 7-year bond with the curve sloping ~15bp/year, rolling down by one quarter: Roll-down &asymp; 15bp &times; 0.25 &times; Duration adjustment.</p>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>Carry + Roll-down together represent the &ldquo;expected&rdquo; return of holding a bond assuming no change in the yield curve shape. Professional managers call this the <strong>&ldquo;breakeven&rdquo;</strong>&mdash;how much rates can rise before you lose money.</p>
      </div>

      <h4>3. Spread Change P&amp;L</h4>
      <p>Mark-to-market gain or loss from changes in credit spreads:</p>
      <div class="formula">Spread\\ P\\&amp;L \\approx -Spread\\ Duration \\times \\Delta Spread</div>
      <p>Spread tightening (narrowing) generates gains; spread widening generates losses. This component is often the largest source of quarterly return variation.</p>

      <h4>4. Rate (Treasury Curve) P&amp;L</h4>
      <p>Impact of changes in the risk-free curve:</p>
      <div class="formula">Rate\\ P\\&amp;L \\approx -Duration \\times \\Delta y_{treasury}</div>
      <p>Falling Treasury yields produce positive returns; rising yields produce negative returns.</p>

      <h4>5. Selection / Residual</h4>
      <p>The unexplained portion after accounting for systematic factors. In a well-attributed framework, residuals should be small (&lt;10 bps). Large residuals suggest missing risk factors or non-linear effects.</p>

      <h4>The Campisi Attribution Model</h4>
      <table class="data-table">
        <thead><tr><th>Component</th><th>Driver</th><th>Typical Quarterly Range</th></tr></thead>
        <tbody>
          <tr><td>Income (Carry)</td><td>Coupon - Funding</td><td>+10 to +40 bps</td></tr>
          <tr><td>Roll-down</td><td>Curve slope &times; aging</td><td>+5 to +20 bps</td></tr>
          <tr><td>Spread P&amp;L</td><td>Spread changes</td><td>-200 to +200 bps</td></tr>
          <tr><td>Treasury P&amp;L</td><td>Rate changes</td><td>-300 to +300 bps</td></tr>
          <tr><td>Selection/Residual</td><td>Security selection</td><td>-20 to +20 bps</td></tr>
        </tbody>
      </table>

      <div class="callout definition">
        <div class="callout-title">Definition</div>
        <p><strong>Excess return</strong> over Treasuries = Carry (spread only) + Roll-down + Spread P&amp;L + Selection. This strips out the Treasury curve effect to isolate credit-specific performance.</p>
      </div>
    `,
    example: {
      title: 'Quarterly Performance Attribution',
      given: `
        <p>Portfolio characteristics at start of quarter:</p>
        <table class="data-table">
          <thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>
            <tr><td>Portfolio Duration</td><td>6.50 years</td></tr>
            <tr><td>Spread Duration</td><td>6.20 years</td></tr>
            <tr><td>Coupon Rate</td><td>5.25%</td></tr>
            <tr><td>Funding Rate</td><td>4.50%</td></tr>
            <tr><td>Initial Spread</td><td>150 bps</td></tr>
          </tbody>
        </table>
        <p>Market moves over the quarter:</p>
        <ul>
          <li>Credit spreads tightened 15 bps (from 150 to 135 bps)</li>
          <li>Treasury yields increased 10 bps</li>
        </ul>
      `,
      assumptions: `
        <ul>
          <li>One quarter = 0.25 years</li>
          <li>Roll-down approximated as curve slope &times; duration / maturity &times; horizon; assume curve slope ~12bps/year at the portfolio&rsquo;s maturity point</li>
          <li>No defaults or rating migrations during the quarter</li>
          <li>Linear approximation (no convexity adjustment)</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Carry (Income Return)</h4>
        <div class="formula">Carry = (Coupon - Funding) \\times Horizon = (5.25\\% - 4.50\\%) \\times 0.25 = 0.1875\\%</div>
        <p>This is the &ldquo;earned&rdquo; return from holding the portfolio, approximately 18.75 bps for the quarter.</p>

        <h4>Step 2: Roll-Down Return</h4>
        <div class="formula">Roll\\text{-}Down \\approx Curve\\ Slope \\times Horizon = 12\\ bps/yr \\times 0.25 = 3.0\\ bps = 0.030\\%</div>
        <p>The portfolio gained ~3 bps from rolling down an upward-sloping curve over one quarter.</p>

        <h4>Step 3: Spread P&amp;L</h4>
        <div class="formula">Spread\\ P\\&amp;L = -Spread\\ Duration \\times \\Delta Spread = -6.20 \\times (-0.0015) = +0.0093 = +0.930\\%</div>
        <p>The 15bp spread tightening generated a significant 93bp return, the largest component this quarter.</p>

        <h4>Step 4: Rate (Treasury) P&amp;L</h4>
        <div class="formula">Rate\\ P\\&amp;L = -Duration \\times \\Delta y_{treasury} = -6.50 \\times 0.0010 = -0.0065 = -0.650\\%</div>
        <p>The 10bp rise in Treasury yields caused a 65bp loss.</p>

        <h4>Step 5: Total Return</h4>
        <div class="formula">Total = Carry + Roll\\text{-}Down + Spread\\ P\\&amp;L + Rate\\ P\\&amp;L</div>
        <div class="formula">Total = 0.1875\\% + 0.030\\% + 0.930\\% - 0.650\\% = +0.4975\\%</div>
      `,
      result: `
        <div class="result-box">
          <div><span class="result-label">Carry:</span> <span class="result-value text-green">+18.75 bps</span></div>
          <div><span class="result-label">Roll-Down:</span> <span class="result-value text-green">+3.00 bps</span></div>
          <div><span class="result-label">Spread P&amp;L:</span> <span class="result-value text-green">+93.00 bps</span></div>
          <div><span class="result-label">Rate P&amp;L:</span> <span class="result-value text-red">-65.00 bps</span></div>
          <div><span class="result-label">Total Quarterly Return:</span> <span class="result-value text-green">+49.75 bps</span> (+0.50%)</div>
        </div>
      `,
      interpretation: `
        <p>The portfolio generated a positive quarterly return of approximately 50 bps despite rising Treasury yields. The dominant driver was <strong>spread tightening</strong> (+93 bps), which more than offset the negative rate effect (-65 bps). Carry contributed a steady +19 bps, demonstrating the importance of income in total return.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>This quarter illustrates the &ldquo;Goldilocks&rdquo; scenario for credit: modest rate increases (which the Fed may engineer to slow the economy) accompanied by spread tightening (as the economy remains healthy). In contrast, during a recession, both rates fall (positive) AND spreads widen (negative), creating a very different attribution profile.</p>
        </div>
      `
    },
    calcId: 'performance-attribution',
    calcTitle: 'Performance Attribution Tool',
    calcFields: [
      { id: 'portDuration', label: 'Portfolio Duration (yrs)', type: 'number', default: 6.5, step: 0.1, min: 0, max: 30 },
      { id: 'spreadDuration', label: 'Spread Duration (yrs)', type: 'number', default: 6.2, step: 0.1, min: 0, max: 30 },
      { id: 'couponRate', label: 'Coupon Rate (%)', type: 'number', default: 5.25, step: 0.05, min: 0, max: 15 },
      { id: 'fundingRate', label: 'Funding Rate (%)', type: 'number', default: 4.50, step: 0.05, min: 0, max: 15 },
      { id: 'initialSpread', label: 'Initial Spread (bps)', type: 'number', default: 150, step: 5, min: 0, max: 1000 },
      { id: 'spreadChange', label: 'Spread Change (bps, neg=tighten)', type: 'number', default: -15, step: 1, min: -500, max: 500 },
      { id: 'rateChange', label: 'Treasury Rate Change (bps)', type: 'number', default: 10, step: 1, min: -500, max: 500 },
      { id: 'horizon', label: 'Horizon (years)', type: 'number', default: 0.25, step: 0.25, min: 0.25, max: 5 }
    ],
    calcPreset: { name: 'Example: Q1 Attribution', values: { portDuration: 6.5, spreadDuration: 6.2, couponRate: 5.25, fundingRate: 4.50, initialSpread: 150, spreadChange: -15, rateChange: 10, horizon: 0.25 } },
    calcCompute: function(vals) {
      var carry = (vals.couponRate - vals.fundingRate) / 100 * vals.horizon;
      var curveSlope = 0.0012;
      var rollDown = curveSlope * vals.horizon;
      var spreadPnL = -vals.spreadDuration * (vals.spreadChange / 10000);
      var ratePnL = -vals.portDuration * (vals.rateChange / 10000);
      var total = carry + rollDown + spreadPnL + ratePnL;
      var carryBps = carry * 10000;
      var rollBps = rollDown * 10000;
      var spreadBps = spreadPnL * 10000;
      var rateBps = ratePnL * 10000;
      var totalBps = total * 10000;
      var excessReturn = carry + rollDown + spreadPnL;
      var excessBps = excessReturn * 10000;
      return [
        { label: 'Carry (Income)', value: (carry * 100).toFixed(3), unit: '% (' + carryBps.toFixed(1) + ' bps)' },
        { label: 'Roll-Down', value: (rollDown * 100).toFixed(3), unit: '% (' + rollBps.toFixed(1) + ' bps)' },
        { label: 'Spread P&L', value: (spreadPnL * 100).toFixed(3), unit: '% (' + spreadBps.toFixed(1) + ' bps)' },
        { label: 'Rate P&L', value: (ratePnL * 100).toFixed(3), unit: '% (' + rateBps.toFixed(1) + ' bps)' },
        { label: 'Total Return', value: (total * 100).toFixed(3), unit: '% (' + totalBps.toFixed(1) + ' bps)' },
        { label: 'Excess Return (over Treasuries)', value: (excessReturn * 100).toFixed(3), unit: '% (' + excessBps.toFixed(1) + ' bps)' },
        { label: 'Annualized Total Return', value: (total / vals.horizon * 100).toFixed(2), unit: '%' },
        { label: 'Carry % of Total', value: (total !== 0 ? Math.abs(carry / total) * 100 : 0).toFixed(1), unit: '%' },
        { label: 'Breakeven Spread Widening', value: ((carry + rollDown) / vals.spreadDuration * 10000).toFixed(1), unit: 'bps' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 420, { top: 40, right: 30, bottom: 60, left: 80 });
      var items = [
        { label: 'Carry', value: 0.30, displayValue: '+18.8bp', color: '#2b7a3a' },
        { label: 'Roll-Down', value: 0.05, displayValue: '+3.0bp', color: '#2b7a3a' },
        { label: 'Spread', value: 0.75, displayValue: '+93.0bp', color: '#2b402f' },
        { label: 'Rates', value: -0.52, displayValue: '-65.0bp', color: '#c4453a' },
        { label: 'Total', value: 0.40, displayValue: '+49.8bp', color: '#5a8c62' }
      ];
      Chart.waterfallChart(ctx, items);
      var titleEl = Chart.el('text', { x: 350, y: 25, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl.textContent = 'Quarterly Return Attribution (bps)';
      ctx.svg.appendChild(titleEl);
      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A portfolio has duration 7.0, coupon 5.5%, and funding rate 4.5%. The quarterly carry is approximately:',
        options: ['25 bps', '100 bps', '137.5 bps', '55 bps'],
        correct: 0,
        explanation: 'Carry = (Coupon - Funding) x Horizon = (5.5% - 4.5%) x 0.25 = 0.25% = 25 bps per quarter. Duration does not directly affect carry — it measures rate sensitivity, not income.'
      },
      {
        q: 'In which market environment is "roll-down return" MOST valuable?',
        options: ['Flat yield curve with tight spreads', 'Steeply upward-sloping yield curve', 'Inverted yield curve', 'Volatile rate environment with frequent curve shifts'],
        correct: 1,
        explanation: 'Roll-down return is maximized when the yield curve is steeply upward-sloping, as bonds "roll down" to lower yields (higher prices) as they age. An inverted curve produces negative roll-down, and a flat curve produces minimal roll-down.'
      },
      {
        q: 'A portfolio with spread duration of 5.5 experienced spreads tightening from 160bps to 140bps. The spread P&L contribution is:',
        options: ['+110 bps', '-110 bps', '+88 bps', '-88 bps'],
        correct: 0,
        explanation: 'Spread P&L = -Spread Duration x ΔSpread = -5.5 x (-0.0020) = +0.0110 = +110 bps. The negative sign in the formula combined with negative spread change (tightening) produces a positive return.'
      },
      {
        q: 'Over a full year, which attribution component is MOST predictable (lowest variation)?',
        options: ['Spread P&L', 'Rate P&L', 'Carry (income)', 'Selection/residual'],
        correct: 2,
        explanation: 'Carry is the most predictable component because it depends on known coupon rates and relatively stable funding costs. Spread P&L and Rate P&L depend on unpredictable market movements and can swing hundreds of basis points per year.'
      },
      {
        q: 'The "breakeven spread widening" for a portfolio is calculated as 35 bps. This means:',
        options: ['The portfolio will lose 35 bps per quarter', 'Spreads can widen by 35 bps before the carry and roll-down are fully offset', 'The portfolio needs spreads to tighten 35 bps to break even', 'The average spread of the portfolio is 35 bps'],
        correct: 1,
        explanation: 'Breakeven spread widening = (Carry + Roll-down) / Spread Duration. It represents the amount spreads can widen before the mark-to-market loss exactly offsets the income and roll-down earned over the period. This is a key metric for evaluating whether a credit position is adequately compensated.'
      }
    ]
  },

  // ─── Section 9: Stress Testing & Scenario Analysis ───
  {
    id: 'section-9',
    number: 9,
    title: 'Stress Testing & Scenario Analysis',
    subtopics: ['Parallel shifts', 'Curve steepening', 'Spread widening', 'Default shock'],
    lesson: `
      <h3>Stress Testing Corporate Bond Portfolios</h3>
      <p>Stress testing estimates portfolio losses under extreme but plausible scenarios. Unlike VaR (which captures &ldquo;normal&rdquo; market risk), stress tests focus on <strong>tail events</strong>&mdash;the scenarios that cause the most damage.</p>

      <h4>Types of Stress Scenarios</h4>

      <h5>1. Parallel Rate Shock</h5>
      <p>All Treasury yields shift by the same amount across the curve. This is the simplest and most commonly used stress test:</p>
      <div class="formula">P\\&amp;L_{rate} \\approx -Duration \\times \\Delta y + \\frac{1}{2} \\times Convexity \\times (\\Delta y)^2</div>
      <p>The convexity term becomes material for large shocks (&gt;50 bps), providing a partial cushion against losses.</p>

      <h5>2. Curve Twist (Steepening/Flattening)</h5>
      <p>The short end and long end move in opposite directions. A bear-steepener (short rates stable, long rates rise) hurts long-duration portfolios more than a parallel shift suggests:</p>
      <div class="formula">P\\&amp;L_{twist} = \\sum_i -KRD_i \\times \\Delta y_i</div>
      <p>where KRD<sub>i</sub> is the key rate duration at tenor <em>i</em>.</p>

      <h5>3. Credit Spread Widening</h5>
      <p>Spreads can widen uniformly or by rating tier. In a typical credit shock, BBB spreads widen more than A spreads:</p>
      <table class="data-table">
        <thead><tr><th>Scenario</th><th>AAA/AA</th><th>A</th><th>BBB</th></tr></thead>
        <tbody>
          <tr><td>Mild stress</td><td>+20 bps</td><td>+40 bps</td><td>+75 bps</td></tr>
          <tr><td>Moderate stress (2018-like)</td><td>+40 bps</td><td>+80 bps</td><td>+150 bps</td></tr>
          <tr><td>Severe stress (2008/2020)</td><td>+100 bps</td><td>+200 bps</td><td>+400 bps</td></tr>
        </tbody>
      </table>

      <h5>4. Default Shock</h5>
      <p>Assumes a percentage of portfolio holdings default with a specified recovery rate:</p>
      <div class="formula">Default\\ Loss = Default\\ Rate \\times (1 - Recovery\\ Rate) \\times Portfolio\\ Value</div>

      <div class="callout warning">
        <div class="callout-title">Warning</div>
        <p>Stress tests using duration/convexity are <em>approximations</em>. For very large yield changes (&gt;200bps), full repricing of each bond is recommended. Additionally, in a real crisis, correlations spike toward 1.0, and liquidity dries up&mdash;factors not captured by simple duration math.</p>
      </div>

      <h4>Combining Scenarios</h4>
      <p>The most realistic stress tests combine multiple shocks simultaneously. For example, a &ldquo;recession scenario&rdquo; might include:</p>
      <ul>
        <li>Treasury rates: -75 bps (flight to quality)</li>
        <li>IG spreads: +100 bps (risk-off)</li>
        <li>Default rate: 1.5% of BBB names over 12 months</li>
        <li>Liquidity: bid-ask doubles</li>
      </ul>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>The combined P&amp;L of a multi-factor stress test is NOT simply the sum of individual scenarios. In a flight-to-quality, rates fall (positive P&amp;L) while spreads widen (negative P&amp;L)&mdash;partial offset. Historical stress scenarios capture these correlations better than independent factor shocks.</p>
      </div>
    `,
    example: {
      title: 'Three-Scenario Stress Test',
      given: `
        <p>Model portfolio characteristics:</p>
        <table class="data-table">
          <thead><tr><th>Metric</th><th>Value</th></tr></thead>
          <tbody>
            <tr><td>Portfolio Value</td><td>$100 million</td></tr>
            <tr><td>Duration</td><td>6.50 years</td></tr>
            <tr><td>Convexity</td><td>55</td></tr>
            <tr><td>Spread Duration</td><td>6.20 years</td></tr>
            <tr><td>Average Spread</td><td>140 bps</td></tr>
          </tbody>
        </table>
        <p>Three stress scenarios to evaluate:</p>
        <ol>
          <li><strong>Scenario A:</strong> Parallel +100bp rate shock</li>
          <li><strong>Scenario B:</strong> Spread widening +75bp</li>
          <li><strong>Scenario C:</strong> Default shock &mdash; 2% of portfolio defaults, 40% recovery</li>
        </ol>
      `,
      assumptions: `
        <ul>
          <li>Duration-convexity approximation for rate and spread P&amp;L</li>
          <li>Default loss is cash loss, independent of mark-to-market</li>
          <li>Scenarios evaluated independently and then combined</li>
        </ul>
      `,
      steps: `
        <h4>Scenario A: Parallel +100bp Rate Shock</h4>
        <div class="formula">Rate\\ P\\&amp;L = (-Duration \\times \\Delta y + \\frac{1}{2} \\times Convexity \\times \\Delta y^2) \\times Value</div>
        <div class="formula">Rate\\ P\\&amp;L = (-6.50 \\times 0.01 + 0.5 \\times 55 \\times 0.01^2) \\times \\$100M</div>
        <div class="formula">Rate\\ P\\&amp;L = (-0.0650 + 0.00275) \\times \\$100M = -0.06225 \\times \\$100M</div>
        <div class="formula">Rate\\ P\\&amp;L = -\\$6,225,000</div>

        <h4>Scenario B: Spread Widening +75bp</h4>
        <div class="formula">Spread\\ P\\&amp;L = -Spread\\ Duration \\times \\Delta spread \\times Value</div>
        <div class="formula">Spread\\ P\\&amp;L = -6.20 \\times 0.0075 \\times \\$100M = -\\$4,650,000</div>

        <h4>Scenario C: Default Shock (2% defaults, 40% recovery)</h4>
        <div class="formula">Default\\ Loss = Default\\% \\times (1 - Recovery) \\times Value</div>
        <div class="formula">Default\\ Loss = 0.02 \\times 0.60 \\times \\$100M = -\\$1,200,000</div>

        <h4>Combined Worst-Case Scenario</h4>
        <div class="formula">Combined = Rate\\ P\\&amp;L + Spread\\ P\\&amp;L + Default\\ Loss</div>
        <div class="formula">Combined = -\\$6,225,000 + (-\\$4,650,000) + (-\\$1,200,000) = -\\$12,075,000</div>
      `,
      result: `
        <div class="result-box">
          <div><span class="result-label">Scenario A (Rate +100bp):</span> <span class="result-value text-red">-$6,225,000</span> (-6.23%)</div>
          <div><span class="result-label">Scenario B (Spread +75bp):</span> <span class="result-value text-red">-$4,650,000</span> (-4.65%)</div>
          <div><span class="result-label">Scenario C (2% default):</span> <span class="result-value text-red">-$1,200,000</span> (-1.20%)</div>
          <div><span class="result-label">Combined Worst-Case:</span> <span class="result-value text-red">-$12,075,000</span> (-12.08%)</div>
          <div><span class="result-label">New Portfolio Value:</span> <span class="result-value">$87,925,000</span></div>
        </div>
      `,
      interpretation: `
        <p>The combined worst-case loss is 12.08%, with rate risk contributing the most (-6.23%), followed by spread risk (-4.65%), and default losses (-1.20%). The convexity cushion saved $275,000 in the rate shock scenario.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>A 12% loss on a $100M IG portfolio would be severe but not unprecedented&mdash;Q1 2020 saw IG indices down ~10% before the Fed intervened. The key risk management response: (1) verify you can survive the drawdown without forced selling, (2) assess whether you have dry powder to add risk at wide spreads, (3) evaluate hedging costs for the rate component via Treasury futures.</p>
        </div>
      `
    },
    calcId: 'stress-testing',
    calcTitle: 'Stress Testing Module',
    calcFields: [
      { id: 'portfolioValue', label: 'Portfolio Value ($M)', type: 'number', default: 100, step: 10, min: 1, max: 10000 },
      { id: 'duration', label: 'Portfolio Duration (yrs)', type: 'number', default: 6.5, step: 0.1, min: 0, max: 30 },
      { id: 'convexity', label: 'Convexity', type: 'number', default: 55, step: 5, min: 0, max: 500 },
      { id: 'spreadDuration', label: 'Spread Duration (yrs)', type: 'number', default: 6.2, step: 0.1, min: 0, max: 30 },
      { id: 'avgSpread', label: 'Average Spread (bps)', type: 'number', default: 140, step: 5, min: 0, max: 1000 },
      { id: 'parallelShock', label: 'Rate Shock (bps)', type: 'number', default: 100, step: 25, min: -500, max: 500 },
      { id: 'spreadShock', label: 'Spread Shock (bps)', type: 'number', default: 75, step: 25, min: -500, max: 500 },
      { id: 'defaultRate', label: 'Default Rate (%)', type: 'number', default: 2, step: 0.5, min: 0, max: 30 },
      { id: 'recoveryRate', label: 'Recovery Rate (%)', type: 'number', default: 40, step: 5, min: 0, max: 100 }
    ],
    calcPreset: { name: 'Example: Combined Stress', values: { portfolioValue: 100, duration: 6.5, convexity: 55, spreadDuration: 6.2, avgSpread: 140, parallelShock: 100, spreadShock: 75, defaultRate: 2, recoveryRate: 40 } },
    calcCompute: function(vals) {
      var pv = vals.portfolioValue * 1e6;
      var dy = vals.parallelShock / 10000;
      var ds = vals.spreadShock / 10000;
      var ratePnL = (-vals.duration * dy + 0.5 * vals.convexity * dy * dy) * pv;
      var spreadPnL = -vals.spreadDuration * ds * pv;
      var defaultLoss = -(vals.defaultRate / 100) * (1 - vals.recoveryRate / 100) * pv;
      var combinedPnL = ratePnL + spreadPnL + defaultLoss;
      var newValue = pv + combinedPnL;
      var convexityCushion = 0.5 * vals.convexity * dy * dy * pv;
      var newSpread = vals.avgSpread + vals.spreadShock;
      return [
        { label: 'Rate P&L (with convexity)', value: '$' + (ratePnL / 1e6).toFixed(3) + 'M', unit: '(' + (ratePnL / pv * 100).toFixed(2) + '%)' },
        { label: 'Convexity Cushion', value: '$' + (convexityCushion / 1e3).toFixed(0) + 'K', unit: '(' + (convexityCushion / pv * 100).toFixed(3) + '%)' },
        { label: 'Spread P&L', value: '$' + (spreadPnL / 1e6).toFixed(3) + 'M', unit: '(' + (spreadPnL / pv * 100).toFixed(2) + '%)' },
        { label: 'Default Loss', value: '$' + (defaultLoss / 1e6).toFixed(3) + 'M', unit: '(' + (defaultLoss / pv * 100).toFixed(2) + '%)' },
        { label: 'Combined P&L', value: '$' + (combinedPnL / 1e6).toFixed(3) + 'M', unit: '(' + (combinedPnL / pv * 100).toFixed(2) + '%)' },
        { label: 'New Portfolio Value', value: '$' + (newValue / 1e6).toFixed(2) + 'M', unit: '' },
        { label: 'New Spread (post-shock)', value: newSpread.toFixed(0), unit: 'bps' },
        { label: 'Rate P&L without convexity', value: '$' + (-vals.duration * dy * pv / 1e6).toFixed(3) + 'M', unit: '(duration-only)' },
        { label: 'Largest Risk Component', value: Math.abs(ratePnL) >= Math.abs(spreadPnL) ? 'Rate Risk' : 'Spread Risk', unit: '' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 420, { top: 40, right: 30, bottom: 80, left: 60 });
      var categories = ['Rate\nShock', 'Spread\nShock', 'Default\nShock', 'Combined'];
      var series = [
        { color: '#2b402f', label: 'P&L Impact ($M)', values: [0.62, 0.47, 0.12, 1.0] }
      ];
      var bars = [
        { label: 'Rate +100bp', value: 0.52, color: '#c4453a' },
        { label: 'Spread +75bp', value: 0.39, color: '#5a8c62' },
        { label: 'Default 2%', value: 0.10, color: '#b8956a' },
        { label: 'Combined', value: 1.0, color: '#c4453a' }
      ];
      Chart.barChart(ctx, bars, '#c4453a');
      var titleEl = Chart.el('text', { x: 350, y: 25, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl.textContent = 'Stress Test: Loss by Scenario (Normalized)';
      ctx.svg.appendChild(titleEl);
      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A portfolio with duration 7.0 and convexity 60 experiences a +150bp parallel rate shock. The convexity-adjusted P&L is approximately:',
        options: ['-10.50% (duration only)', '-9.83% (duration + convexity adjustment)', '-7.00%', '-11.18%'],
        correct: 1,
        explanation: 'P&L = -7.0 x 0.015 + 0.5 x 60 x 0.015^2 = -0.1050 + 0.00675 = -0.09825 = -9.83%. The convexity term adds +67.5 bps, partially cushioning the 10.50% duration-only loss. For large shocks, convexity matters significantly.'
      },
      {
        q: 'In a "2008-style" stress scenario, IG BBB spreads widened approximately:',
        options: ['50-75 bps', '100-150 bps', '250-400 bps', '500-800 bps'],
        correct: 2,
        explanation: 'During the 2008-2009 crisis, BBB IG spreads widened from approximately 200bps to 600+ bps, a widening of approximately 300-400+ bps. This was an extreme but real scenario that stress tests should capture.'
      },
      {
        q: 'A default shock assumes 3% of a $500M portfolio defaults with 35% recovery. The estimated loss is:',
        options: ['$5.25M', '$9.75M', '$15.00M', '$7.50M'],
        correct: 1,
        explanation: 'Default Loss = 3% x (1 - 35%) x $500M = 0.03 x 0.65 x $500M = $9.75M. The recovery rate reduces the loss from the full face value; a 35% recovery means 65% is lost on each defaulted position.'
      },
      {
        q: 'Why does the "combined worst case" often OVERESTIMATE actual crisis losses for IG portfolios?',
        options: ['Because convexity is ignored', 'Because in reality, rates typically fall during credit crises, partially offsetting spread losses', 'Because default rates for IG are always zero', 'Because spread duration decreases during a crisis'],
        correct: 1,
        explanation: 'In a real crisis, there is typically a "flight to quality" where Treasury yields decline (positive rate P&L) while credit spreads widen (negative spread P&L). Adding both a rate INCREASE and spread widening simultaneously is an extremely severe scenario that rarely occurs in practice for IG portfolios.'
      },
      {
        q: 'After running a stress test showing a 10% portfolio loss, the MOST appropriate risk management action is:',
        options: ['Immediately liquidate the entire portfolio', 'Verify the loss is within risk tolerance and assess hedging options', 'Ignore it because stress tests are hypothetical', 'Switch entirely to Treasury bonds'],
        correct: 1,
        explanation: 'The appropriate response is to evaluate whether the potential loss is within the fund\'s risk tolerance and available liquidity buffer, then assess cost-effective hedging options (e.g., Treasury futures for rate risk, CDS index for spread risk). Stress tests inform risk decisions — they should not trigger panic selling.'
      }
    ]
  },

  // ─── Section 10: Advanced Portfolio Metrics ───
  {
    id: 'section-10',
    number: 10,
    title: 'Advanced Portfolio Metrics',
    subtopics: ['Tracking error', 'Information ratio', 'Active spread exposure', 'Factor exposures'],
    lesson: `
      <h3>Measuring Portfolio Performance &amp; Risk</h3>
      <p>Advanced portfolio metrics go beyond simple return analysis to measure <strong>risk-adjusted performance</strong>, the quality of active management decisions, and the portfolio&rsquo;s risk profile relative to its benchmark.</p>

      <h4>Tracking Error (TE)</h4>
      <p>Tracking error measures the volatility of active returns (portfolio return minus benchmark return):</p>
      <div class="formula">TE = \\sigma(R_{portfolio} - R_{benchmark}) = \\sqrt{\\frac{1}{n-1}\\sum(r_{active,i} - \\bar{r}_{active})^2}</div>
      <p>Typical TE ranges for credit portfolios:</p>
      <table class="data-table">
        <thead><tr><th>Strategy</th><th>Typical TE (annualized)</th></tr></thead>
        <tbody>
          <tr><td>Passive/Index-replicating</td><td>10&ndash;30 bps</td></tr>
          <tr><td>Core (benchmark-aware)</td><td>50&ndash;150 bps</td></tr>
          <tr><td>Core Plus</td><td>150&ndash;300 bps</td></tr>
          <tr><td>Unconstrained</td><td>300&ndash;600 bps</td></tr>
        </tbody>
      </table>

      <h4>Information Ratio (IR)</h4>
      <p>The information ratio measures active return per unit of tracking error:</p>
      <div class="formula">IR = \\frac{R_{portfolio} - R_{benchmark}}{TE} = \\frac{Active\\ Return}{Tracking\\ Error}</div>
      <p>An IR above 0.50 is considered good; above 1.0 is exceptional. Negative IR means the manager destroyed value relative to the benchmark.</p>

      <h4>Sharpe Ratio</h4>
      <p>Measures total risk-adjusted return relative to the risk-free rate:</p>
      <div class="formula">Sharpe = \\frac{R_{portfolio} - R_f}{\\sigma_{portfolio}}</div>
      <p>A Sharpe ratio above 1.0 indicates strong risk-adjusted returns; above 2.0 is outstanding.</p>

      <h4>Maximum Drawdown</h4>
      <p>The largest peak-to-trough decline in portfolio value. This measures the worst historical experience:</p>
      <div class="formula">MaxDD = \\max_t \\left(\\frac{Peak_t - Trough_t}{Peak_t}\\right)</div>

      <div class="callout insight">
        <div class="callout-title">Key Insight</div>
        <p>Maximum drawdown is the metric that causes the most &ldquo;career risk&rdquo; for portfolio managers. A fund can have an excellent Sharpe ratio but lose clients due to a single deep drawdown. Managing drawdown risk is often more important than maximizing returns.</p>
      </div>

      <h4>Value at Risk (VaR) &amp; Expected Shortfall (ES)</h4>
      <p>Parametric VaR estimates the maximum expected loss at a given confidence level over a specified horizon, assuming normally distributed returns:</p>
      <div class="formula">VaR_{95\\%} = -(\\mu - 1.645 \\times \\sigma) \\times \\sqrt{horizon}</div>
      <p>Expected Shortfall (Conditional VaR) is the average loss in the tail beyond VaR:</p>
      <div class="formula">ES_{95\\%} = -(\\mu - \\frac{\\phi(1.645)}{0.05} \\times \\sigma) \\times \\sqrt{horizon}</div>
      <p>where &phi;(1.645) &asymp; 0.1031 is the standard normal PDF at the 95th percentile z-score.</p>

      <div class="callout definition">
        <div class="callout-title">Definition</div>
        <p><strong>Expected Shortfall</strong> (also called CVaR) answers: &ldquo;If we DO breach VaR, what is the average loss?&rdquo; It is always larger than VaR and is considered a more coherent risk measure because it captures tail risk.</p>
      </div>

      <h4>Factor Exposures</h4>
      <p>Modern portfolio analytics decompose risk and return into factor exposures:</p>
      <ul>
        <li><strong>Duration factor:</strong> exposure to interest rate changes</li>
        <li><strong>Spread factor:</strong> exposure to credit spread changes</li>
        <li><strong>Sector factor:</strong> over/underweight vs benchmark by sector</li>
        <li><strong>Quality factor:</strong> rating tilt (e.g., overweight BBB vs benchmark)</li>
      </ul>

      <div class="callout warning">
        <div class="callout-title">Warning</div>
        <p>Parametric VaR assumes normal distributions, but credit returns have fat tails (excess kurtosis). In practice, actual 95th percentile losses are 20&ndash;40% larger than parametric VaR suggests. Always supplement with historical VaR or stress testing.</p>
      </div>
    `,
    example: {
      title: 'Comprehensive Portfolio Performance Analysis',
      given: `
        <p>12-month performance data for a corporate bond portfolio vs its benchmark:</p>
        <table class="data-table">
          <thead><tr><th>Month</th><th>Portfolio (%)</th><th>Benchmark (%)</th><th>Active (%)</th></tr></thead>
          <tbody>
            <tr><td>Jan</td><td>+0.45</td><td>+0.35</td><td>+0.10</td></tr>
            <tr><td>Feb</td><td>-0.20</td><td>-0.15</td><td>-0.05</td></tr>
            <tr><td>Mar</td><td>+0.65</td><td>+0.55</td><td>+0.10</td></tr>
            <tr><td>Apr</td><td>+0.30</td><td>+0.25</td><td>+0.05</td></tr>
            <tr><td>May</td><td>-0.55</td><td>-0.40</td><td>-0.15</td></tr>
            <tr><td>Jun</td><td>+0.80</td><td>+0.70</td><td>+0.10</td></tr>
            <tr><td>Jul</td><td>+0.15</td><td>+0.20</td><td>-0.05</td></tr>
            <tr><td>Aug</td><td>-0.35</td><td>-0.25</td><td>-0.10</td></tr>
            <tr><td>Sep</td><td>+0.50</td><td>+0.45</td><td>+0.05</td></tr>
            <tr><td>Oct</td><td>+0.25</td><td>+0.20</td><td>+0.05</td></tr>
            <tr><td>Nov</td><td>-0.10</td><td>-0.05</td><td>-0.05</td></tr>
            <tr><td>Dec</td><td>+0.40</td><td>+0.35</td><td>+0.05</td></tr>
          </tbody>
        </table>
      `,
      assumptions: `
        <ul>
          <li>Monthly returns are simple percentage changes</li>
          <li>Annualize by multiplying monthly mean by 12, monthly vol by &radic;12</li>
          <li>Risk-free rate: 4.50% annualized (0.375% monthly)</li>
          <li>VaR and ES computed using parametric (normal distribution) method</li>
        </ul>
      `,
      steps: `
        <h4>Step 1: Basic Return Statistics</h4>
        <p>Portfolio monthly returns: [0.45, -0.20, 0.65, 0.30, -0.55, 0.80, 0.15, -0.35, 0.50, 0.25, -0.10, 0.40]</p>
        <div class="formula">Portfolio\\ Mean_{monthly} = (0.45 - 0.20 + 0.65 + 0.30 - 0.55 + 0.80 + 0.15 - 0.35 + 0.50 + 0.25 - 0.10 + 0.40) / 12</div>
        <div class="formula">= 2.30 / 12 = 0.1917\\%\\ monthly = 2.30\\%\\ annualized</div>
        <p>Benchmark: Sum = 2.20%, Mean = 0.1833% monthly = 2.20% annualized</p>

        <h4>Step 2: Tracking Error</h4>
        <p>Active returns: [0.10, -0.05, 0.10, 0.05, -0.15, 0.10, -0.05, -0.10, 0.05, 0.05, -0.05, 0.05]</p>
        <div class="formula">Mean_{active} = 0.10 / 12 = 0.00833\\%</div>
        <p>Variance of active returns:</p>
        <div class="formula">\\sigma^2_{active} = \\frac{1}{11} \\sum (r_i - \\bar{r})^2 = \\frac{1}{11}(0.00764) = 0.000695\\%^2</div>
        <div class="formula">\\sigma_{active,monthly} = 0.0834\\%</div>
        <div class="formula">TE_{annual} = 0.0834\\% \\times \\sqrt{12} = 0.289\\% \\approx 29\\ bps</div>

        <h4>Step 3: Information Ratio</h4>
        <div class="formula">Active\\ Return_{annual} = 2.30\\% - 2.20\\% = 0.10\\%</div>
        <div class="formula">IR = \\frac{0.10\\%}{0.289\\%} = 0.35</div>

        <h4>Step 4: Portfolio Volatility &amp; Sharpe Ratio</h4>
        <div class="formula">\\sigma_{port,monthly} = 0.393\\% \\quad \\Rightarrow \\quad \\sigma_{port,annual} = 0.393\\% \\times \\sqrt{12} = 1.361\\%</div>
        <div class="formula">Sharpe = \\frac{2.30\\% - 4.50\\%}{1.361\\%} = \\frac{-2.20\\%}{1.361\\%} = -1.62</div>
        <p><em>Note: The negative Sharpe reflects that the portfolio returned less than the risk-free rate. In a rising rate environment, bond portfolios often have negative Sharpe ratios on a total return basis despite positive excess returns over benchmarks.</em></p>

        <h4>Step 5: Maximum Drawdown</h4>
        <p>Cumulative returns: +0.45, +0.25, +0.90, +1.20, +0.65, +1.45, +1.60, +1.25, +1.75, +2.00, +1.90, +2.30</p>
        <p>Peak at month 6: +1.45, Trough next at month 8: +1.25 (but month 5 trough of +0.65 from peak of +1.20 is larger)</p>
        <div class="formula">MaxDD = Peak_{month4}(1.20) - Trough_{month5}(0.65) = 0.55\\%</div>

        <h4>Step 6: VaR and Expected Shortfall (95%, 1-month)</h4>
        <div class="formula">VaR_{95\\%} = -(0.1917\\% - 1.645 \\times 0.393\\%) = -(0.1917\\% - 0.646\\%) = -(-0.4546\\%) = 0.455\\%</div>
        <div class="formula">ES_{95\\%} = -(0.1917\\% - \\frac{0.1031}{0.05} \\times 0.393\\%) = -(0.1917\\% - 2.0620 \\times 0.393\\%)</div>
        <div class="formula">ES_{95\\%} = -(0.1917\\% - 0.8104\\%) = 0.619\\%</div>
      `,
      result: `
        <div class="result-box">
          <div><span class="result-label">Annual Portfolio Return:</span> <span class="result-value text-green">+2.30%</span></div>
          <div><span class="result-label">Annual Benchmark Return:</span> <span class="result-value">+2.20%</span></div>
          <div><span class="result-label">Active Return:</span> <span class="result-value text-green">+10 bps</span></div>
          <div><span class="result-label">Tracking Error (annualized):</span> <span class="result-value">29 bps</span></div>
          <div><span class="result-label">Information Ratio:</span> <span class="result-value">0.35</span></div>
          <div><span class="result-label">Portfolio Vol (annualized):</span> <span class="result-value">1.36%</span></div>
          <div><span class="result-label">Sharpe Ratio:</span> <span class="result-value text-red">-1.62</span></div>
          <div><span class="result-label">Maximum Drawdown:</span> <span class="result-value text-red">-0.55%</span></div>
          <div><span class="result-label">95% Monthly VaR:</span> <span class="result-value">0.45%</span></div>
          <div><span class="result-label">95% Monthly ES:</span> <span class="result-value">0.62%</span></div>
        </div>
      `,
      interpretation: `
        <p>The portfolio generated 10 bps of active return with 29 bps of tracking error, yielding an information ratio of 0.35&mdash;moderate but below the 0.50 threshold considered &ldquo;good.&rdquo; The negative Sharpe ratio reflects the challenging absolute return environment when bonds underperform cash.</p>
        <p>The maximum drawdown of 0.55% is modest for a credit portfolio, suggesting conservative positioning. The 95% VaR of 0.45% means there is a 5% chance of losing more than 0.45% in any given month; if that tail event occurs, the expected average loss (ES) would be 0.62%.</p>
        <div class="callout insight">
          <div class="callout-title">Key Insight</div>
          <p>The IR of 0.35 suggests the manager is adding value, but inconsistently. To improve, the manager could: (1) increase conviction on highest-confidence positions, (2) reduce uncompensated active bets, or (3) accept higher tracking error to exploit more alpha opportunities. The low TE of 29 bps suggests this is a tightly benchmark-constrained strategy.</p>
        </div>
      `
    },
    calcId: 'advanced-metrics',
    calcTitle: 'Performance Metrics Module',
    calcFields: [
      { id: 'portfolioAnnReturn', label: 'Portfolio Annual Return (%)', type: 'number', default: 5.20, step: 0.1, min: -30, max: 50 },
      { id: 'portfolioAnnVol', label: 'Portfolio Annual Vol (%)', type: 'number', default: 4.50, step: 0.1, min: 0.1, max: 50 },
      { id: 'benchmarkAnnReturn', label: 'Benchmark Annual Return (%)', type: 'number', default: 4.80, step: 0.1, min: -30, max: 50 },
      { id: 'benchmarkAnnVol', label: 'Benchmark Annual Vol (%)', type: 'number', default: 4.20, step: 0.1, min: 0.1, max: 50 },
      { id: 'correlation', label: 'Port-Bench Correlation', type: 'number', default: 0.95, step: 0.01, min: -1, max: 1 },
      { id: 'riskFreeRate', label: 'Risk-Free Rate (%)', type: 'number', default: 4.50, step: 0.1, min: 0, max: 15 }
    ],
    calcPreset: { name: 'Example: IG Credit Fund', values: { portfolioAnnReturn: 5.20, portfolioAnnVol: 4.50, benchmarkAnnReturn: 4.80, benchmarkAnnVol: 4.20, correlation: 0.95, riskFreeRate: 4.50 } },
    calcCompute: function(vals) {
      var activeReturn = vals.portfolioAnnReturn - vals.benchmarkAnnReturn;
      var teSquared = Math.pow(vals.portfolioAnnVol / 100, 2) + Math.pow(vals.benchmarkAnnVol / 100, 2) - 2 * vals.correlation * (vals.portfolioAnnVol / 100) * (vals.benchmarkAnnVol / 100);
      var te = Math.sqrt(Math.max(teSquared, 0)) * 100;
      var ir = te > 0 ? activeReturn / te : 0;
      var sharpe = vals.portfolioAnnVol > 0 ? (vals.portfolioAnnReturn - vals.riskFreeRate) / vals.portfolioAnnVol : 0;
      var benchSharpe = vals.benchmarkAnnVol > 0 ? (vals.benchmarkAnnReturn - vals.riskFreeRate) / vals.benchmarkAnnVol : 0;
      var monthlyMean = vals.portfolioAnnReturn / 12;
      var monthlyVol = vals.portfolioAnnVol / Math.sqrt(12);
      var varZ = 1.645;
      var monthlyVaR = -(monthlyMean - varZ * monthlyVol);
      var esMultiplier = 0.1031 / 0.05;
      var monthlyES = -(monthlyMean - esMultiplier * monthlyVol);
      var annualVaR = -(vals.portfolioAnnReturn - varZ * vals.portfolioAnnVol);
      var annualES = -(vals.portfolioAnnReturn - esMultiplier * vals.portfolioAnnVol);
      var maxDDEstimate = 2.5 * vals.portfolioAnnVol;
      return [
        { label: 'Active Return', value: activeReturn.toFixed(2), unit: '%' },
        { label: 'Tracking Error', value: te.toFixed(2), unit: '%' },
        { label: 'Information Ratio', value: ir.toFixed(2), unit: '' },
        { label: 'Sharpe Ratio (Portfolio)', value: sharpe.toFixed(2), unit: '' },
        { label: 'Sharpe Ratio (Benchmark)', value: benchSharpe.toFixed(2), unit: '' },
        { label: '95% Monthly VaR', value: monthlyVaR.toFixed(2), unit: '%' },
        { label: '95% Monthly ES', value: monthlyES.toFixed(2), unit: '%' },
        { label: '95% Annual VaR', value: annualVaR.toFixed(2), unit: '%' },
        { label: '95% Annual ES', value: annualES.toFixed(2), unit: '%' },
        { label: 'Est. Max Drawdown (2.5x vol)', value: maxDDEstimate.toFixed(2), unit: '%' },
        { label: 'IR Quality', value: Math.abs(ir) >= 1.0 ? 'Exceptional' : Math.abs(ir) >= 0.5 ? 'Good' : Math.abs(ir) >= 0.25 ? 'Moderate' : 'Weak', unit: '' }
      ];
    },
    drawChart: function(container) {
      var ctx = Chart.create(700, 420, { top: 40, right: 30, bottom: 60, left: 60 });
      var bins = [];
      var mean = 0.19;
      var vol = 0.39;
      for (var i = 0; i < 30; i++) {
        var x = -1.5 + i * 0.1;
        var z = (x - mean) / vol;
        var count = Math.exp(-0.5 * z * z) / (vol * Math.sqrt(2 * Math.PI)) * 3;
        bins.push({ count: Math.max(count, 0) });
      }
      var maxCount = 0;
      for (var i = 0; i < bins.length; i++) {
        if (bins[i].count > maxCount) maxCount = bins[i].count;
      }
      for (var i = 0; i < bins.length; i++) {
        bins[i].count = bins[i].count / maxCount;
      }
      Chart.histogram(ctx, bins, '#2b402f');
      var varPos = (-(-0.45) - (-1.5)) / (1.5 - (-1.5));
      Chart.addMarker(ctx, 1 - varPos, '95% VaR\n(-0.45%)', '#c4453a');
      var esPos = (-(-0.62) - (-1.5)) / (1.5 - (-1.5));
      Chart.addMarker(ctx, 1 - esPos, '95% ES\n(-0.62%)', '#5a8c62');
      var titleEl = Chart.el('text', { x: 350, y: 25, 'text-anchor': 'middle', fill: '#1a1414', 'font-size': '14px', 'font-weight': 'bold' });
      titleEl.textContent = 'Monthly Return Distribution with VaR & ES';
      ctx.svg.appendChild(titleEl);
      container.appendChild(ctx.svg);
    },
    quiz: [
      {
        q: 'A portfolio has annualized active return of +40 bps and tracking error of 80 bps. The information ratio is:',
        options: ['0.20', '0.50', '2.00', '0.40'],
        correct: 1,
        explanation: 'IR = Active Return / Tracking Error = 40bps / 80bps = 0.50. This is considered a "good" information ratio, indicating the manager generates meaningful alpha per unit of active risk taken.'
      },
      {
        q: 'Which statement about Expected Shortfall (ES) vs VaR is TRUE?',
        options: ['ES is always smaller than VaR because it averages over a narrower tail', 'ES measures the average loss when VaR is breached, making it always larger than VaR', 'ES and VaR converge to the same value as the confidence level approaches 100%', 'ES is less useful than VaR because it is more sensitive to extreme outliers in the data'],
        correct: 1,
        explanation: 'ES (Conditional VaR) is the expected loss given that the VaR threshold has been breached. By definition, it is always larger than VaR because it averages the tail losses beyond the VaR cutoff. For the 95% level, ES is typically 20-30% larger than VaR under normality.'
      },
      {
        q: 'A corporate bond portfolio has a monthly VaR (95%) of 1.2%. The BEST interpretation is:',
        options: ['The portfolio will lose exactly 1.2% each month', 'There is a 95% probability that the monthly loss will not exceed 1.2%', 'The average monthly loss is 1.2%', 'There is a 5% probability of gaining more than 1.2%'],
        correct: 1,
        explanation: 'VaR at 95% confidence means there is a 95% probability that the loss will not exceed 1.2% in any given month. Equivalently, there is a 5% chance (roughly 1 month in 20) that the loss WILL exceed 1.2%. VaR says nothing about how large the loss could be beyond this threshold.'
      },
      {
        q: 'A manager achieves a Sharpe ratio of 0.8 and an information ratio of 1.2. This most likely indicates:',
        options: ['The manager takes too much absolute risk', 'The manager adds significant value through security selection relative to the benchmark, even if absolute returns are moderate', 'The portfolio is poorly diversified', 'The benchmark is easy to beat'],
        correct: 1,
        explanation: 'An IR of 1.2 is exceptional, indicating the manager generates substantial active return per unit of tracking error. The moderate Sharpe of 0.8 is respectable but reflects the broader market environment. This combination suggests strong security selection and sector allocation skills within a benchmark-aware framework.'
      },
      {
        q: 'An IG credit portfolio has maximum drawdown of 8.5%. In the context of historical performance, this is:',
        options: ['Very low — typical IG drawdowns are much larger', 'Moderate — consistent with a significant market stress event like Q1 2020', 'Extremely high — IG portfolios should never lose more than 2%', 'Irrelevant — maximum drawdown is not a useful metric for bond portfolios'],
        correct: 1,
        explanation: 'An 8.5% max drawdown for IG is significant and consistent with a moderate-to-severe stress event. For context: the Bloomberg IG Index fell ~10% in Q1 2020 and ~16% in 2022. Drawdowns of 5-10% occur roughly once every 3-5 years in IG credit. Managers are expected to keep drawdowns below the benchmark drawdown.'
      }
    ]
  }
];
/* ============================================================
   PART 4: CAPSTONE DATA, RENDERING ENGINE, QUIZ ENGINE,
   PROGRESS MANAGER, NAVIGATION, TOOLS, INITIALIZATION
   ============================================================ */

/* ------------------------------------------------------------
   1. CAPSTONE DATA
   ------------------------------------------------------------ */
const CAPSTONE_DATA = {
  title: 'Capstone: Portfolio Case Study',
  intro: `<p>You are a junior portfolio manager at a mid-sized asset management firm. Your mandate is to construct
    and manage a USD investment-grade corporate bond portfolio benchmarked to the Bloomberg US Corporate Bond Index.
    The portfolio must target a duration of 5&ndash;6 years, maintain a minimum average credit quality of A&minus;/BBB+,
    and generate excess return through sector allocation, security selection, and active duration management.</p>
    <p>In this capstone exercise, you will:</p>
    <ol>
      <li><strong>Phase 1 &mdash; Portfolio Construction:</strong> Review the 6-bond portfolio and compute key risk metrics.</li>
      <li><strong>Phase 2 &mdash; Stress Scenario:</strong> Apply a credit-crisis shock and observe the impact on the portfolio.</li>
      <li><strong>Phase 3 &mdash; Performance Attribution:</strong> Decompose the quarterly return into its components.</li>
      <li><strong>Phase 4 &mdash; Assessment:</strong> Answer 12 questions that test your ability to analyze and manage the portfolio.</li>
    </ol>`,
  portfolio: [
    { name:'Goldman Sachs 4.25% 2027', coupon:4.25, maturity:3, ytm:5.10, spread:85, rating:'A', sector:'Financials', weight:0.20 },
    { name:'Apple 3.85% 2028', coupon:3.85, maturity:4, ytm:4.75, spread:52, rating:'AA', sector:'Technology', weight:0.15 },
    { name:'AT&T 5.40% 2029', coupon:5.40, maturity:5, ytm:5.80, spread:155, rating:'BBB', sector:'Communications', weight:0.15 },
    { name:'JPMorgan 4.95% 2031', coupon:4.95, maturity:7, ytm:5.55, spread:130, rating:'A', sector:'Financials', weight:0.20 },
    { name:'Ford Motor 6.20% 2032', coupon:6.20, maturity:8, ytm:6.75, spread:250, rating:'BBB-', sector:'Industrials', weight:0.15 },
    { name:'Duke Energy 4.60% 2034', coupon:4.60, maturity:10, ytm:5.35, spread:110, rating:'A-', sector:'Utilities', weight:0.15 }
  ],
  shock: {
    description: 'Credit crisis scenario: Treasury rates rise +75bp across the curve, credit spreads widen +60bp on average (IG) and +120bp on BBB/BBB-, and 1.5% of BBB-rated holdings default with 35% recovery.',
    rateShock: 75,
    spreadShockIG: 60,
    spreadShockHY: 120,
    defaultRate: 0.015,
    recoveryRate: 0.35
  },
  attribution: {
    carry: 0.68,
    rollDown: 0.12,
    spreadPnL: -3.85,
    ratePnL: -4.72,
    defaultLoss: -0.24,
    totalReturn: -8.01
  },
  quiz: [
    {
      q: 'What is the approximate weighted average duration of the capstone portfolio?',
      options: ['3.8 years', '5.0 years', '6.1 years', '7.4 years'],
      correct: 1,
      explanation: 'Weighting each bond\'s modified duration by its portfolio weight: GS ~2.8Y\u00d720% + Apple ~3.7Y\u00d715% + AT&T ~4.3Y\u00d715% + JPM ~5.8Y\u00d720% + Ford ~6.2Y\u00d715% + Duke ~7.8Y\u00d715% \u2248 5.0 years. The overweight to shorter-duration Financials (3Y and 7Y) keeps the portfolio duration near the lower end of a 5\u20136Y mandate.'
    },
    {
      q: 'Which sector has the largest allocation in the portfolio?',
      options: ['Technology', 'Financials', 'Industrials', 'Communications'],
      correct: 1,
      explanation: 'Financials (Goldman Sachs 20% + JPMorgan 20% = 40%) is the largest sector allocation.'
    },
    {
      q: 'Under the shock scenario, which risk factor contributes the most to portfolio losses?',
      options: ['Default losses', 'Spread widening', 'Interest rate increase', 'Liquidity deterioration'],
      correct: 1,
      explanation: 'With the differentiated spread shocks (+60bp for IG, +120bp for BBB/BBB-), the weighted spread P&L (~-4.0%) slightly exceeds the rate P&L (~-3.8%) despite the uniform +75bp rate shock. The BBB- and BBB positions absorb disproportionate spread losses due to both wider shocks and longer durations. Default losses are a distant third. This illustrates why credit spread risk often dominates in stress scenarios with differentiated spread shocks by rating tier.'
    },
    {
      q: 'The Ford Motor bond (BBB-) is subject to the default shock. What is the approximate loss from this position?',
      options: ['-0.15%', '-0.24%', '-0.98%', '-1.46%'],
      correct: 0,
      explanation: 'Ford weight is 15%, default rate is 1.5%, LGD is 65% (1-35% recovery). Loss = 15% \u00d7 1.5% \u00d7 65% \u2248 0.15% of portfolio.'
    },
    {
      q: 'After the shock, which action would BEST reduce the portfolio risk profile?',
      options: [
        'Increase duration by adding 30Y bonds',
        'Reduce BBB- exposure and rotate into A-rated names',
        'Concentrate further into Financials for higher spread',
        'Add more BBB- bonds at wider spreads to increase carry'
      ],
      correct: 1,
      explanation: 'Reducing exposure to the most stressed rating bucket (BBB-) and rotating into higher quality names reduces both spread risk and default risk. The other options would increase risk.'
    },
    {
      q: 'The carry component of +0.68% over the quarter primarily reflects:',
      options: [
        'Price appreciation from spread tightening',
        'Coupon income minus funding costs',
        'Roll-down return from the yield curve shape',
        'Recovery value from defaulted bonds'
      ],
      correct: 1,
      explanation: 'Carry represents the income component: coupon payments received minus the cost of funding the positions. It is positive because portfolio coupons exceed the funding rate.'
    },
    {
      q: 'If spreads had tightened by 20bp instead of widening, the spread P&L would have been approximately:',
      options: ['+1.00%', '+1.24%', '+0.62%', '+2.48%'],
      correct: 0,
      explanation: 'With a portfolio spread duration of approximately 5.0 years, a 20bp tightening would produce roughly +5.0 \u00d7 0.20% = +1.00% P&L from spread changes. Spread tightening is beneficial for long credit positions.'
    },
    {
      q: 'The portfolio has 40% in Financials. This concentration is most concerning because:',
      options: [
        'Financials always underperform in rate hikes',
        'It creates sector-specific systematic risk that diversification cannot mitigate within the sector',
        'Financial bonds have the longest durations',
        'The sector has the lowest recovery rates'
      ],
      correct: 1,
      explanation: 'A 40% concentration in one sector means the portfolio is heavily exposed to sector-specific shocks (regulatory changes, banking crises) that affect all Financials simultaneously. This is undiversifiable within-sector risk.'
    },
    {
      q: 'What is the portfolio information ratio if the benchmark returned -5.5% in the same scenario and tracking error is 1.8%?',
      options: ['-1.39', '-0.72', '-2.78', '0.28'],
      correct: 0,
      explanation: 'IR = (Portfolio return - Benchmark return) / Tracking Error = (-8.01% - (-5.5%)) / 1.8% = -2.51% / 1.8% \u2248 -1.39. The portfolio underperformed the benchmark on a risk-adjusted basis.'
    },
    {
      q: 'To immunize the portfolio against parallel rate shifts while maintaining spread exposure, you should:',
      options: [
        'Buy Treasury futures to offset interest rate duration',
        'Sell all bonds and hold cash',
        'Switch entirely to floating-rate notes',
        'Increase convexity by buying options'
      ],
      correct: 0,
      explanation: 'Treasury futures hedging offsets the interest rate component of duration while preserving the credit spread exposure (spread duration), allowing the PM to isolate the credit bet from rate risk.'
    },
    {
      q: 'If the portfolio VaR (95%, monthly) is estimated at 2.8%, what does this mean?',
      options: [
        'The portfolio will lose exactly 2.8% each month',
        'There is a 5% probability of losing more than 2.8% in a given month',
        'The maximum possible loss is 2.8%',
        'The portfolio volatility is 2.8%'
      ],
      correct: 1,
      explanation: 'VaR at 95% confidence means there is a 5% probability (1 in 20 months) that the portfolio loss will exceed the VaR amount. It is NOT the maximum loss \u2014 tail losses can be much larger (captured by Expected Shortfall).'
    },
    {
      q: 'Which metric would best capture the risk of extreme losses beyond the VaR threshold?',
      options: ['Tracking error', 'Information ratio', 'Expected Shortfall (CVaR)', 'Sharpe ratio'],
      correct: 2,
      explanation: 'Expected Shortfall (also called CVaR or Conditional VaR) measures the average loss in the tail beyond the VaR threshold. It captures the severity of extreme losses, unlike VaR which only marks the threshold.'
    }
  ]
};

/* ------------------------------------------------------------
   2. TOOLS PANEL DATA
   ------------------------------------------------------------ */
const TOOLS_LIST = [
  { id: 'section-1', name: 'Bond Price \u2194 YTM', desc: 'Price bonds and compute yield to maturity' },
  { id: 'section-1', name: 'Clean/Dirty Price', desc: 'Calculate accrued interest and dirty price' },
  { id: 'section-2', name: 'Spread Measures', desc: 'G-spread, I-spread, Z-spread, OAS' },
  { id: 'section-3', name: 'Credit Risk Model', desc: 'Hazard rates, PD, expected loss' },
  { id: 'section-4', name: 'Duration & Convexity', desc: 'Modified, Macaulay, spread duration, DV01' },
  { id: 'section-5', name: 'Curve Exposure', desc: 'Key rate durations and curve scenarios' },
  { id: 'section-6', name: 'Portfolio Optimizer', desc: 'Build portfolios with constraint checks' },
  { id: 'section-7', name: 'Risk Decomposition', desc: 'Decompose IR, spread, default, liquidity risk' },
  { id: 'section-8', name: 'Performance Attribution', desc: 'Carry, roll-down, spread, rate attribution' },
  { id: 'section-9', name: 'Stress Tester', desc: 'Rate shocks, spread shocks, default scenarios' },
  { id: 'section-10', name: 'Performance Metrics', desc: 'Sharpe, IR, VaR, ES, max drawdown' }
];

/* ------------------------------------------------------------
   3. STATE MANAGEMENT
   ------------------------------------------------------------ */
const State = {
  currentSection: 'section-1',
  quizScores: {},
  quizAnswers: {},
  capstoneScore: null,
  capstoneAnswers: [],

  save() {
    try {
      localStorage.setItem('corpbond-course', JSON.stringify({
        quizScores: this.quizScores,
        quizAnswers: this.quizAnswers,
        capstoneScore: this.capstoneScore,
        capstoneAnswers: this.capstoneAnswers,
        currentSection: this.currentSection
      }));
    } catch(e) { /* localStorage unavailable */ }
  },

  load() {
    try {
      const d = JSON.parse(localStorage.getItem('corpbond-course'));
      if (d) {
        Object.assign(this, d);
      }
    } catch(e) { /* corrupt or unavailable */ }
  },

  getCompletedCount() {
    let c = Object.keys(this.quizScores).length;
    if (this.capstoneScore !== null) c++;
    return c;
  },

  reset() {
    this.currentSection = 'section-1';
    this.quizScores = {};
    this.quizAnswers = {};
    this.capstoneScore = null;
    this.capstoneAnswers = [];
    try {
      localStorage.removeItem('corpbond-course');
    } catch(e) { /* localStorage unavailable */ }
  }
};

/* ------------------------------------------------------------
   4. RENDERING ENGINE
   ------------------------------------------------------------ */
const Renderer = {

  /* ----- Navigation sidebar ----- */
  renderNav() {
    const navList = document.getElementById('navList');
    navList.innerHTML = '';

    // Section nav items
    SECTIONS.forEach((sec, idx) => {
      const li = document.createElement('li');
      li.className = 'nav-item';
      li.dataset.section = sec.id;
      li.onclick = function() { navigate(sec.id); };
      li.innerHTML = `<span class="nav-num">${String(idx + 1).padStart(2, '0')}</span>` +
        `<span class="nav-dot" id="dot-${sec.id}"></span>` +
        `<span>${sec.title}</span>`;
      navList.appendChild(li);
    });

    // Divider
    const div1 = document.createElement('li');
    div1.className = 'nav-divider';
    navList.appendChild(div1);

    // Capstone
    const capLi = document.createElement('li');
    capLi.className = 'nav-item';
    capLi.dataset.section = 'capstone';
    capLi.onclick = function() { navigate('capstone'); };
    capLi.innerHTML = '<span class="nav-num">\u2605</span>' +
      '<span class="nav-dot" id="dot-capstone"></span>' +
      '<span>Capstone Case Study</span>';
    navList.appendChild(capLi);

    // Divider
    const div2 = document.createElement('li');
    div2.className = 'nav-divider';
    navList.appendChild(div2);

    // Tools
    const toolLi = document.createElement('li');
    toolLi.className = 'nav-item';
    toolLi.dataset.section = 'tools';
    toolLi.onclick = function() { navigate('tools'); };
    toolLi.innerHTML = '<span class="nav-num">\u2692</span>' +
      '<span class="nav-dot"></span>' +
      '<span>All Tools</span>';
    navList.appendChild(toolLi);
  },

  /* ----- Render a single section ----- */
  renderSection(section) {
    const view = document.createElement('div');
    view.id = section.id;
    view.className = 'section-view';

    // Section header
    const idx = SECTIONS.indexOf(section);
    const topicTags = (section.subtopics || section.topics || []).map(t => `<span class="topic-tag">${t}</span>`).join('');
    let html = `<div class="section-header">
      <div class="section-number">Section ${String(idx + 1).padStart(2, '0')}</div>
      <h1 class="section-title">${section.title}</h1>
      <div class="section-topics">${topicTags}</div>
    </div>`;

    // Tab bar
    html += `<div class="tab-bar">
      <button class="tab-btn active" data-tab="lesson" onclick="switchTab('${section.id}','lesson')">Lesson</button>
      <button class="tab-btn" data-tab="example" onclick="switchTab('${section.id}','example')">Example</button>
      <button class="tab-btn" data-tab="calculator" onclick="switchTab('${section.id}','calculator')">Calculator</button>
      <button class="tab-btn" data-tab="quiz" onclick="switchTab('${section.id}','quiz')">Quiz</button>
    </div>`;

    // ---- Lesson panel ----
    html += `<div class="tab-panel active" data-tab="lesson">
      <div class="lesson">${section.lesson || ''}</div>
    </div>`;

    // ---- Example panel ----
    html += '<div class="tab-panel" data-tab="example">';
    if (section.example) {
      const ex = section.example;
      html += `<div class="example-block">
        <div class="example-header">${ex.title || 'Worked Example'}</div>
        <div class="example-body">`;
      if (ex.given) {
        html += `<div class="example-section">
          <div class="example-section-title">Given</div>
          ${ex.given}
        </div>`;
      }
      if (ex.assumptions) {
        html += `<div class="example-section">
          <div class="example-section-title">Assumptions</div>
          ${ex.assumptions}
        </div>`;
      }
      if (ex.steps) {
        const stepsId = section.id + '-steps';
        html += `<div class="example-section">
          <div class="example-section-title">Computation Steps</div>
          <button class="steps-toggle" onclick="(function(){
            var el=document.getElementById('${stepsId}');
            el.classList.toggle('open');
            this.textContent=el.classList.contains('open')?'Hide Steps':'Show Steps';
          }).call(this)">Show Steps</button>
          <div class="steps-content" id="${stepsId}">`;
        if (typeof ex.steps === 'string') {
          html += ex.steps;
        } else if (Array.isArray(ex.steps)) {
          ex.steps.forEach((step, si) => {
            html += `<div style="margin-bottom:12px;"><strong style="color:var(--accent-teal);">Step ${si + 1}:</strong> ${step}</div>`;
          });
        }
        html += '</div></div>';
      }
      if (ex.result) {
        html += `<div class="result-box">
          <div class="result-label">Result</div>
          <div class="result-value">${ex.result}</div>
        </div>`;
      }
      if (ex.interpretation) {
        html += `<div class="interpretation">${ex.interpretation}</div>`;
      }
      html += '</div></div>';
    }
    html += '</div>';

    // ---- Calculator panel ----
    const calcId = section.id + '-calc';
    const resultsId = section.id + '-results';
    const chartId = section.id + '-chart';
    html += '<div class="tab-panel" data-tab="calculator">';
    html += '<div class="calc-container">';
    html += `<div class="calc-header">
      <span class="calc-title">${section.calcTitle || section.title + ' Calculator'}</span>
    </div>`;
    html += '<div class="calc-body">';

    // Fields
    if (section.calcFields && section.calcFields.length > 0) {
      html += '<div class="calc-fields">';
      section.calcFields.forEach(f => {
        html += `<div class="calc-field">
          <label for="${calcId}-${f.id}">${f.label}</label>`;
        if (f.type === 'select' && f.options) {
          html += `<select id="${calcId}-${f.id}">`;
          f.options.forEach(opt => {
            const val = typeof opt === 'object' ? opt.value : opt;
            const lbl = typeof opt === 'object' ? opt.label : opt;
            html += `<option value="${val}">${lbl}</option>`;
          });
          html += '</select>';
        } else if (f.type === 'range') {
          const min = f.min !== undefined ? f.min : 0;
          const max = f.max !== undefined ? f.max : 100;
          const step = f.step !== undefined ? f.step : 1;
          const def = f.default !== undefined ? f.default : min;
          html += `<span class="range-val" id="${calcId}-${f.id}-val">${def}</span>`;
          html += `<input type="range" id="${calcId}-${f.id}" min="${min}" max="${max}" step="${step}" value="${def}" oninput="document.getElementById('${calcId}-${f.id}-val').textContent=this.value">`;
        } else {
          const inputType = f.type || 'number';
          const def = f.default !== undefined ? f.default : '';
          const stepAttr = f.step !== undefined ? ` step="${f.step}"` : ' step="any"';
          html += `<input type="${inputType}" id="${calcId}-${f.id}" value="${def}"${inputType === 'number' ? stepAttr : ''} placeholder="${f.placeholder || ''}">`;
        }
        html += '</div>';
      });
      html += '</div>';
    }

    // Buttons
    html += '<div class="calc-actions">';
    html += `<button class="btn btn-primary" onclick="runCalc('${section.id}')">Compute</button>`;
    html += `<button class="btn btn-secondary" onclick="loadPreset('${section.id}')">Load Example</button>`;
    html += '</div>';

    // Results area
    html += `<div class="calc-results" id="${resultsId}">
      <h4>Results</h4>
      <div class="result-grid" id="${resultsId}-grid"></div>
    </div>`;

    html += '</div></div>'; // close calc-body, calc-container

    // Chart area
    html += `<div class="chart-container" id="${chartId}" style="margin-top:16px;"></div>`;
    html += '</div>'; // close calculator tab-panel

    // ---- Quiz panel ----
    html += '<div class="tab-panel" data-tab="quiz">';
    html += this._renderQuizHTML(section.id, section.quiz || []);
    html += '</div>';

    view.innerHTML = html;
    return view;
  },

  /* ----- Quiz HTML generator (shared for section & capstone) ----- */
  _renderQuizHTML(quizId, questions) {
    if (!questions || questions.length === 0) return '<p class="text-muted">No quiz for this section.</p>';

    const prevAnswers = (quizId === 'capstone') ? State.capstoneAnswers : (State.quizAnswers[quizId] || []);
    const hasAnyAnswer = prevAnswers.some(function(a) { return a !== undefined && a !== null; });

    let html = '<div class="quiz-container">';
    html += `<div class="quiz-header">
      <h3 style="font-family:Consolas,monospace;color:var(--accent-gold);font-size:1rem;">Knowledge Check</h3>
      <div style="display:flex;align-items:center;gap:12px;">`;
    if (hasAnyAnswer) {
      html += `<button class="btn btn-danger" onclick="resetSectionQuiz('${quizId}')" style="font-size:0.7rem;padding:5px 10px;">Reset Quiz</button>`;
    }
    html += `<div class="quiz-score" id="score-${quizId}">`;
    if (hasAnyAnswer) {
      const sc = (quizId === 'capstone') ? State.capstoneScore : (State.quizScores[quizId] || {});
      const correct = (quizId === 'capstone') ? (sc || 0) : (sc.correct || 0);
      const total = questions.length;
      html += `<span class="score-val">${correct}</span> / ${total}`;
    } else {
      html += `<span class="score-val">0</span> / ${questions.length}`;
    }
    html += '</div></div></div>';

    questions.forEach((qObj, qi) => {
      const qId = `${quizId}-q${qi}`;
      const prevAnswer = prevAnswers[qi];
      const answered = prevAnswer !== undefined && prevAnswer !== null;

      html += `<div class="quiz-question" id="${qId}">`;
      html += `<div class="qq-num" style="display:flex;justify-content:space-between;align-items:center;">` +
        `<span>Question ${qi + 1} of ${questions.length}</span>`;
      if (answered) {
        html += `<button class="btn btn-danger" onclick="resetSingleQuestion('${quizId}',${qi})" ` +
          `style="font-size:0.65rem;padding:3px 8px;">Retry</button>`;
      }
      html += '</div>';
      html += `<div class="qq-text">${qObj.q}</div>`;
      html += '<div class="qq-options">';
      qObj.options.forEach((opt, oi) => {
        let classes = 'qq-option';
        if (answered) {
          classes += ' disabled';
          if (oi === qObj.correct) classes += ' correct was-correct';
          else if (oi === prevAnswer && oi !== qObj.correct) classes += ' incorrect';
        }
        html += `<div class="${classes}" data-quiz="${quizId}" data-qi="${qi}" data-oi="${oi}" ` +
          `onclick="handleQuizAnswer(this,'${quizId}',${qi},${oi})">${String.fromCharCode(65 + oi)}. ${opt}</div>`;
      });
      html += '</div>';
      html += `<div class="qq-explanation${answered ? ' show' : ''}" id="${qId}-expl">${qObj.explanation}</div>`;
      html += '</div>';
    });

    html += '</div>';
    return html;
  },

  /* ----- Capstone section ----- */
  renderCapstone() {
    const view = document.createElement('div');
    view.id = 'capstone';
    view.className = 'section-view';

    const cap = CAPSTONE_DATA;
    const bonds = cap.portfolio;
    const weights = bonds.map(b => b.weight);

    // Pre-compute portfolio metrics
    const metrics = BondMath.portfolioMetrics(bonds, weights);

    // Compute sector allocations
    const sectorMap = {};
    bonds.forEach(b => {
      sectorMap[b.sector] = (sectorMap[b.sector] || 0) + b.weight;
    });

    // Compute shock impact per bond
    const shockResults = bonds.map(b => {
      const dur = BondMath.modifiedDuration(b.coupon, b.maturity, 100, b.ytm);
      const isHY = (b.rating === 'BBB' || b.rating === 'BBB-');
      const spreadShock = isHY ? cap.shock.spreadShockHY : cap.shock.spreadShockIG;
      const rateLoss = -dur * (cap.shock.rateShock / 10000) * b.weight;
      const spreadLoss = -dur * (spreadShock / 10000) * b.weight;
      const defaultLoss = (b.rating === 'BBB-') ? -b.weight * cap.shock.defaultRate * (1 - cap.shock.recoveryRate) : 0;
      return { name: b.name, dur: dur, rateLoss: rateLoss, spreadLoss: spreadLoss, defaultLoss: defaultLoss };
    });

    const totalRateLoss = shockResults.reduce((s, r) => s + r.rateLoss, 0);
    const totalSpreadLoss = shockResults.reduce((s, r) => s + r.spreadLoss, 0);
    const totalDefaultLoss = shockResults.reduce((s, r) => s + r.defaultLoss, 0);

    let html = `<div class="section-header">
      <div class="section-number">Capstone</div>
      <h1 class="section-title">${cap.title}</h1>
      <div class="section-topics">
        <span class="topic-tag">Portfolio Construction</span>
        <span class="topic-tag">Stress Testing</span>
        <span class="topic-tag">Attribution</span>
        <span class="topic-tag">Risk Management</span>
      </div>
    </div>`;

    html += `<div class="lesson" style="margin-bottom:24px;">${cap.intro}</div>`;

    /* ---- Phase 1: Portfolio Construction ---- */
    html += '<div class="capstone-phase">';
    html += '<h3>Phase 1: Portfolio Construction</h3>';
    html += `<p style="margin-bottom:16px;">The following 6-bond portfolio has been selected. Review the holdings and computed risk metrics.</p>`;

    // Portfolio table
    html += `<table class="data-table"><thead><tr>
      <th>Bond</th><th>Coupon</th><th>Maturity</th><th>YTM</th><th>Spread</th><th>Rating</th><th>Sector</th><th>Weight</th>
    </tr></thead><tbody>`;
    bonds.forEach(b => {
      html += `<tr>
        <td style="font-family:'Segoe UI',sans-serif;font-size:0.82rem;">${b.name}</td>
        <td>${b.coupon.toFixed(2)}%</td>
        <td>${b.maturity}Y</td>
        <td>${b.ytm.toFixed(2)}%</td>
        <td>${b.spread}bp</td>
        <td>${b.rating}</td>
        <td>${b.sector}</td>
        <td>${(b.weight * 100).toFixed(0)}%</td>
      </tr>`;
    });
    html += '</tbody></table>';

    // Portfolio metrics
    html += '<div class="dashboard-row">';
    html += `<div class="dash-widget"><div class="dw-label">Mod. Duration</div><div class="dw-value">${metrics.duration.toFixed(2)}</div><div class="dw-unit">years</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Convexity</div><div class="dw-value">${metrics.convexity.toFixed(1)}</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Avg Spread</div><div class="dw-value">${metrics.spread.toFixed(0)}</div><div class="dw-unit">bp</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Avg YTM</div><div class="dw-value">${metrics.ytm.toFixed(2)}</div><div class="dw-unit">%</div></div>`;
    html += '</div>';

    // Donut chart: sector allocation
    html += '<div class="chart-container" id="capstone-alloc-chart"><div class="chart-title">Sector Allocation</div></div>';
    html += '</div>'; // close phase 1

    /* ---- Phase 2: Stress Scenario ---- */
    html += '<div class="capstone-phase">';
    html += '<h3>Phase 2: Stress Scenario</h3>';
    html += `<div class="callout warning">
      <div class="callout-title">Shock Parameters</div>
      <p>${cap.shock.description}</p>
    </div>`;

    html += '<table class="data-table"><thead><tr><th>Bond</th><th>Duration</th><th>Rate P&L</th><th>Spread P&L</th><th>Default Loss</th></tr></thead><tbody>';
    shockResults.forEach(r => {
      html += `<tr>
        <td style="font-family:'Segoe UI',sans-serif;font-size:0.82rem;">${r.name}</td>
        <td>${r.dur.toFixed(2)}</td>
        <td class="text-red">${(r.rateLoss * 100).toFixed(2)}%</td>
        <td class="text-red">${(r.spreadLoss * 100).toFixed(2)}%</td>
        <td class="${r.defaultLoss < 0 ? 'text-red' : ''}">${(r.defaultLoss * 100).toFixed(3)}%</td>
      </tr>`;
    });
    html += '</tbody></table>';

    html += '<div class="dashboard-row">';
    html += `<div class="dash-widget"><div class="dw-label">Rate P&L</div><div class="dw-value text-red">${(totalRateLoss * 100).toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Spread P&L</div><div class="dw-value text-red">${(totalSpreadLoss * 100).toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Default Loss</div><div class="dw-value text-red">${(totalDefaultLoss * 100).toFixed(3)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Total Shock</div><div class="dw-value text-red">${((totalRateLoss + totalSpreadLoss + totalDefaultLoss) * 100).toFixed(2)}%</div></div>`;
    html += '</div>';

    // Bar chart: stress P&L by component
    html += '<div class="chart-container" id="capstone-stress-chart"><div class="chart-title">Stress P&L by Component</div></div>';
    html += '</div>'; // close phase 2

    /* ---- Phase 3: Performance Attribution ---- */
    html += '<div class="capstone-phase">';
    html += '<h3>Phase 3: Performance Attribution</h3>';
    html += '<p style="margin-bottom:16px;">Quarterly return decomposition based on the attribution model:</p>';

    const attr = cap.attribution;
    html += '<div class="dashboard-row">';
    html += `<div class="dash-widget"><div class="dw-label">Carry</div><div class="dw-value text-green">${attr.carry >= 0 ? '+' : ''}${attr.carry.toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Roll-Down</div><div class="dw-value text-green">${attr.rollDown >= 0 ? '+' : ''}${attr.rollDown.toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Spread P&L</div><div class="dw-value text-red">${attr.spreadPnL.toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Rate P&L</div><div class="dw-value text-red">${attr.ratePnL.toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Default Loss</div><div class="dw-value text-red">${attr.defaultLoss.toFixed(2)}%</div></div>`;
    html += `<div class="dash-widget"><div class="dw-label">Total Return</div><div class="dw-value text-red">${attr.totalReturn.toFixed(2)}%</div></div>`;
    html += '</div>';

    // Waterfall chart: attribution
    html += '<div class="chart-container" id="capstone-attr-chart"><div class="chart-title">Return Attribution Waterfall</div></div>';
    html += '</div>'; // close phase 3

    /* ---- Phase 4: Quiz ---- */
    html += '<div class="capstone-phase">';
    html += '<h3>Phase 4: Assessment</h3>';
    html += '<p style="margin-bottom:16px;">Answer the following 12 questions based on your analysis of the portfolio, stress scenario, and attribution.</p>';
    html += this._renderQuizHTML('capstone', cap.quiz);
    html += '</div>'; // close phase 4

    view.innerHTML = html;

    // Draw charts after DOM insertion (we return a setup function)
    view._drawCharts = function() {
      Renderer._drawCapstoneAllocChart(sectorMap);
      Renderer._drawCapstoneStressChart(totalRateLoss, totalSpreadLoss, totalDefaultLoss);
      Renderer._drawCapstoneAttrChart(attr);
    };

    return view;
  },

  _drawCapstoneAllocChart(sectorMap) {
    const container = document.getElementById('capstone-alloc-chart');
    if (!container) return;

    const colors = ['#2b402f', '#5a8c62', '#8ab590', '#c4453a', '#2b7a3a', '#d4863a', '#7a9e82'];
    const sectors = Object.keys(sectorMap);
    const slices = sectors.map((s, i) => ({
      label: s + ' ' + (sectorMap[s] * 100).toFixed(0) + '%',
      value: sectorMap[s],
      color: colors[i % colors.length]
    }));

    const ctx = Chart.create(400, 260, { top: 20, right: 20, bottom: 20, left: 20 });
    Chart.donutChart(ctx, slices, 200, 130, 90, 50);
    container.appendChild(ctx.svg);
  },

  _drawCapstoneStressChart(rateLoss, spreadLoss, defaultLoss) {
    const container = document.getElementById('capstone-stress-chart');
    if (!container) return;

    const maxAbs = Math.max(Math.abs(rateLoss), Math.abs(spreadLoss), Math.abs(defaultLoss)) * 100;
    const scale = maxAbs > 0 ? 1 / (maxAbs * 1.3) : 1;

    const bars = [
      { label: 'Rate', value: Math.abs(rateLoss * 100) * scale, color: '#c4453a' },
      { label: 'Spread', value: Math.abs(spreadLoss * 100) * scale, color: '#d4863a' },
      { label: 'Default', value: Math.abs(defaultLoss * 100) * scale, color: '#7a9e82' },
      { label: 'Total', value: Math.abs((rateLoss + spreadLoss + defaultLoss) * 100) * scale, color: '#2b402f' }
    ];

    const ctx = Chart.create(500, 220, { top: 30, right: 30, bottom: 40, left: 55 });
    Chart.drawAxes(ctx, null, [
      { pos: 0, label: '0%' },
      { pos: 0.5, label: (maxAbs * 1.3 * 0.5).toFixed(1) + '%' },
      { pos: 1.0, label: (maxAbs * 1.3).toFixed(1) + '%' }
    ], null, 'Loss (%)');
    Chart.barChart(ctx, bars);
    container.appendChild(ctx.svg);
  },

  _drawCapstoneAttrChart(attr) {
    const container = document.getElementById('capstone-attr-chart');
    if (!container) return;

    const maxVal = Math.max(Math.abs(attr.carry), Math.abs(attr.rollDown), Math.abs(attr.spreadPnL), Math.abs(attr.ratePnL), Math.abs(attr.defaultLoss), Math.abs(attr.totalReturn));
    const scale = maxVal > 0 ? 1 / (maxVal * 1.4) : 1;

    const items = [
      { label: 'Carry', value: attr.carry * scale, displayValue: '+' + attr.carry.toFixed(2) + '%', color: '#2b7a3a' },
      { label: 'Roll', value: attr.rollDown * scale, displayValue: '+' + attr.rollDown.toFixed(2) + '%', color: '#2b7a3a' },
      { label: 'Spread', value: attr.spreadPnL * scale, displayValue: attr.spreadPnL.toFixed(2) + '%' },
      { label: 'Rate', value: attr.ratePnL * scale, displayValue: attr.ratePnL.toFixed(2) + '%' },
      { label: 'Default', value: attr.defaultLoss * scale, displayValue: attr.defaultLoss.toFixed(2) + '%' },
      { label: 'Total', value: attr.totalReturn * scale, displayValue: attr.totalReturn.toFixed(2) + '%', color: '#2b402f' }
    ];

    const ctx = Chart.create(560, 250, { top: 40, right: 30, bottom: 40, left: 55 });
    // Draw zero line
    const zeroY = ctx.h - ctx.p.bottom;
    ctx.svg.appendChild(Chart.el('line', {
      x1: ctx.p.left, y1: zeroY, x2: ctx.w - ctx.p.right, y2: zeroY,
      stroke: '#c2b8ae', 'stroke-width': '1'
    }));
    Chart.waterfallChart(ctx, items);
    container.appendChild(ctx.svg);
  },

  /* ----- Tools panel ----- */
  renderTools() {
    const view = document.createElement('div');
    view.id = 'tools';
    view.className = 'section-view';

    let html = `<div class="section-header">
      <div class="section-number">Reference</div>
      <h1 class="section-title">All Tools &amp; Calculators</h1>
      <div class="section-topics">
        <span class="topic-tag">Quick Access</span>
        <span class="topic-tag">Interactive Tools</span>
      </div>
    </div>`;

    html += '<p style="margin-bottom:24px;color:var(--text-secondary);">Click any tool card below to jump directly to that section\'s calculator.</p>';

    html += '<div class="tools-grid">';
    TOOLS_LIST.forEach(tool => {
      html += `<div class="tool-card" onclick="navigate('${tool.id}');setTimeout(function(){switchTab('${tool.id}','calculator');},100);">
        <h4>${tool.name}</h4>
        <p>${tool.desc}</p>
      </div>`;
    });
    html += '</div>';

    view.innerHTML = html;
    return view;
  },

  /* ----- Progress bar update ----- */
  updateProgress() {
    const total = SECTIONS.length + 1; // sections + capstone
    const completed = State.getCompletedCount();
    const pct = Math.round((completed / total) * 100);

    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');
    if (fill) fill.style.width = pct + '%';
    if (text) text.textContent = completed + ' / ' + total + ' completed';

    // Update nav dots
    SECTIONS.forEach(sec => {
      const dot = document.getElementById('dot-' + sec.id);
      if (!dot) return;
      dot.className = 'nav-dot';
      const score = State.quizScores[sec.id];
      if (score) {
        if (score.correct >= Math.ceil(score.total * 0.6)) {
          dot.classList.add('passed');
        } else {
          dot.classList.add('failed');
        }
      } else if (State.quizAnswers[sec.id] && State.quizAnswers[sec.id].length > 0) {
        dot.classList.add('started');
      }
    });

    // Capstone dot
    const capDot = document.getElementById('dot-capstone');
    if (capDot) {
      capDot.className = 'nav-dot';
      if (State.capstoneScore !== null) {
        if (State.capstoneScore >= Math.ceil(CAPSTONE_DATA.quiz.length * 0.6)) {
          capDot.classList.add('passed');
        } else {
          capDot.classList.add('failed');
        }
      } else if (State.capstoneAnswers.length > 0) {
        capDot.classList.add('started');
      }
    }
  }
};

/* ------------------------------------------------------------
   5. QUIZ ENGINE
   ------------------------------------------------------------ */
function handleQuizAnswer(el, quizId, qi, oi) {
  // Prevent re-answering
  if (el.classList.contains('disabled')) return;

  const questions = (quizId === 'capstone') ? CAPSTONE_DATA.quiz : ((SECTIONS.find(s => s.id === quizId) || {}).quiz || []);
  if (qi >= questions.length) return;

  const qObj = questions[qi];
  const qContainer = document.getElementById(quizId + '-q' + qi);
  if (!qContainer) return;

  // Disable all options
  const allOpts = qContainer.querySelectorAll('.qq-option');
  allOpts.forEach(opt => {
    opt.classList.add('disabled');
    const optIdx = parseInt(opt.dataset.oi, 10);
    if (optIdx === qObj.correct) {
      opt.classList.add('correct', 'was-correct');
    }
  });

  // Highlight selected
  if (oi === qObj.correct) {
    el.classList.add('correct');
  } else {
    el.classList.add('incorrect');
  }

  // Show explanation
  const explEl = document.getElementById(quizId + '-q' + qi + '-expl');
  if (explEl) explEl.classList.add('show');

  // Add retry button
  const qqNum = qContainer.querySelector('.qq-num');
  if (qqNum && !qqNum.querySelector('.btn-danger')) {
    const retryBtn = document.createElement('button');
    retryBtn.className = 'btn btn-danger';
    retryBtn.style.cssText = 'font-size:0.65rem;padding:3px 8px;';
    retryBtn.textContent = 'Retry';
    retryBtn.onclick = function() { resetSingleQuestion(quizId, qi); };
    qqNum.appendChild(retryBtn);
  }

  // Add "Reset Quiz" button in header if not already present
  const quizHeader = qContainer.closest('.quiz-container').querySelector('.quiz-header');
  if (quizHeader && !quizHeader.querySelector('.btn-danger')) {
    const resetBtn = document.createElement('button');
    resetBtn.className = 'btn btn-danger';
    resetBtn.style.cssText = 'font-size:0.7rem;padding:5px 10px;';
    resetBtn.textContent = 'Reset Quiz';
    resetBtn.onclick = function() { resetSectionQuiz(quizId); };
    var wrapper = quizHeader.querySelector('div[style]');
    if (wrapper) wrapper.insertBefore(resetBtn, wrapper.firstChild);
  }

  // Update state
  if (quizId === 'capstone') {
    // Capstone quiz
    State.capstoneAnswers[qi] = oi;

    // Check if all answered
    if (State.capstoneAnswers.filter(a => a !== undefined && a !== null).length === questions.length) {
      let correct = 0;
      State.capstoneAnswers.forEach((ans, idx) => {
        if (ans === questions[idx].correct) correct++;
      });
      State.capstoneScore = correct;
    }
  } else {
    // Section quiz
    if (!State.quizAnswers[quizId]) State.quizAnswers[quizId] = [];
    State.quizAnswers[quizId][qi] = oi;

    // Check if all answered
    if (State.quizAnswers[quizId].filter(a => a !== undefined && a !== null).length === questions.length) {
      let correct = 0;
      State.quizAnswers[quizId].forEach((ans, idx) => {
        if (ans === questions[idx].correct) correct++;
      });
      State.quizScores[quizId] = { correct: correct, total: questions.length };
    }
  }

  // Update score display
  _updateScoreDisplay(quizId, questions);

  State.save();
  Renderer.updateProgress();
}

function _updateScoreDisplay(quizId, questions) {
  const scoreEl = document.getElementById('score-' + quizId);
  if (!scoreEl) return;

  let answered, correct;
  if (quizId === 'capstone') {
    answered = State.capstoneAnswers.filter(a => a !== undefined && a !== null);
    correct = 0;
    answered.forEach((ans, idx) => {
      if (questions[idx] && ans === questions[idx].correct) correct++;
    });
  } else {
    const arr = State.quizAnswers[quizId] || [];
    answered = arr.filter(a => a !== undefined && a !== null);
    correct = 0;
    answered.forEach((ans, idx) => {
      if (questions[idx] && ans === questions[idx].correct) correct++;
    });
  }

  scoreEl.innerHTML = `<span class="score-val">${correct}</span> / ${questions.length}`;
}

/* ------------------------------------------------------------
   6. CALCULATOR ENGINE
   ------------------------------------------------------------ */
function runCalc(sectionId) {
  const section = SECTIONS.find(s => s.id === sectionId);
  if (!section || !section.calcCompute || !section.calcFields) return;

  const calcId = sectionId + '-calc';
  const values = {};
  section.calcFields.forEach(f => {
    const el = document.getElementById(calcId + '-' + f.id);
    if (!el) return;
    if (f.type === 'select') {
      values[f.id] = el.value;
    } else if (f.type === 'range') {
      values[f.id] = parseFloat(el.value);
    } else {
      values[f.id] = el.value === '' ? 0 : parseFloat(el.value);
    }
  });

  let results;
  try {
    results = section.calcCompute(values);
  } catch(e) {
    results = [{ label: 'Error', value: e.message || 'Computation failed' }];
  }

  const grid = document.getElementById(sectionId + '-results-grid');
  if (!grid) return;
  grid.innerHTML = '';

  if (Array.isArray(results)) {
    results.forEach(r => {
      const item = document.createElement('div');
      item.className = 'result-item';
      item.innerHTML = `<div class="ri-label">${r.label}</div>` +
        `<div class="ri-value">${r.value}<span class="ri-unit">${r.unit || ''}</span></div>`;
      grid.appendChild(item);
    });
  }

  // Redraw chart if available
  const chartContainer = document.getElementById(sectionId + '-chart');
  if (chartContainer && section.drawChart) {
    chartContainer.innerHTML = '';
    try {
      section.drawChart(chartContainer);
    } catch(e) {
      chartContainer.innerHTML = '<p class="text-muted" style="padding:16px;">Chart unavailable.</p>';
    }
  }
}

function loadPreset(sectionId) {
  const section = SECTIONS.find(s => s.id === sectionId);
  if (!section || !section.calcPreset || !section.calcFields) return;

  const calcId = sectionId + '-calc';
  const presetVals = section.calcPreset.values || section.calcPreset;

  section.calcFields.forEach(f => {
    if (presetVals[f.id] === undefined) return;
    const el = document.getElementById(calcId + '-' + f.id);
    if (!el) return;
    el.value = presetVals[f.id];
    // Update range value display
    if (f.type === 'range') {
      const valEl = document.getElementById(calcId + '-' + f.id + '-val');
      if (valEl) valEl.textContent = presetVals[f.id];
    }
  });

  // Automatically compute after loading preset
  runCalc(sectionId);
}

/* ------------------------------------------------------------
   7. NAVIGATION
   ------------------------------------------------------------ */
function navigate(sectionId) {
  State.currentSection = sectionId;
  State.save();

  // Hide all section views, show the target
  document.querySelectorAll('.section-view').forEach(function(el) {
    el.classList.remove('active');
  });
  var target = document.getElementById(sectionId);
  if (target) target.classList.add('active');

  // Update nav active state
  document.querySelectorAll('.nav-item').forEach(function(el) {
    el.classList.remove('active');
  });
  var navItem = document.querySelector('.nav-item[data-section="' + sectionId + '"]');
  if (navItem) navItem.classList.add('active');

  // Close mobile sidebar
  var sidebar = document.getElementById('sidebar');
  if (sidebar) sidebar.classList.remove('open');

  // Scroll to top
  var main = document.getElementById('main');
  if (main) main.scrollTo(0, 0);
}

/* ------------------------------------------------------------
   8. RESET PROGRESS
   ------------------------------------------------------------ */
function resetProgress() {
  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = '<div class="modal-box">' +
    '<h3>Reset All Progress</h3>' +
    '<p>This will erase all quiz scores, answers, and progress. This cannot be undone.</p>' +
    '<div class="modal-actions">' +
    '<button class="btn btn-secondary" id="resetCancel">Cancel</button>' +
    '<button class="btn btn-danger-solid" id="resetConfirm">Reset</button>' +
    '</div></div>';
  document.body.appendChild(overlay);

  overlay.querySelector('#resetCancel').onclick = function() {
    document.body.removeChild(overlay);
  };
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) document.body.removeChild(overlay);
  });
  overlay.querySelector('#resetConfirm').onclick = function() {
    State.reset();
    document.body.removeChild(overlay);
    location.reload();
  };
}

function _reRenderQuiz(quizId) {
  if (quizId === 'capstone') {
    var container = document.querySelector('#capstone .quiz-container');
    if (container) {
      var wrapper = document.createElement('div');
      wrapper.innerHTML = Renderer._renderQuizHTML('capstone', CAPSTONE_DATA.quiz);
      container.replaceWith(wrapper.firstElementChild);
    }
  } else {
    var section = SECTIONS.find(function(s) { return s.id === quizId; });
    if (!section) return;
    var quizPanel = document.querySelector('#' + quizId + ' .tab-panel[data-tab="quiz"]');
    if (quizPanel) {
      quizPanel.innerHTML = Renderer._renderQuizHTML(quizId, section.quiz || []);
    }
  }
  Renderer.updateProgress();
}

function resetSectionQuiz(quizId) {
  if (quizId === 'capstone') {
    State.capstoneScore = null;
    State.capstoneAnswers = [];
  } else {
    delete State.quizScores[quizId];
    delete State.quizAnswers[quizId];
  }
  State.save();
  _reRenderQuiz(quizId);
}

function resetSingleQuestion(quizId, questionIndex) {
  if (quizId === 'capstone') {
    State.capstoneAnswers[questionIndex] = undefined;
    var quiz = CAPSTONE_DATA.quiz;
    var answered = 0, correct = 0;
    State.capstoneAnswers.forEach(function(a, i) {
      if (a !== undefined) {
        answered++;
        if (a === quiz[i].correct) correct++;
      }
    });
    State.capstoneScore = answered === 0 ? null : correct;
  } else {
    var answers = State.quizAnswers[quizId];
    if (answers) {
      answers[questionIndex] = undefined;
      var section = SECTIONS.find(function(s) { return s.id === quizId; });
      if (section && section.quiz) {
        var answered = 0, correct = 0;
        answers.forEach(function(a, i) {
          if (a !== undefined) {
            answered++;
            if (a === section.quiz[i].correct) correct++;
          }
        });
        if (answered === 0) {
          delete State.quizScores[quizId];
        } else {
          State.quizScores[quizId] = { correct: correct, total: section.quiz.length };
        }
      }
    }
  }
  State.save();
  _reRenderQuiz(quizId);
}

/* ------------------------------------------------------------
   9. TAB SWITCHING
   ------------------------------------------------------------ */
function switchTab(sectionId, tabName) {
  var section = document.getElementById(sectionId);
  if (!section) return;

  section.querySelectorAll('.tab-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.tab === tabName);
  });
  section.querySelectorAll('.tab-panel').forEach(function(p) {
    p.classList.toggle('active', p.dataset.tab === tabName);
  });
}

/* ------------------------------------------------------------
   9. INITIALIZATION
   ------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', function() {
  // 1. Load persisted state
  State.load();

  // 2. Render navigation sidebar
  Renderer.renderNav();

  // 3. Render each section and append to container
  var container = document.getElementById('sectionContainer');

  SECTIONS.forEach(function(section) {
    var sectionView = Renderer.renderSection(section);
    container.appendChild(sectionView);

    // Draw initial chart
    if (section.drawChart) {
      try {
        var chartContainer = document.getElementById(section.id + '-chart');
        if (chartContainer) {
          section.drawChart(chartContainer);
        }
      } catch(e) { console.warn('Chart init error for ' + section.id, e); }
    }
  });

  // 4. Render capstone and append
  var capstoneView = Renderer.renderCapstone();
  container.appendChild(capstoneView);
  // Draw capstone charts now that elements are in DOM
  if (capstoneView._drawCharts) {
    capstoneView._drawCharts();
  }

  // 5. Render tools panel and append
  var toolsView = Renderer.renderTools();
  container.appendChild(toolsView);

  // 6. Update progress bar
  Renderer.updateProgress();

  // 7. Navigate to saved or default section
  navigate(State.currentSection || 'section-1');
});

</script>
</body>
</html>
